# 署名済み注文請書の自動移動機能 - 実装完了

## 概要

署名済みの注文請書を自動的にBoxの「My Signed Documents」フォルダから各プロジェクトの「04_契約資料」フォルダにコピーする機能を実装しました。

## 実装内容

### 1. バックエンドAPI

**新規作成:**
- `/src/app/api/contracts/[id]/order-acceptance/sign/check/route.ts`

**機能:**
- Box Signの署名ステータスを確認
- 署名完了の場合、署名済みファイルIDを取得
- プロジェクトの「04_契約資料」フォルダを検索
- 署名済みファイルをプロジェクトフォルダにコピー
- データベースを更新（署名完了日時と署名済みファイルIDを記録）
- 受注者に通知を送信

### 2. フロントエンド

**変更ファイル:**
- `/src/app/contracts/[id]/page.tsx`

**変更内容:**
1. 状態変数を追加: `isCheckingSignature`
2. TypeScriptインターフェースに追加: `order_acceptance_signed_box_id`
3. ハンドラー関数を追加: `handleCheckSignature`
4. UIボタンを追加: 「署名完了を確認」ボタン

**ボタンの配置:**
- 「受注者署名待ち」セクション（黄色の背景）
- 「署名リクエストを再送信」ボタンの隣

**動作:**
- ボタンをクリックすると署名ステータスを確認
- 署名完了の場合、ファイルをコピーして成功メッセージを表示
- 署名未完了の場合、現在のステータスを表示
- 契約情報を再取得して最新の状態を反映

### 3. データベース変更

**新規マイグレーションファイル:**
- `/supabase/add-order-acceptance-signed-box-id.sql`

**追加カラム:**
- `contracts.order_acceptance_signed_box_id` (VARCHAR)
  - 署名済み注文請書のBoxファイルID（プロジェクトフォルダにコピーされたファイル）

## 次のステップ

### データベースマイグレーションの実行

以下のコマンドでマイグレーションを実行してください：

```bash
# Supabase CLIを使用する場合
cd /Users/sayuri/caddonworks
supabase db push supabase/add-order-acceptance-signed-box-id.sql

# または、Supabase Studioで直接実行
# 1. https://app.supabase.com でプロジェクトを開く
# 2. SQL Editorに移動
# 3. supabase/add-order-acceptance-signed-box-id.sql の内容を貼り付けて実行
```

## テスト方法

1. 発注者として契約詳細ページを開く
2. 注文請書署名リクエストを送信
3. 受注者としてメールから署名を完了
4. 発注者として契約詳細ページに戻る
5. 「署名完了を確認」ボタンをクリック
6. 成功メッセージが表示されることを確認
7. Boxでプロジェクトの「04_契約資料」フォルダを確認
8. 署名済み注文請書がコピーされていることを確認

## ファイル命名規則

署名済みファイルは以下の命名規則でコピーされます：

```
注文請書_署名済_{プロジェクト名}_{YYYY-MM-DD}.pdf
```

例: `注文請書_署名済_案件名_2025-10-13.pdf`

## エラーハンドリング

- 署名リクエストが存在しない場合: 404エラー
- 既に署名完了処理済みの場合: 既存の署名日時を返す
- 署名が未完了の場合: 現在のステータスを返す
- プロジェクトフォルダが見つからない場合: ルートフォルダにコピー
- ファイルコピー失敗時: 500エラーを返す

## 備考

- 署名完了確認は発注者（OrgAdmin）のみが実行可能
- 既に署名完了している場合は重複処理を防ぐ
- Box APIのアクセストークンは自動的に取得される
- コピー後も元の「My Signed Documents」フォルダのファイルは残る（削除されない）
