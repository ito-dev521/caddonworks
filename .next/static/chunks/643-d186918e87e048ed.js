"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[643],{13332:function(e,a,t){t.d(a,{W:function(){return R}});var s=t(57437),r=t(2265),i=t(61396),l=t.n(i),n=t(24033),c=t(65251),o=t(77480),d=t(25750),h=t(92457),x=t(29409),m=t(93167),g=t(32176),u=t(76637),f=t(68004),b=t(83523),p=t(67972),j=t(65883),v=t(82549),y=t(575),N=t(33277),w=t(66210),Z=t(14958),k=t(22169),_=t(62167),C=t(37006),z=t(62442),E=t(11981),S=t(3021);function A(){let{user:e}=(0,w.useAuth)(),a=(0,n.useRouter)(),[t,i]=(0,r.useState)([]),[l,o]=(0,r.useState)(0),[d,h]=(0,r.useState)(!1),[x,m]=(0,r.useState)(!1),g=async()=>{if(e)try{m(!0);let{data:{session:e}}=await Z.OQ.auth.getSession();if(!e)return;let a=await fetch("/api/notifications",{headers:{Authorization:"Bearer ".concat(e.access_token)}});if(a.ok){let e=await a.json();i(e.notifications||[]),o(e.unreadCount||0)}}catch(e){console.error("通知取得エラー:",e)}finally{m(!1)}},f=async a=>{if(e)try{let{data:{session:e}}=await Z.OQ.auth.getSession();if(!e)return;(await fetch("/api/notifications",{method:"PUT",headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"},body:JSON.stringify({notificationId:a,action:"mark_read"})})).ok&&(i(e=>e.map(e=>e.id===a?{...e,read_at:new Date().toISOString()}:e)),o(e=>Math.max(0,e-1)))}catch(e){console.error("通知既読エラー:",e)}},b=e=>{switch(e){case"bid_received":return(0,s.jsx)(C.Z,{className:"w-4 h-4 text-blue-600"});case"contract_created":return(0,s.jsx)(u.Z,{className:"w-4 h-4 text-green-600"});case"contract_signed":return(0,s.jsx)(z.Z,{className:"w-4 h-4 text-green-600"});default:return(0,s.jsx)(E.Z,{className:"w-4 h-4 text-gray-600"})}},p=e=>{let a=new Date(e),t=new Date().getTime()-a.getTime();return t<6e4?"たった今":t<36e5?"".concat(Math.floor(t/6e4),"分前"):t<864e5?"".concat(Math.floor(t/36e5),"時間前"):"".concat(Math.floor(t/864e5),"日前")};if((0,r.useEffect)(()=>{if(e){g();let e=setInterval(g,3e4);return()=>clearInterval(e)}},[e]),!e)return null;let j=e=>{if(e.read_at||f(e.id),"bid_received"===e.type){var t,s;(null===(t=e.data)||void 0===t?void 0:t.project_id)&&(null===(s=e.data)||void 0===s?void 0:s.bid_id)?a.push("/contracts/create?projectId=".concat(e.data.project_id,"&bidId=").concat(e.data.bid_id)):a.push("/projects")}else"contract_created"===e.type?a.push("/contracts"):"contract_signed"===e.type&&a.push("/contracts");h(!1)};return(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(y.z,{variant:"ghost",size:"icon",onClick:()=>{h(!d)},className:"relative","data-notification-bell":!0,children:[(0,s.jsx)(S.Z,{className:"w-5 h-5"}),l>0&&(0,s.jsx)(N.C,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs",children:l>99?"99+":l})]}),(0,s.jsx)(_.M,{children:d&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:()=>h(!1)}),(0,s.jsxs)(c.E.div,{initial:{opacity:0,y:-20,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.95},className:"fixed top-1/3 left-1/3 transform -translate-x-1/2 -translate-y-1/2 w-[28rem] max-w-[calc(100vw-2rem)] bg-white rounded-lg shadow-xl border border-gray-200 z-50",style:{maxHeight:"calc(100vh - 4rem)"},children:[(0,s.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"font-semibold text-gray-900",children:"通知"}),(0,s.jsx)(y.z,{variant:"ghost",size:"icon",onClick:()=>h(!1),className:"h-6 w-6",children:(0,s.jsx)(v.Z,{className:"w-4 h-4"})})]})}),(0,s.jsx)("div",{className:"overflow-y-auto",style:{maxHeight:"calc(100vh - 12rem)"},children:x?(0,s.jsx)("div",{className:"p-4 text-center text-gray-500",children:"読み込み中..."}):0===t.length?(0,s.jsx)("div",{className:"p-4 text-center text-gray-500",children:"通知はありません"}):t.map(e=>(0,s.jsx)("div",{className:"p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ".concat(e.read_at?"":"bg-blue-50"),onClick:()=>j(e),children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("div",{className:"flex-shrink-0 mt-1",children:b(e.type)}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-gray-900 flex-1 min-w-0",children:(0,s.jsx)("span",{className:"truncate block",children:e.title})}),!e.read_at&&(0,s.jsx)("div",{className:"w-2 h-2 bg-blue-600 rounded-full flex-shrink-0"})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1 break-words",children:e.message.length>100?"".concat(e.message.substring(0,100),"..."):e.message}),(0,s.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:p(e.created_at)})]})]})},e.id))}),t.length>0&&(0,s.jsx)("div",{className:"p-3 border-t border-gray-200",children:(0,s.jsx)(y.z,{variant:"ghost",size:"sm",className:"w-full text-sm",onClick:()=>{t.forEach(e=>{e.read_at||f(e.id)})},children:"全て既読にする"})})]})]})})]})}let O={Admin:[{icon:o.Z,label:"ダッシュボード",href:"/dashboard",badge:null},{icon:d.Z,label:"会員管理",href:"/admin/users",badge:null},{icon:h.Z,label:"統計・レポート",href:"/admin/reports",badge:null},{icon:x.Z,label:"システム設定",href:"/admin/settings",badge:null}],OrgAdmin:[{icon:o.Z,label:"ダッシュボード",href:"/dashboard",badge:null},{icon:m.Z,label:"案件管理",href:"/projects",badge:"3"},{icon:g.Z,label:"チャット",href:"/chat",badge:"2"},{icon:u.Z,label:"契約管理",href:"/contracts",badge:"2"},{icon:h.Z,label:"会計・請求",href:"/billing",badge:"新"},{icon:d.Z,label:"お気に入り会員",href:"/favorites",badge:null}],Contractor:[{icon:o.Z,label:"ダッシュボード",href:"/dashboard",badge:null},{icon:m.Z,label:"案件一覧",href:"/jobs",badge:"5"},{icon:g.Z,label:"チャット",href:"/chat",badge:"3"},{icon:u.Z,label:"提出物",href:"/deliverables",badge:"1"},{icon:h.Z,label:"報酬・支払",href:"/payouts",badge:null}],Reviewer:[{icon:o.Z,label:"ダッシュボード",href:"/dashboard",badge:null},{icon:m.Z,label:"審査案件",href:"/reviews",badge:"7"},{icon:g.Z,label:"チャット",href:"/chat",badge:"1"},{icon:u.Z,label:"評価履歴",href:"/evaluations",badge:null}],Auditor:[{icon:o.Z,label:"ダッシュボード",href:"/dashboard",badge:null},{icon:u.Z,label:"監査ログ",href:"/audit-logs",badge:null},{icon:g.Z,label:"チャット",href:"/chat",badge:null},{icon:h.Z,label:"レポート",href:"/reports",badge:null}]};function R(e){var a;let{userRole:t}=e,{user:i,userProfile:o,userRole:d,userOrganization:h,signOut:m}=(0,w.useAuth)(),g=(0,n.useRouter)(),u=(0,n.usePathname)(),[_,C]=(0,r.useState)(!0),[z,E]=(0,r.useState)(!1),[S,R]=(0,r.useState)(null),I=(0,r.useRef)(!1);(0,r.useEffect)(()=>{let e=sessionStorage.getItem("currentPage");sessionStorage.setItem("currentPage",u),e&&e!==u&&sessionStorage.setItem("previousPage",e)},[u]),(0,r.useEffect)(()=>{let e=async()=>{if("OrgAdmin"===d&&(null==h?void 0:h.id)&&null===S&&!I.current){I.current=!0,console.log("組織情報を取得中...",{orgId:h.id});try{let{data:{session:a}}=await Z.OQ.auth.getSession();if(!(null==a?void 0:a.access_token)){console.error("認証トークンが取得できません"),I.current=!1;return}let t=await fetch("/api/organization/profile",{headers:{Authorization:"Bearer ".concat(a.access_token)}});if(t.ok){let a=await t.json();if(a.organization){var e;console.log("組織情報取得成功:",a.organization),R((null===(e=a.organization)||void 0===e?void 0:e.contact_person)||null)}}else console.error("組織情報API失敗:",t.status),I.current=!1}catch(e){console.error("組織情報の取得に失敗しました:",e),I.current=!1}}};"OrgAdmin"===d&&(null==h?void 0:h.id)&&null===S&&!I.current&&e()},[d,null==h?void 0:h.id,S]);let P=O[d]||O.Admin,D=()=>{if("OrgAdmin"===d){let e=S||(null==o?void 0:o.display_name)||"ユーザー";return console.log("OrgAdmin表示名決定:",{userRole:d,organizationContactPerson:S,userProfileDisplayName:null==o?void 0:o.display_name,finalDisplayName:e,organizationContactPersonType:typeof S}),e}return(null==o?void 0:o.display_name)||"ユーザー"};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.E.nav,{initial:{x:-250},animate:{x:0},className:(0,k.cn)("hidden md:flex fixed left-0 top-0 h-full bg-white border-r border-gray-200 z-40 transition-all duration-300",_?"w-64":"w-16"),children:(0,s.jsxs)("div",{className:"flex flex-col w-full",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[(0,s.jsxs)(c.E.div,{className:"flex items-center gap-3",animate:{opacity:_?1:0},transition:{duration:.2},children:[(0,s.jsx)("div",{className:"w-8 h-8 bg-engineering-blue rounded-lg flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold text-sm",children:"土"})}),_&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"font-bold text-lg text-engineering-blue",children:"土木プラットフォーム"}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"Civil Engineering"})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[_&&(0,s.jsx)(A,{}),(0,s.jsx)(y.z,{variant:"ghost",size:"icon",onClick:()=>C(!_),className:"shrink-0",children:(0,s.jsx)(f.Z,{className:"w-4 h-4"})})]})]}),(0,s.jsx)("div",{className:"flex-1 px-2 py-4 space-y-2",children:P.map((e,a)=>(0,s.jsx)(c.E.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1*a},children:(0,s.jsx)(l(),{href:e.href,children:(0,s.jsxs)("div",{className:(0,k.cn)("flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-engineering-blue/10 transition-colors group relative","hover-lift"),children:[(0,s.jsx)(e.icon,{className:"w-5 h-5 text-gray-600 group-hover:text-engineering-blue"}),(0,s.jsx)(c.E.span,{className:"text-gray-700 group-hover:text-engineering-blue font-medium",animate:{opacity:_?1:0},transition:{duration:.2},children:_?e.label:""}),e.badge&&_&&(0,s.jsx)(N.C,{variant:"engineering",className:"ml-auto text-xs",children:e.badge}),!_&&(0,s.jsx)("div",{className:"absolute left-full ml-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50",children:e.label})]})})},e.href))}),(0,s.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsxs)(c.E.div,{className:"flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer",animate:{justifyContent:_?"flex-start":"center"},children:[(0,s.jsx)("div",{className:"w-8 h-8 bg-engineering-blue rounded-full flex items-center justify-center overflow-hidden",children:(null==o?void 0:o.avatar_url)?(0,s.jsx)("img",{src:o.avatar_url,alt:D(),className:"w-full h-full object-cover"}):(0,s.jsx)("span",{className:"text-white text-sm font-medium",children:D().charAt(0)||(null==i?void 0:null===(a=i.email)||void 0===a?void 0:a.charAt(0))||"U"})}),(0,s.jsx)(c.E.div,{animate:{opacity:_?1:0},transition:{duration:.2},className:"flex-1",children:_&&(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-sm",children:D()}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:d}),h&&(0,s.jsx)("p",{className:"text-xs text-gray-400 truncate",children:h.name})]})}),_&&(0,s.jsx)(b.Z,{className:"w-4 h-4 text-gray-400 group-hover:text-gray-600"})]}),_&&(0,s.jsxs)("div",{className:"absolute bottom-full left-0 right-0 mb-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50",children:[(0,s.jsx)(l(),{href:"/profile",children:(0,s.jsxs)("div",{className:"flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition-colors",children:[(0,s.jsx)(p.Z,{className:"w-4 h-4 text-gray-600"}),(0,s.jsx)("span",{className:"text-sm text-gray-700",children:"プロフィール"})]})}),(0,s.jsx)(l(),{href:"/settings",children:(0,s.jsxs)("div",{className:"flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition-colors",children:[(0,s.jsx)(x.Z,{className:"w-4 h-4 text-gray-600"}),(0,s.jsx)("span",{className:"text-sm text-gray-700",children:"設定"})]})}),(0,s.jsx)("hr",{className:"my-2"}),(0,s.jsxs)("button",{onClick:async()=>{await m(),g.push("/")},className:"w-full flex items-center gap-3 px-4 py-2 hover:bg-red-50 transition-colors text-red-600",children:[(0,s.jsx)(j.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm",children:"ログアウト"})]})]}),!_&&(0,s.jsx)("div",{className:"absolute left-full ml-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{children:D()}),(0,s.jsx)("div",{className:"text-gray-300",children:d}),h&&(0,s.jsx)("div",{className:"text-gray-400",children:h.name})]})})]})})]})}),(0,s.jsx)(y.z,{variant:"ghost",size:"icon",className:"md:hidden fixed top-4 left-4 z-50",onClick:()=>E(!0),children:(0,s.jsx)(f.Z,{className:"w-5 h-5"})}),z&&(0,s.jsx)(c.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"md:hidden fixed inset-0 bg-black/50 z-50",onClick:()=>E(!1),children:(0,s.jsxs)(c.E.div,{initial:{x:-300},animate:{x:0},exit:{x:-300},className:"w-64 h-full bg-white",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-8 h-8 bg-engineering-blue rounded-lg flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold text-sm",children:"土"})}),(0,s.jsx)("h1",{className:"font-bold text-lg text-engineering-blue",children:"土木プラットフォーム"})]}),(0,s.jsx)(y.z,{variant:"ghost",size:"icon",onClick:()=>E(!1),children:(0,s.jsx)(v.Z,{className:"w-4 h-4"})})]}),(0,s.jsx)("div",{className:"p-4 space-y-2",children:P.map(e=>(0,s.jsx)(l(),{href:e.href,onClick:()=>E(!1),children:(0,s.jsxs)("div",{className:"flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-engineering-blue/10 transition-colors",children:[(0,s.jsx)(e.icon,{className:"w-5 h-5 text-gray-600"}),(0,s.jsx)("span",{className:"text-gray-700 font-medium",children:e.label}),e.badge&&(0,s.jsx)(N.C,{variant:"engineering",className:"ml-auto text-xs",children:e.badge})]})},e.href))})]})})]})}},15671:function(e,a,t){t.d(a,{Ol:function(){return n},SZ:function(){return o},Zb:function(){return l},aY:function(){return d},ll:function(){return c}});var s=t(57437),r=t(2265),i=t(22169);let l=r.forwardRef((e,a)=>{let{className:t,variant:r="default",...l}=e;return(0,s.jsx)("div",{ref:a,className:(0,i.cn)("rounded-xl border bg-card text-card-foreground shadow-sm","glass"===r&&"glass backdrop-blur-md","gradient"===r&&"gradient-engineering text-white border-0","engineering"===r&&"border-engineering-blue/20 bg-gradient-to-br from-white to-engineering-blue/5 hover-lift",t),...l})});l.displayName="Card";let n=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",t),...r})});n.displayName="CardHeader";let c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("h3",{ref:a,className:(0,i.cn)("font-semibold leading-none tracking-tight",t),...r})});c.displayName="CardTitle";let o=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("p",{ref:a,className:(0,i.cn)("text-sm text-muted-foreground",t),...r})});o.displayName="CardDescription";let d=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,i.cn)("p-6 pt-0",t),...r})});d.displayName="CardContent",r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,i.cn)("flex items-center p-6 pt-0",t),...r})}).displayName="CardFooter"}}]);