(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{34450:function(e,o,r){Promise.resolve().then(r.t.bind(r,63385,23)),Promise.resolve().then(r.t.bind(r,99646,23)),Promise.resolve().then(r.bind(r,66210))},66210:function(e,o,r){"use strict";r.r(o),r.d(o,{AuthProvider:function(){return u},useAuth:function(){return s}});var l=r(57437),n=r(2265),t=r(14958);let i=(0,n.createContext)(void 0);function s(){let e=(0,n.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function u(e){let{children:o}=e,[r,s]=(0,n.useState)(null),[u,a]=(0,n.useState)(null),[c,d]=(0,n.useState)(null),[f,h]=(0,n.useState)(null),[g,v]=(0,n.useState)(!0),_=(0,n.useRef)(null);(0,n.useEffect)(()=>{(async()=>{try{var e,o,r;console.log("AuthProvider: 初期セッション取得開始");let{data:{session:l},error:n}=await t.OQ.auth.getSession();if(n){console.error("AuthProvider: セッション取得エラー:",n),v(!1);return}console.log("AuthProvider: セッション取得結果:",{hasSession:!!l,userId:null==l?void 0:null===(e=l.user)||void 0===e?void 0:e.id,hasAccessToken:!!(null==l?void 0:l.access_token),tokenLength:null==l?void 0:null===(o=l.access_token)||void 0===o?void 0:o.length}),s(null!==(r=null==l?void 0:l.user)&&void 0!==r?r:null),(null==l?void 0:l.user)&&(null==l?void 0:l.access_token)?(console.log("\uD83D\uDE80 AuthProvider: 初期セッション - ユーザープロフィール取得開始"),setTimeout(()=>{console.log("⏱️ setTimeout実行: fetchUserProfile呼び出し (初期セッション)"),p(l.user.id)},0)):console.log("AuthProvider: セッションまたはトークンなし、ローディング終了")}catch(e){console.error("AuthProvider: 初期化エラー:",e),s(null),a(null),d(null),h(null)}finally{v(!1)}})();let{data:{subscription:e}}=t.OQ.auth.onAuthStateChange(async(e,o)=>{var r,l;let n=new Date().toISOString();console.log("\uD83D\uDD04 [".concat(n,"] Auth state change:"),{event:e,userId:null==o?void 0:null===(r=o.user)||void 0===r?void 0:r.id,hasToken:!!(null==o?void 0:o.access_token)}),s(null!==(l=null==o?void 0:o.user)&&void 0!==l?l:null),(null==o?void 0:o.user)&&"SIGNED_IN"===e?(console.log("\uD83D\uDD11 [".concat(n,"] Auth state change: SIGNED_IN, fetching profile")),setTimeout(()=>{console.log("⏱️ [".concat(n,"] setTimeout実行: fetchUserProfile呼び出し (SIGNED_IN)")),p(o.user.id)},0)):"SIGNED_OUT"===e&&(console.log("Auth state change: SIGNED_OUT, clearing profile"),a(null),d(null),h(null)),"INITIAL_SESSION"!==e&&v(!1)});return()=>e.unsubscribe()},[]);let p=async e=>{var o;let r=new Date().toISOString(),l=null===(o=Error().stack)||void 0===o?void 0:o.split("\n").slice(1,4).join(" -> ");if(console.log("\uD83D\uDD0D [".concat(r,"] fetchUserProfile: 開始"),{authUserId:e,fetchingRef:_.current,callStack:l}),_.current===e){console.log("⚠️ [".concat(r,"] fetchUserProfile: 既に実行中のためスキップ"),{authUserId:e});return}_.current=e,console.log("\uD83C\uDFC3 [".concat(r,"] fetchUserProfile: 実行開始"),{authUserId:e});try{console.log("fetchUserProfile: ユーザープロフィール取得開始");let{data:o,error:r}=await t.OQ.from("users").select("*").eq("auth_user_id",e).single();if(console.log("fetchUserProfile: ユーザープロフィール結果",{profile:null==o?void 0:o.id,error:null==r?void 0:r.message}),r&&"PGRST116"!==r.code){console.error("Error fetching user profile:",r);return}if(a(o),o){console.log("fetchUserProfile: メンバーシップ取得開始",{profileId:o.id});let{data:e,error:r}=await t.OQ.from("memberships").select("role, org_id").eq("user_id",o.id).single();if(console.log("fetchUserProfile: メンバーシップ結果",{role:null==e?void 0:e.role,org_id:null==e?void 0:e.org_id,error:null==r?void 0:r.message}),r&&"PGRST116"!==r.code){console.error("Error fetching user role:",r);return}if(d((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:o,error:r}=await t.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();r?(console.error("Error fetching organization:",r),h(null)):h({id:o.id,name:o.name})}else h(null);console.log("fetchUserProfile: 完了",{role:null==e?void 0:e.role,organization:null==e?void 0:e.org_id})}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{_.current=null,console.log("✅ [".concat(r,"] fetchUserProfile: 実行完了"),{authUserId:e})}},I=async(e,o)=>{console.log("signIn: 開始",{email:e}),v(!0);try{var r;console.log("signIn: Supabase認証開始");let l=t.OQ.auth.signInWithPassword({email:e,password:o}),n=new Promise((e,o)=>{setTimeout(()=>o(Error("認証タイムアウト（30秒）")),3e4)}),{data:i,error:s}=await Promise.race([l,n]);if(console.log("signIn: Supabase認証結果",{data:null==i?void 0:null===(r=i.user)||void 0===r?void 0:r.id,error:null==s?void 0:s.message}),s)throw s;console.log("signIn: 認証成功"),(null==i?void 0:i.user)&&(console.log("signIn: ユーザープロフィール取得開始"),setTimeout(()=>{p(i.user.id)},50),console.log("signIn: ユーザープロフィール取得完了"))}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{console.log("signIn: 終了"),v(!1)}},m=async(e,o,r)=>{v(!0);try{let{data:l,error:n}=await t.OQ.auth.signUp({email:e,password:o,options:{data:{display_name:r.display_name,specialties:r.specialties||[],qualifications:r.qualifications||[]}}});if(n)throw n;if(l.user){let{error:e}=await t.OQ.from("users").insert({auth_user_id:l.user.id,email:l.user.email,display_name:r.display_name||"",specialties:r.specialties||[],qualifications:r.qualifications||[],experience_years:r.experience_years});e&&console.error("Error creating user profile:",e)}}finally{v(!1)}},y=async()=>{v(!0);try{let{error:e}=await t.OQ.auth.signOut();if(e)throw e;s(null),a(null),d(null)}finally{v(!1)}},P=async e=>{if(!u)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{console.log("updateProfile: 更新開始",{userId:u.id,updates:e});let{data:o,error:r}=await t.OQ.from("users").update(e).eq("id",u.id).select().single();if(r)throw console.error("updateProfile: Supabaseエラー",r),r;console.log("updateProfile: 更新成功",o),a({...u,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,l.jsx)(i.Provider,{value:{user:r,userProfile:u,userRole:c,userOrganization:f,loading:g,signIn:I,signUp:m,signOut:y,updateProfile:P,getRedirectPath:()=>{if(!c)return"/dashboard";switch(c){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:o})}},14958:function(e,o,r){"use strict";r.d(o,{OQ:function(){return n}});var l=r(37440);r(62601);let n=(0,l.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},63385:function(){},99646:function(e){e.exports={style:{fontFamily:"'__Inter_f367f3', '__Inter_Fallback_f367f3'",fontStyle:"normal"},className:"__className_f367f3"}},30622:function(e,o,r){"use strict";var l=r(2265),n=Symbol.for("react.element"),t=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function a(e,o,r){var l,t={},a=null,c=null;for(l in void 0!==r&&(a=""+r),void 0!==o.key&&(a=""+o.key),void 0!==o.ref&&(c=o.ref),o)i.call(o,l)&&!u.hasOwnProperty(l)&&(t[l]=o[l]);if(e&&e.defaultProps)for(l in o=e.defaultProps)void 0===t[l]&&(t[l]=o[l]);return{$$typeof:n,type:e,key:a,ref:c,props:t,_owner:s.current}}o.Fragment=t,o.jsx=a,o.jsxs=a},57437:function(e,o,r){"use strict";e.exports=r(30622)}},function(e){e.O(0,[440,971,938,744],function(){return e(e.s=34450)}),_N_E=e.O()}]);