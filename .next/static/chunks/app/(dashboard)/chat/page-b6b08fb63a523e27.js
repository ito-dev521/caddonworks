(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[640],{17341:function(e,t,s){Promise.resolve().then(s.bind(s,7403)),Promise.resolve().then(s.bind(s,80058))},7403:function(e,t,s){"use strict";s.r(t),s.d(t,{AuthGuard:function(){return o},useRoleAccess:function(){return d},withAuth:function(){return c}});var a=s(57437),r=s(2265),n=s(24033),i=s(65251),l=s(86264),u=s(66210);function o(e){let{children:t,requiredRole:s,allowedRoles:o,redirectTo:c="/auth/login"}=e,{user:d,userRole:m,loading:D}=(0,u.useAuth)(),x=(0,n.useRouter)(),h=(0,n.usePathname)(),g=(0,r.useRef)(!1);return((0,r.useEffect)(()=>{if(!D&&!g.current){if(!d){sessionStorage.setItem("redirectAfterLogin",h),h!==c&&(g.current=!0,x.push(c));return}if(s&&m!==s||o&&o.length>0&&(!m||!o.includes(m))){"/unauthorized"!==h&&(g.current=!0,x.push("/unauthorized"));return}}},[d,m,D,s,o,x,c,h]),D)?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)(i.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-engineering-blue rounded-xl flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(l.Z,{className:"w-8 h-8 text-white animate-spin"})}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"認証確認中..."}),(0,a.jsx)("p",{className:"text-gray-600",children:"しばらくお待ちください"})]})}):!d||s&&m!==s||o&&o.length>0&&(!m||!o.includes(m))?null:(0,a.jsx)(a.Fragment,{children:t})}function c(e,t){return function(s){return(0,a.jsx)(o,{requiredRole:t,children:(0,a.jsx)(e,{...s})})}}function d(){let{userRole:e}=(0,u.useAuth)(),t=t=>e===t,s=t=>!!e&&t.includes(e);return{hasRole:t,hasAnyRole:s,isAdmin:()=>t("OrgAdmin"),isStaff:()=>t("Staff"),isContractor:()=>t("Contractor"),isReviewer:()=>t("Reviewer"),isAuditor:()=>t("Auditor"),canManageProjects:()=>s(["OrgAdmin","Staff"]),canViewFinancials:()=>s(["OrgAdmin","Staff","Auditor"]),canReviewProjects:()=>s(["Reviewer","OrgAdmin"]),canViewAuditLogs:()=>s(["Auditor","OrgAdmin"])}}},80058:function(e,t,s){"use strict";s.r(t),s.d(t,{ChatLayout:function(){return $}});var a=s(57437),r=s(2265),n=s(65251),i=s(25750),l=s(29409),u=s(575),o=s(73067),c=s(41827),d=s(32176),m=s(33277),D=s(66210),x=s(14958),h=s(22169),g=s(24033);function f(e){let{selectedRoomId:t,onRoomSelect:s,className:l=""}=e,{user:f}=(0,D.useAuth)(),p=(0,g.useRouter)(),[y,b]=(0,r.useState)([]),[v,j]=(0,r.useState)(!0),[w,N]=(0,r.useState)(""),[E,C]=(0,r.useState)(null);(0,r.useEffect)(()=>{f&&(_(),F())},[f]),(0,r.useEffect)(()=>{C(sessionStorage.getItem("previousPage"))},[]);let _=async()=>{if(f)try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません"),j(!1);return}let t=await fetch("/api/chat/rooms",{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}}),s=await t.json();t.ok?b(s.rooms):(console.error("チャットルーム取得エラー:",s.message),b([]))}catch(e){console.error("チャットルーム取得エラー:",e),b([])}finally{j(!1)}},F=()=>{let e=x.OQ.channel("chat-rooms-changes").on("postgres_changes",{event:"*",schema:"public",table:"chat_rooms"},()=>_()).on("postgres_changes",{event:"*",schema:"public",table:"chat_messages"},()=>_()).subscribe();return()=>{x.OQ.removeChannel(e)}},S=y.filter(e=>{var t;return e.name.toLowerCase().includes(w.toLowerCase())||(null===(t=e.project_name)||void 0===t?void 0:t.toLowerCase().includes(w.toLowerCase()))}),A=e=>{let t=new Date(e),s=new Date,a=Math.floor((s.getTime()-t.getTime())/36e5);return a<1?Math.floor((s.getTime()-t.getTime())/6e4)+"分前":a<24?a+"時間前":t.toLocaleDateString("ja-JP",{month:"numeric",day:"numeric"})};return v?(0,a.jsx)("div",{className:(0,h.cn)("flex items-center justify-center h-64",l),children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:(0,h.cn)("flex flex-col h-full bg-white",l),children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,a.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)(u.z,{variant:"ghost",size:"sm",onClick:()=>{E&&"/chat"!==E?p.push(E):p.push("/projects")},className:"flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[(0,a.jsx)(o.Z,{className:"w-4 h-4"}),"戻る"]}),(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"チャット"})]})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(c.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsx)("input",{type:"text",placeholder:"チャットルームを検索...",value:w,onChange:e=>N(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engineering-blue focus:border-transparent"})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===S.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 text-gray-500",children:[(0,a.jsx)(d.Z,{className:"w-12 h-12 mb-4"}),(0,a.jsx)("p",{children:"チャットルームがありません"}),w&&(0,a.jsx)("p",{className:"text-sm",children:"検索条件に一致するルームが見つかりません"})]}):(0,a.jsx)("div",{className:"space-y-1 p-2",children:S.map(e=>(0,a.jsxs)(n.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:(0,h.cn)("p-3 rounded-lg cursor-pointer transition-colors hover:bg-gray-50",t===e.id&&"bg-engineering-blue/10 border border-engineering-blue/20"),onClick:()=>s(e.id),children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 truncate",children:e.name}),(e.unread_count||0)>0&&(0,a.jsx)(m.C,{variant:"destructive",className:"text-xs px-2 py-0.5",children:(e.unread_count||0)>99?"99+":e.unread_count})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 truncate",children:["プロジェクト: ",e.project_name]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs text-gray-400",children:[(0,a.jsx)(i.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{children:e.participant_count})]})]}),e.last_message&&(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 truncate",children:e.last_message.sender_name}),(0,a.jsx)("span",{className:"text-xs text-gray-400",children:A(e.last_message.created_at)})]}),(0,a.jsx)("p",{className:"text-xs text-gray-600 truncate",children:e.last_message.content})]}),!e.last_message&&(0,a.jsx)("p",{className:"text-xs text-gray-400",children:"メッセージがありません"})]},e.id))})})]})}var p=s(62167),y=s(35817),b=s(28734),v=s(74824),j=s(40734),w=s(45367),N=s(53714),E=s(6141),C=s(76020),_=s(86489);let F={よく使う:["\uD83D\uDE00","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE05","\uD83D\uDE02","\uD83E\uDD23","\uD83D\uDE0A","\uD83D\uDE07","\uD83D\uDE42","\uD83D\uDE43","\uD83D\uDE09","\uD83D\uDE0C","\uD83D\uDE0D","\uD83E\uDD70","\uD83D\uDE18","\uD83D\uDE17","\uD83D\uDE19","\uD83D\uDE1A","\uD83D\uDE0B","\uD83D\uDE1B","\uD83D\uDE1D","\uD83D\uDE1C","\uD83E\uDD2A","\uD83E\uDD28","\uD83E\uDDD0","\uD83E\uDD13","\uD83D\uDE0E","\uD83E\uDD29","\uD83E\uDD73"],感情:["\uD83D\uDE22","\uD83D\uDE2D","\uD83D\uDE24","\uD83D\uDE20","\uD83D\uDE21","\uD83E\uDD2C","\uD83E\uDD2F","\uD83D\uDE33","\uD83E\uDD75","\uD83E\uDD76","\uD83D\uDE31","\uD83D\uDE28","\uD83D\uDE30","\uD83D\uDE25","\uD83D\uDE13","\uD83E\uDD17","\uD83E\uDD14","\uD83E\uDD2D","\uD83E\uDD2B","\uD83E\uDD25","\uD83D\uDE36","\uD83D\uDE10","\uD83D\uDE11","\uD83D\uDE2C","\uD83D\uDE44","\uD83D\uDE2F","\uD83D\uDE26","\uD83D\uDE27","\uD83D\uDE2E","\uD83D\uDE32","\uD83E\uDD71","\uD83D\uDE34","\uD83E\uDD24","\uD83D\uDE2A","\uD83D\uDE35","\uD83E\uDD10","\uD83E\uDD74","\uD83E\uDD22","\uD83E\uDD2E","\uD83E\uDD27","\uD83D\uDE37","\uD83E\uDD12","\uD83E\uDD15"],ジェスチャー:["\uD83D\uDC4D","\uD83D\uDC4E","\uD83D\uDC4C","✌️","\uD83E\uDD1E","\uD83E\uDD1F","\uD83E\uDD18","\uD83E\uDD19","\uD83D\uDC48","\uD83D\uDC49","\uD83D\uDC46","\uD83D\uDD95","\uD83D\uDC47","☝️","\uD83D\uDC4B","\uD83E\uDD1A","\uD83D\uDD90️","✋","\uD83D\uDD96","\uD83D\uDC4F","\uD83D\uDE4C","\uD83D\uDC50","\uD83E\uDD32","\uD83E\uDD1D","\uD83D\uDE4F","✍️","\uD83D\uDC85","\uD83E\uDD33","\uD83D\uDCAA","\uD83E\uDDBE","\uD83E\uDDBF","\uD83E\uDDB5","\uD83E\uDDB6","\uD83D\uDC42","\uD83E\uDDBB","\uD83D\uDC43","\uD83E\uDDE0","\uD83E\uDDB7","\uD83E\uDDB4","\uD83D\uDC40","\uD83D\uDC41️","\uD83D\uDC45","\uD83D\uDC44"],食べ物:["\uD83C\uDF4E","\uD83C\uDF4A","\uD83C\uDF4B","\uD83C\uDF4C","\uD83C\uDF49","\uD83C\uDF47","\uD83C\uDF53","\uD83E\uDED0","\uD83C\uDF48","\uD83C\uDF52","\uD83C\uDF51","\uD83E\uDD6D","\uD83C\uDF4D","\uD83E\uDD65","\uD83E\uDD5D","\uD83C\uDF45","\uD83C\uDF46","\uD83E\uDD51","\uD83E\uDD66","\uD83E\uDD6C","\uD83E\uDD52","\uD83C\uDF36️","\uD83E\uDED1","\uD83C\uDF3D","\uD83E\uDD55","\uD83E\uDED2","\uD83E\uDDC4","\uD83E\uDDC5","\uD83E\uDD54","\uD83C\uDF60","\uD83E\uDD50","\uD83E\uDD56","\uD83C\uDF5E","\uD83E\uDD68","\uD83E\uDD6F","\uD83E\uDDC0","\uD83E\uDD5A","\uD83C\uDF73","\uD83E\uDDC8","\uD83E\uDD5E","\uD83E\uDDC7","\uD83E\uDD53","\uD83E\uDD69","\uD83C\uDF57","\uD83C\uDF56","\uD83E\uDDB4","\uD83C\uDF2D","\uD83C\uDF54","\uD83C\uDF5F","\uD83C\uDF55"],活動:["⚽","\uD83C\uDFC0","\uD83C\uDFC8","⚾","\uD83E\uDD4E","\uD83C\uDFBE","\uD83C\uDFD0","\uD83C\uDFC9","\uD83C\uDFB1","\uD83E\uDE80","\uD83C\uDFD3","\uD83C\uDFF8","\uD83C\uDFD2","\uD83C\uDFD1","\uD83E\uDD4D","\uD83C\uDFCF","\uD83E\uDE83","\uD83E\uDD45","⛳","\uD83E\uDE81","\uD83C\uDFF9","\uD83C\uDFA3","\uD83E\uDD3F","\uD83E\uDD4A","\uD83E\uDD4B","\uD83C\uDFBD","\uD83D\uDEF9","\uD83D\uDEF7","⛸️","\uD83E\uDD4C","\uD83C\uDFBF","⛷️","\uD83C\uDFC2","\uD83E\uDE82","\uD83C\uDFCB️‍♀️","\uD83C\uDFCB️","\uD83C\uDFCB️‍♂️","\uD83E\uDD3C‍♀️","\uD83E\uDD3C","\uD83E\uDD3C‍♂️","\uD83E\uDD38‍♀️","\uD83E\uDD38","\uD83E\uDD38‍♂️","⛹️‍♀️","⛹️","⛹️‍♂️","\uD83E\uDD3A","\uD83E\uDD3E‍♀️","\uD83E\uDD3E","\uD83E\uDD3E‍♂️","\uD83C\uDFCC️‍♀️","\uD83C\uDFCC️","\uD83C\uDFCC️‍♂️","\uD83C\uDFC7","\uD83E\uDDD8‍♀️","\uD83E\uDDD8","\uD83E\uDDD8‍♂️","\uD83C\uDFC4‍♀️","\uD83C\uDFC4","\uD83C\uDFC4‍♂️","\uD83C\uDFCA‍♀️","\uD83C\uDFCA","\uD83C\uDFCA‍♂️","\uD83E\uDD3D‍♀️","\uD83E\uDD3D","\uD83E\uDD3D‍♂️","\uD83D\uDEA3‍♀️","\uD83D\uDEA3","\uD83D\uDEA3‍♂️","\uD83E\uDDD7‍♀️","\uD83E\uDDD7","\uD83E\uDDD7‍♂️","\uD83D\uDEB5‍♀️","\uD83D\uDEB5","\uD83D\uDEB5‍♂️","\uD83D\uDEB4‍♀️","\uD83D\uDEB4","\uD83D\uDEB4‍♂️","\uD83C\uDFC6","\uD83E\uDD47","\uD83E\uDD48","\uD83E\uDD49","\uD83C\uDFC5","\uD83C\uDF96️","\uD83C\uDFF5️","\uD83C\uDF97️","\uD83C\uDFAB","\uD83C\uDF9F️","\uD83C\uDFAA","\uD83E\uDD39","\uD83E\uDD39‍♀️","\uD83E\uDD39‍♂️","\uD83C\uDFAD","\uD83E\uDE70","\uD83C\uDFA8","\uD83C\uDFAC","\uD83C\uDFA4","\uD83C\uDFA7","\uD83C\uDFBC","\uD83C\uDFB5","\uD83C\uDFB6","\uD83E\uDE98","\uD83E\uDD41","\uD83E\uDE97","\uD83C\uDFB8","\uD83E\uDE95","\uD83C\uDFBA","\uD83C\uDFB7","\uD83E\uDE97","\uD83C\uDFBB","\uD83E\uDE88","\uD83C\uDFB2","♠️","♥️","♦️","♣️","♟️","\uD83C\uDCCF","\uD83C\uDC04","\uD83C\uDFB4","\uD83C\uDFAF","\uD83C\uDFB3","\uD83C\uDFAE","\uD83D\uDD79️","\uD83C\uDFB0","\uD83C\uDFB2","\uD83E\uDDE9","\uD83C\uDCCF","\uD83C\uDFAF","\uD83C\uDFB3","\uD83C\uDFAE","\uD83D\uDD79️","\uD83C\uDFB0","\uD83C\uDFB2","\uD83E\uDDE9"]},S=e=>{let{onEmojiSelect:t,className:s}=e,[i,l]=(0,r.useState)(!1),[o,c]=(0,r.useState)("よく使う"),d=(e,s)=>{s&&(s.preventDefault(),s.stopPropagation()),t(e),l(!1)},m=e=>{i&&(e.stopPropagation(),"Escape"===e.key&&l(!1))};return(0,a.jsxs)("div",{className:"relative ".concat(s),onKeyDown:m,children:[(0,a.jsx)(u.z,{type:"button",variant:"outline",size:"icon",onClick:()=>l(!i),className:"hover:bg-gray-100",children:(0,a.jsx)(_.Z,{className:"w-4 h-4"})}),(0,a.jsx)(p.M,{children:i&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-40",onClick:()=>l(!1)}),(0,a.jsxs)(n.E.div,{initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},className:"absolute bottom-full right-0 mb-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50",onKeyDown:m,children:[(0,a.jsx)("div",{className:"flex border-b border-gray-200 p-2",children:Object.keys(F).map(e=>(0,a.jsx)("button",{onClick:()=>c(e),className:"px-3 py-1 text-xs rounded-md transition-colors ".concat(o===e?"bg-engineering-blue text-white":"text-gray-600 hover:bg-gray-100"),children:e},e))}),(0,a.jsx)("div",{className:"p-3 max-h-64 overflow-y-auto",children:(0,a.jsx)("div",{className:"grid grid-cols-8 gap-1",children:F[o].map((e,t)=>(0,a.jsx)("button",{onClick:t=>d(e,t),className:"w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-md transition-colors",type:"button",children:e},t))})})]})]})})]})};var A=s(71973);let k=e=>{let{onMentionSelect:t,className:s,projectId:l}=e,[o,c]=(0,r.useState)(!1),[d,m]=(0,r.useState)([]),[h,g]=(0,r.useState)([]),[f,y]=(0,r.useState)(""),[b,v]=(0,r.useState)(0),{user:j}=(0,D.useAuth)(),w=(0,r.useRef)(null);(0,r.useEffect)(()=>{(async()=>{if(l)try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!(null==e?void 0:e.access_token)){console.error("認証トークンが取得できません");return}let t=await fetch("/api/chat/participants?room_id=project_".concat(l),{headers:{Authorization:"Bearer ".concat(e.access_token)}});if(!t.ok){console.error("参加者取得エラー:",t.statusText);return}let s=await t.json();m(s.participants||[]),g(s.participants||[])}catch(e){console.error("チャット参加者取得エラー:",e)}})()},[l]),(0,r.useEffect)(()=>{f?g(d.filter(e=>e.display_name.toLowerCase().includes(f.toLowerCase())||e.email.toLowerCase().includes(f.toLowerCase()))):g(d),v(0)},[f,d]);let N=(e,s)=>{s&&(s.preventDefault(),s.stopPropagation()),t(e),c(!1),y("")},E=e=>{if(o)switch(e.stopPropagation(),e.key){case"ArrowDown":e.preventDefault(),v(e=>e<h.length-1?e+1:0);break;case"ArrowUp":e.preventDefault(),v(e=>e>0?e-1:h.length-1);break;case"Enter":e.preventDefault(),h[b]&&N(h[b]);break;case"Escape":c(!1)}};return(0,a.jsxs)("div",{className:"relative ".concat(s),onKeyDown:E,children:[(0,a.jsx)(u.z,{type:"button",variant:"outline",size:"icon",onClick:()=>c(!o),className:"hover:bg-gray-100",children:(0,a.jsx)(A.Z,{className:"w-4 h-4"})}),(0,a.jsx)(p.M,{children:o&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-40",onClick:()=>c(!1)}),(0,a.jsxs)(n.E.div,{initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},className:"absolute bottom-full right-0 mb-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50",onKeyDown:E,children:[(0,a.jsxs)("div",{className:"p-3 border-b border-gray-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsx)(i.Z,{className:"w-4 h-4 text-engineering-blue"}),(0,a.jsx)("span",{className:"font-medium text-sm",children:"メンバーを選択"})]}),(0,a.jsx)("input",{ref:w,type:"text",placeholder:"メンバー名を検索...",value:f,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-engineering-blue focus:border-transparent",autoFocus:!0})]}),(0,a.jsx)("div",{className:"max-h-64 overflow-y-auto",children:0===h.length?(0,a.jsx)("div",{className:"p-4 text-center text-gray-500 text-sm",children:"メンバーが見つかりません"}):h.map((e,t)=>(0,a.jsxs)("button",{onClick:t=>N(e,t),className:"w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 transition-colors ".concat(t===b?"bg-engineering-blue/10":""),type:"button",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-engineering-blue/20 flex items-center justify-center text-sm font-medium",children:e.avatar_url?(0,a.jsx)("img",{src:e.avatar_url,alt:e.display_name,className:"w-8 h-8 rounded-full object-cover"}):e.display_name.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("div",{className:"font-medium text-sm truncate",children:e.display_name}),(0,a.jsx)("div",{className:"text-xs text-gray-500 truncate",children:e.email})]}),(0,a.jsx)("div",{className:"text-xs text-gray-400",children:e.role})]},e.id))}),(0,a.jsx)("div",{className:"p-2 border-t border-gray-200 text-xs text-gray-500 text-center",children:"↑↓ で選択、Enter で確定、Esc でキャンセル"})]})]})})]})};var z=s(39868),Z=s(17810),B=s(35632),O=s(38150),I=s(8198);let P=[{type:"\uD83D\uDC4D",icon:z.Z,label:"いいね",category:"basic"},{type:"❤️",icon:Z.Z,label:"ハート",category:"basic"},{type:"\uD83D\uDE4F",icon:_.Z,label:"ありがとう",category:"basic"},{type:"\uD83D\uDE02",icon:B.Z,label:"笑い",category:"basic"},{type:"\uD83D\uDE22",icon:O.Z,label:"悲しい",category:"basic"},{type:"\uD83D\uDE21",icon:I.Z,label:"怒り",category:"basic"},{type:"\uD83D\uDE0A",icon:_.Z,label:"笑顔",category:"basic"},{type:"\uD83D\uDE2E",icon:_.Z,label:"驚き",category:"emotion"},{type:"\uD83D\uDE0D",icon:Z.Z,label:"憧れ",category:"emotion"},{type:"\uD83E\uDD14",icon:_.Z,label:"考え中",category:"emotion"},{type:"\uD83D\uDE34",icon:_.Z,label:"眠い",category:"emotion"},{type:"\uD83D\uDE0E",icon:_.Z,label:"クール",category:"emotion"},{type:"\uD83E\uDD7A",icon:_.Z,label:"お願い",category:"emotion"},{type:"\uD83E\uDD2F",icon:_.Z,label:"びっくり",category:"emotion"},{type:"\uD83D\uDE2D",icon:O.Z,label:"大泣き",category:"emotion"},{type:"\uD83E\uDD29",icon:_.Z,label:"興奮",category:"emotion"},{type:"\uD83D\uDE24",icon:I.Z,label:"むかつく",category:"emotion"},{type:"\uD83D\uDC4F",icon:z.Z,label:"拍手",category:"action"},{type:"\uD83D\uDE4C",icon:z.Z,label:"やったー",category:"action"},{type:"\uD83D\uDCAA",icon:z.Z,label:"頑張る",category:"action"},{type:"\uD83D\uDD25",icon:Z.Z,label:"熱い",category:"action"},{type:"✨",icon:_.Z,label:"キラキラ",category:"action"},{type:"\uD83C\uDF89",icon:_.Z,label:"お祝い",category:"action"},{type:"\uD83D\uDCAF",icon:z.Z,label:"完璧",category:"action"},{type:"\uD83D\uDE80",icon:_.Z,label:"ロケット",category:"action"},{type:"\uD83D\uDE47‍♂️",icon:_.Z,label:"お辞儀",category:"action"},{type:"\uD83D\uDE47‍♀️",icon:_.Z,label:"お辞儀",category:"action"},{type:"☕",icon:_.Z,label:"コーヒー",category:"food"},{type:"\uD83C\uDF55",icon:_.Z,label:"ピザ",category:"food"},{type:"\uD83C\uDF70",icon:_.Z,label:"ケーキ",category:"food"},{type:"\uD83C\uDF7A",icon:_.Z,label:"ビール",category:"food"},{type:"\uD83C\uDF4E",icon:_.Z,label:"りんご",category:"food"},{type:"\uD83D\uDCA1",icon:_.Z,label:"アイデア",category:"other"},{type:"⭐",icon:_.Z,label:"星",category:"other"},{type:"\uD83C\uDF38",icon:_.Z,label:"桜",category:"other"},{type:"\uD83C\uDFAF",icon:_.Z,label:"的",category:"other"},{type:"\uD83D\uDC8E",icon:_.Z,label:"ダイヤ",category:"other"}];function T(e){let{messageId:t,className:s}=e,{user:i,loading:l}=(0,D.useAuth)(),[o,c]=(0,r.useState)({}),[d,m]=(0,r.useState)(!1);(0,r.useEffect)(()=>{},[d]);let[g,f]=(0,r.useState)(!1),p=async()=>{try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e)return;let s=await fetch("/api/chat/reactions?message_id=".concat(t),{headers:{Authorization:"Bearer ".concat(e.access_token)}});if(s.ok){let e=await s.json();c(e.reactions||{})}else{let e=await s.json();console.error("リアクション取得エラー:",e)}}catch(e){console.error("リアクション取得エラー:",e)}};(0,r.useEffect)(()=>{!l&&i&&p()},[t,i,l]);let y=async e=>{if(i){f(!0);try{var s;let{data:{session:a}}=await x.OQ.auth.getSession();if(!a)return;let r=null===(s=o[e])||void 0===s?void 0:s.find(e=>e.user_id===i.id),n=await fetch("/api/chat/reactions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a.access_token)},body:JSON.stringify({message_id:t,reaction_type:e,action:r?"remove":"add"})});if(n.ok)await n.json(),await p();else{let e=await n.json();console.error("リアクション操作エラー:",e)}}catch(e){console.error("リアクション操作エラー:",e)}finally{f(!1),m(!1)}}},b=Object.values(o).reduce((e,t)=>e+t.length,0);return 0!==b||d?(0,a.jsxs)("div",{className:(0,h.cn)("flex items-center gap-1 flex-wrap relative",s),children:[Object.entries(o).map(e=>{let[t,s]=e,r=s.some(e=>e.user_id===(null==i?void 0:i.id)),l=P.find(e=>e.type===t);return(0,a.jsx)(n.E.div,{initial:{scale:0},animate:{scale:1},whileHover:{scale:1.05},whileTap:{scale:.95},children:(0,a.jsxs)(u.z,{variant:"ghost",size:"sm",onClick:()=>y(t),disabled:g,className:(0,h.cn)("h-7 px-2 text-xs font-medium transition-all duration-200 rounded-full",r?"bg-blue-100 text-blue-700 border border-blue-200 shadow-sm":"text-gray-600 hover:text-gray-800 hover:bg-gray-100 border border-transparent"),title:(null==l?void 0:l.label)||t,children:[(0,a.jsx)("span",{className:"mr-1 text-sm",children:t}),(0,a.jsx)("span",{className:"text-xs",children:s.length})]})},t)}),b>0&&(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("div",{className:"h-7 px-2 flex items-center text-xs text-gray-500 cursor-pointer hover:text-gray-700",children:"詳細"}),(0,a.jsxs)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 min-w-64 max-w-80",children:[(0,a.jsxs)("div",{className:"px-4 py-3 border-b border-gray-100",children:[(0,a.jsx)("h3",{className:"text-sm font-semibold text-gray-900",children:"リアクション詳細"}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["合計 ",b," 件のリアクション"]})]}),(0,a.jsx)("div",{className:"max-h-64 overflow-y-auto",children:Object.entries(o).map(e=>{let[t,s]=e;return(0,a.jsxs)("div",{className:"border-b border-gray-50 last:border-b-0",children:[(0,a.jsxs)("div",{className:"px-4 py-2 bg-gray-50 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-lg",children:t}),(0,a.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:[s.length,"人"]})]}),(0,a.jsx)("div",{className:"py-1",children:s.map(e=>{var t;return(0,a.jsxs)("div",{className:"px-4 py-2 hover:bg-gray-50 flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-medium",style:{background:"linear-gradient(135deg, \n                              hsl(".concat(137.5*e.user_id.charCodeAt(0)%360,", 70%, 60%), \n                              hsl(").concat(137.5*e.user_id.charCodeAt(1)%360,", 70%, 50%)\n                            )")},children:(null===(t=e.display_name)||void 0===t?void 0:t.charAt(0))||"?"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("span",{className:"text-sm text-gray-900",children:e.display_name}),e.user_id===(null==i?void 0:i.id)&&(0,a.jsx)("span",{className:"text-xs text-blue-600 ml-2",children:"(あなた)"})]})]},e.id)})})]},t)})}),(0,a.jsx)("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"}),(0,a.jsx)("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 -mt-px w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-200"})]})]}),d&&(0,a.jsxs)("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",border:"1px solid #e5e7eb",padding:"20px",zIndex:1e4,borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)",width:"320px",maxHeight:"400px",overflowY:"auto"},children:[(0,a.jsx)("div",{className:"text-center mb-4",children:(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"リアクションを選択"})}),["basic","emotion","action"].map(e=>{let t=P.filter(t=>t.category===e);return 0===t.length?null:(0,a.jsxs)("div",{className:"mb-4 last:mb-0",children:[(0,a.jsxs)("div",{className:"text-xs font-medium text-gray-500 mb-2 px-1",children:["basic"===e&&"基本","emotion"===e&&"感情","action"===e&&"アクション","food"===e&&"食べ物・飲み物","other"===e&&"その他"]}),(0,a.jsx)("div",{className:"grid grid-cols-8 gap-1",children:t.map(e=>{let{type:t,label:s}=e;return(0,a.jsx)("button",{onClick:()=>{y(t)},disabled:g,className:"h-8 w-8 p-0 hover:bg-gray-100 rounded-md border border-transparent hover:border-gray-200 transition-colors",title:s,style:{display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px"},children:t},t)})})]},e)}),(0,a.jsx)("div",{className:"mt-4 pt-3 border-t border-gray-100 text-center",children:(0,a.jsx)("button",{onClick:()=>m(!1),className:"px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors",children:"閉じる"})})]}),(0,a.jsx)(u.z,{variant:"ghost",size:"sm",onClick:()=>{m(!d)},className:"h-6 px-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100",children:(0,a.jsx)(_.Z,{className:"h-3 w-3"})})]}):(0,a.jsx)("div",{className:(0,h.cn)("flex items-center gap-1",s),children:(0,a.jsx)(u.z,{variant:"ghost",size:"sm",onClick:()=>{m(!0)},className:"h-6 px-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100",children:(0,a.jsx)(_.Z,{className:"h-3 w-3"})})})}var Q=s(67972),R=s(99670),M=s(82549);function L(e){var t,s,r;let{isOpen:i,onClose:l,replyMessage:o,className:c}=e;return o?(0,a.jsx)(p.M,{children:i&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-50",onClick:l}),(0,a.jsxs)(n.E.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:(0,h.cn)("fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2","bg-white rounded-lg shadow-xl border border-gray-200","w-full max-w-2xl max-h-[80vh] overflow-hidden z-50",c),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(d.Z,{className:"h-5 w-5 text-blue-600"}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"返信元メッセージ"})]}),(0,a.jsx)(u.z,{variant:"ghost",size:"sm",onClick:l,className:"h-8 w-8 p-0 hover:bg-gray-100",children:(0,a.jsx)(M.Z,{className:"h-4 w-4"})})]}),(0,a.jsxs)("div",{className:"p-4 overflow-y-auto max-h-[calc(80vh-80px)]",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center text-sm font-medium text-blue-700 border-2 border-white shadow-md",children:(null===(t=o.sender)||void 0===t?void 0:t.avatar_url)?(0,a.jsx)("img",{src:o.sender.avatar_url,alt:o.sender.display_name||"Unknown",className:"w-full h-full object-cover rounded-full"}):((null===(s=o.sender)||void 0===s?void 0:s.display_name)||"U").charAt(0).toUpperCase()}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-semibold text-gray-900",children:(null===(r=o.sender)||void 0===r?void 0:r.display_name)||"Unknown User"}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[(0,a.jsx)(E.Z,{className:"h-3 w-3"}),(e=>{let t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?t.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("ja-JP",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})})(o.created_at)]})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:["text"===o.message_type&&(0,a.jsx)("div",{className:"p-4 bg-white border border-gray-200 rounded-lg",children:(0,a.jsx)("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:o.content||"メッセージ内容が取得できませんでした"})}),("file"===o.message_type||"image"===o.message_type||"video"===o.message_type)&&(0,a.jsxs)("div",{className:"p-4 bg-white border border-gray-200 rounded-lg",children:[o.content&&o.content!==o.file_name&&(0,a.jsx)("div",{className:"mb-3 text-sm leading-relaxed whitespace-pre-wrap",children:o.content}),(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center",children:"image"===o.message_type?(0,a.jsx)("img",{src:o.file_url,alt:o.file_name,className:"w-full h-full object-cover rounded-lg"}):"video"===o.message_type?(0,a.jsx)("div",{className:"w-6 h-6 bg-blue-600 rounded flex items-center justify-center",children:(0,a.jsx)("div",{className:"w-0 h-0 border-l-[6px] border-l-white border-y-[4px] border-y-transparent ml-1"})}):(0,a.jsx)("div",{className:"w-6 h-6 bg-gray-600 rounded flex items-center justify-center",children:(0,a.jsx)("div",{className:"w-3 h-3 bg-white rounded-sm"})})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-900 truncate",children:o.file_name}),o.file_url&&(0,a.jsx)("a",{href:o.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:text-blue-800",children:"ファイルを開く"})]})]})]})]})]}),(0,a.jsx)("div",{className:"flex justify-end gap-2 p-4 border-t border-gray-200",children:(0,a.jsx)(u.z,{variant:"outline",onClick:l,className:"px-4",children:"閉じる"})})]})]})}):null}function U(e){let{replyTo:t,onCancel:s,className:n}=e,[i,l]=(0,r.useState)(!1),[c,d]=(0,r.useState)(null),[m,D]=(0,r.useState)(!1);if(!t)return null;let x=async()=>{d({id:t.id,content:t.content,sender:t.sender,created_at:new Date().toISOString(),message_type:"text"}),l(!0)};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:(0,h.cn)("flex items-center gap-2 p-3 bg-gray-50 border-l-4 border-blue-500 rounded-r-lg",n),children:[(0,a.jsxs)("div",{className:"flex items-center gap-1 text-blue-600",children:[(0,a.jsx)(o.Z,{className:"h-3 w-3"}),(0,a.jsx)("span",{className:"text-xs font-medium",children:"RE"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500",children:"返信元"}),(0,a.jsx)("div",{className:"flex-shrink-0",children:t.sender.avatar_url?(0,a.jsx)("img",{src:t.sender.avatar_url,alt:t.sender.display_name,className:"h-4 w-4 rounded-full object-cover"}):(0,a.jsx)("div",{className:"h-4 w-4 rounded-full bg-gray-300 flex items-center justify-center",children:(0,a.jsx)(Q.Z,{className:"h-2 w-2 text-gray-600"})})}),(0,a.jsxs)("span",{className:"text-xs font-medium text-gray-700 truncate",children:[t.sender.display_name,"さん"]}),(0,a.jsx)("span",{className:"text-xs text-gray-600 truncate flex-1 font-medium",children:t.content.length>60?"".concat(t.content.substring(0,60),"..."):t.content})]}),(0,a.jsxs)(u.z,{variant:"ghost",size:"sm",onClick:x,className:"h-6 px-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 border border-blue-200 rounded-md",title:"返信元を見る",children:[(0,a.jsx)(R.Z,{className:"h-3 w-3 mr-1"}),(0,a.jsx)("span",{className:"text-xs",children:"見る"})]}),s&&(0,a.jsx)(u.z,{variant:"ghost",size:"sm",onClick:s,className:"h-6 px-2 text-gray-500 hover:text-gray-700",children:"\xd7"})]}),(0,a.jsx)(L,{isOpen:i,onClose:()=>l(!1),replyMessage:c})]})}var J=s(98253);function q(e){let{mentions:t,className:s}=e;return t&&0!==t.length?(0,a.jsxs)("div",{className:(0,h.cn)("flex flex-wrap items-center gap-2 mb-2",s),children:[(0,a.jsx)("span",{className:"text-xs font-medium text-gray-600",children:"TO"}),t.map((e,t)=>(0,a.jsxs)(m.C,{variant:"outline",className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 border-blue-200 text-xs",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:e.avatar_url?(0,a.jsx)("img",{src:e.avatar_url,alt:e.display_name,className:"h-3 w-3 rounded-full object-cover"}):(0,a.jsx)("div",{className:"h-3 w-3 rounded-full bg-blue-200 flex items-center justify-center",children:"OrgAdmin"===e.role?(0,a.jsx)(J.Z,{className:"h-2 w-2 text-blue-600"}):(0,a.jsx)(Q.Z,{className:"h-2 w-2 text-blue-600"})})}),(0,a.jsxs)("span",{className:"truncate max-w-20",children:[e.display_name,"さん"]})]},e.user_id))]}):null}function G(e){var t,s,i,l,o,c;let{roomId:d,className:g=""}=e,{user:f}=(0,D.useAuth)(),[_,F]=(0,r.useState)([]),[A,z]=(0,r.useState)(""),[Z,B]=(0,r.useState)(!0),[O,I]=(0,r.useState)(!1),[P,Q]=(0,r.useState)(null),[R,M]=(0,r.useState)(null),[L,J]=(0,r.useState)(null),[G,V]=(0,r.useState)(""),[K,W]=(0,r.useState)(!1),[X,Y]=(0,r.useState)(null),H=(0,r.useRef)(null),$=(0,r.useRef)(null),ee=(0,r.useRef)(null);(0,r.useEffect)(()=>{d&&(et(),ea(),es())},[d]),(0,r.useEffect)(()=>{er()},[_]);let et=async()=>{if(d)try{let{data:{session:t}}=await x.OQ.auth.getSession();if(!t){console.error("セッションが見つかりません"),B(!1);return}let s=await fetch("/api/chat/messages?room_id=".concat(d),{method:"GET",headers:{Authorization:"Bearer ".concat(t.access_token)}}),a=await s.json();if(s.ok){var e;let t=(null===(e=a.messages)||void 0===e?void 0:e.map(e=>({id:e.id,room_id:e.room_id||d,content:e.content||e.message,sender_id:e.sender_id,sender:{id:e.sender_id,display_name:e.sender_name||"Unknown",email:e.sender_email,avatar_url:e.sender_avatar_url},created_at:e.created_at,is_deleted:e.is_deleted||!1,message_type:e.message_type||"text",file_url:e.file_url,file_name:e.file_name,file_size:e.file_size,reply_to:e.reply_to,reply_message:e.reply_message,edited_at:e.edited_at})))||[];F(t)}else console.error("メッセージ取得エラー:",a.message),F([])}catch(e){console.error("Error fetching messages:",e),F([])}finally{B(!1)}},es=()=>{let e=x.OQ.channel("chat-messages-".concat(d)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"room_id=eq.".concat(d)},()=>et()).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_messages",filter:"room_id=eq.".concat(d)},()=>et()).subscribe();return()=>{x.OQ.removeChannel(e)}},ea=async()=>{if(d&&f)try{await x.OQ.rpc("mark_messages_as_read",{p_room_id:d})}catch(e){console.error("Error marking messages as read:",e)}},er=()=>{var e;null===(e=H.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},en=async e=>{if(e.preventDefault(),A.trim()&&f&&!O){I(!0);try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let t={room_id:d,content:A.trim(),message_type:"text",reply_to:(null==P?void 0:P.id)||null},s=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.access_token)},body:JSON.stringify(t)}),a=await s.json();s.ok?(z(""),Q(null),J(null),et()):console.error("メッセージ送信エラー:",a.message)}catch(e){console.error("Error sending message:",e)}finally{I(!1)}}},ei=e=>{Y(e),V(""),W(!0)},el=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(f&&e)try{I(!0);let{data:{session:s}}=await x.OQ.auth.getSession();if(!s){console.error("セッションが見つかりません");return}let a=new FormData;a.append("file",e),a.append("roomId",d),a.append("comment",t),(null==P?void 0:P.id)&&a.append("reply_to",P.id);let r=await fetch("/api/chat/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(s.access_token)},body:a}),n=await r.json();r.ok?(et(),W(!1),Y(null),V(""),Q(null)):(console.error("ファイルアップロードエラー:",n.message),alert("ファイルのアップロードに失敗しました: "+n.message))}catch(e){console.error("Error uploading file:",e),alert("ファイルのアップロードに失敗しました: "+(e instanceof Error?e.message:"不明なエラー"))}finally{I(!1)}},eu=async(e,t)=>{try{let{error:s}=await x.OQ.from("chat_messages").update({content:t,edited_at:new Date().toISOString()}).eq("id",e).eq("sender_id",null==f?void 0:f.id);if(s)throw s;M(null)}catch(e){console.error("Error editing message:",e)}},eo=async e=>{try{let{error:t}=await x.OQ.from("chat_messages").update({is_deleted:!0}).eq("id",e).eq("sender_id",null==f?void 0:f.id);if(t)throw t}catch(e){console.error("Error deleting message:",e)}},ec=e=>{var t,s,a;Q(e),J({id:e.id,content:e.content,sender:{display_name:(null===(t=e.sender)||void 0===t?void 0:t.display_name)||"Unknown",avatar_url:null===(s=e.sender)||void 0===s?void 0:s.avatar_url}}),null===(a=ee.current)||void 0===a||a.focus()},ed=e=>{let t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?t.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("ja-JP",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})},em=e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},eD=e=>e.replace(/\n/g,"<br>").split(/@([^\s]+)/g).map((e,t)=>t%2==1?(0,a.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium border border-blue-200",children:[(0,a.jsx)("span",{className:"w-3 h-3 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs",children:"@"}),e]},t):(0,a.jsx)("span",{dangerouslySetInnerHTML:{__html:e}},t));return Z?(0,a.jsx)("div",{className:(0,h.cn)("flex items-center justify-center h-64",g),children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:(0,h.cn)("flex flex-col h-full bg-white",g),children:[(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",children:[(0,a.jsx)(p.M,{children:_.map(e=>{var t,s,r,i,l,o,c,d;let m=e.sender_id===(null==f?void 0:f.id),D=!m;return(0,a.jsxs)(n.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},className:(0,h.cn)("flex gap-3 group mb-4",m?"justify-end":"justify-start",e.reply_message&&"ml-4 border-l-2 border-gray-200 pl-4"),children:[D&&(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 overflow-hidden border-2 border-white shadow-md",children:(null===(t=e.sender)||void 0===t?void 0:t.avatar_url)?(0,a.jsx)("img",{src:e.sender.avatar_url,alt:(null===(s=e.sender)||void 0===s?void 0:s.display_name)||"User",className:"w-full h-full object-cover"}):(0,a.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center",children:(null===(i=e.sender)||void 0===i?void 0:null===(r=i.display_name)||void 0===r?void 0:r.charAt(0))||(null===(o=e.sender)||void 0===o?void 0:null===(l=o.email)||void 0===l?void 0:l.charAt(0))||"U"})}),(0,a.jsxs)("div",{className:(0,h.cn)("flex flex-col max-w-sm sm:max-w-lg md:max-w-xl",m&&"items-end"),children:[(0,a.jsxs)("div",{className:(0,h.cn)("flex items-center gap-2 mb-2 text-xs",m?"flex-row-reverse text-gray-600":"flex-row text-gray-500"),children:[(0,a.jsx)("span",{className:"font-semibold text-gray-800",children:m?"あなた":(null===(c=e.sender)||void 0===c?void 0:c.display_name)||(null===(d=e.sender)||void 0===d?void 0:d.email)||"不明"}),(0,a.jsx)("span",{className:"text-gray-500",children:ed(e.created_at)}),e.edited_at&&(0,a.jsx)("span",{className:"text-xs text-gray-400",children:"(編集済み)"})]}),e.reply_to&&(0,a.jsx)(U,{replyTo:e.reply_message?{id:e.reply_message.id,content:e.reply_message.content,sender:{display_name:e.reply_message.sender_name||"Unknown",avatar_url:void 0}}:{id:e.reply_to,content:"返信先メッセージ（詳細を取得中...）",sender:{display_name:"Unknown",avatar_url:void 0}},className:"mb-2"}),(0,a.jsx)(q,{mentions:e.mentions}),(0,a.jsxs)("div",{className:(0,h.cn)("relative px-4 py-3 rounded-2xl max-w-full break-words shadow-sm border",m?"bg-gradient-to-r from-blue-500 to-blue-600 text-white border-blue-300 shadow-md":"bg-white text-gray-900 border-gray-200 shadow-md"),children:[R===e.id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{type:"text",defaultValue:e.content,className:"flex-1 bg-transparent border-none outline-none",onKeyDown:t=>{"Enter"===t.key?eu(e.id,t.currentTarget.value):"Escape"===t.key&&M(null)},autoFocus:!0}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",onClick:()=>M(null),className:"text-current hover:bg-white/20",children:"キャンセル"})]}):(0,a.jsxs)(a.Fragment,{children:["text"===e.message_type&&(0,a.jsx)("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:eD(e.content)}),("file"===e.message_type||"image"===e.message_type||"video"===e.message_type)&&(0,a.jsxs)("div",{className:"space-y-2",children:[e.content!==e.file_name&&(0,a.jsx)("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:eD(e.content)}),"image"===e.message_type?(0,a.jsxs)("div",{children:[(0,a.jsx)("img",{src:e.file_url,alt:e.file_name,className:"max-w-xs rounded-lg"}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsx)("p",{className:"text-xs opacity-75",children:e.file_name}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"text-current hover:bg-white/20 h-6 px-2",onClick:()=>window.open(e.file_url,"_blank"),children:(0,a.jsx)(y.Z,{className:"w-3 h-3"})})]})]}):"video"===e.message_type?(0,a.jsxs)("div",{children:[(0,a.jsx)("video",{src:e.file_url,controls:!0,className:"max-w-xs rounded-lg",preload:"metadata",children:"お使いのブラウザは動画の再生をサポートしていません。"}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsx)("p",{className:"text-xs opacity-75",children:e.file_name}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"text-current hover:bg-white/20 h-6 px-2",onClick:()=>window.open(e.file_url,"_blank"),children:(0,a.jsx)(y.Z,{className:"w-3 h-3"})})]})]}):(0,a.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-white/10 rounded-lg",children:[(0,a.jsx)(b.Z,{className:"w-4 h-4"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:e.file_name}),e.file_size&&(0,a.jsx)("p",{className:"text-xs opacity-75",children:em(e.file_size)})]}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"text-current hover:bg-white/20",onClick:()=>window.open(e.file_url,"_blank"),children:(0,a.jsx)(y.Z,{className:"w-3 h-3"})})]})]})]}),(0,a.jsx)("div",{className:"absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white text-gray-600 hover:text-green-600",onClick:()=>ec(e),children:(0,a.jsx)(v.Z,{className:"w-3 h-3"})}),m&&R!==e.id&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white text-gray-600 hover:text-engineering-blue",onClick:()=>M(e.id),children:(0,a.jsx)(j.Z,{className:"w-3 h-3"})}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white text-gray-600 hover:text-red-600",onClick:()=>eo(e.id),children:(0,a.jsx)(w.Z,{className:"w-3 h-3"})})]})]})})]}),(0,a.jsx)("div",{className:"mt-2 flex justify-start",children:(0,a.jsx)(T,{messageId:e.id})})]})]},e.id)})}),(0,a.jsx)("div",{ref:H})]}),(0,a.jsx)(U,{replyTo:L||void 0,onCancel:()=>{J(null),Q(null)},className:"px-4 py-2 bg-gray-50 border-t"}),(0,a.jsxs)("div",{className:"p-4 border-t border-gray-200",children:[P&&(0,a.jsxs)("div",{className:"mb-3 p-3 bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500 rounded-r-lg shadow-sm relative",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsx)(m.C,{className:"bg-green-500 text-white text-xs px-2 py-1 font-medium",children:"RE"}),(0,a.jsx)(v.Z,{className:"w-3 h-3 text-green-600"}),(0,a.jsx)("span",{className:"text-xs text-green-700 font-semibold",children:"返信先"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-5 h-5 rounded-full bg-white border border-green-200 flex items-center justify-center text-xs font-medium text-green-700",children:(null===(s=P.sender)||void 0===s?void 0:null===(t=s.display_name)||void 0===t?void 0:t.charAt(0))||(null===(l=P.sender)||void 0===l?void 0:null===(i=l.email)||void 0===i?void 0:i.charAt(0))||"U"}),(0,a.jsx)("span",{className:"text-sm text-gray-800 font-medium",children:(null===(o=P.sender)||void 0===o?void 0:o.display_name)||(null===(c=P.sender)||void 0===c?void 0:c.email)||"不明"})]}),(0,a.jsx)("div",{className:"mt-1 text-sm text-gray-600 bg-white/50 p-2 rounded border-l-2 border-green-300",children:P.content}),(0,a.jsx)(u.z,{size:"sm",variant:"ghost",className:"absolute top-2 right-2 h-6 w-6 p-0 text-gray-500 hover:text-red-600",onClick:()=>Q(null),children:"\xd7"})]}),(0,a.jsxs)("div",{className:"flex items-end gap-2",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)("textarea",{ref:ee,value:A,onChange:e=>z(e.target.value),placeholder:"メッセージを入力... (Shift + Enterキーで改行)",className:"w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-engineering-blue focus:border-transparent min-h-[60px]",rows:3,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()}})}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(S,{onEmojiSelect:e=>{z(t=>t+e),setTimeout(()=>{if(ee.current){ee.current.focus();let e=ee.current.value.length;ee.current.setSelectionRange(e,e)}},100)}}),(0,a.jsx)(k,{onMentionSelect:e=>{z(t=>t+"@".concat(e.display_name," ")),setTimeout(()=>{if(ee.current){ee.current.focus();let e=ee.current.value.length;ee.current.setSelectionRange(e,e)}},100)},projectId:null==d?void 0:d.replace("project_","")}),(0,a.jsx)("input",{type:"file",ref:$,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt",onChange:e=>{var t;let s=null===(t=e.target.files)||void 0===t?void 0:t[0];s&&ei(s)},className:"hidden"}),(0,a.jsx)(u.z,{type:"button",variant:"outline",size:"icon",onClick:()=>{var e;return null===(e=$.current)||void 0===e?void 0:e.click()},disabled:O,title:"ファイルを添付",children:(0,a.jsx)(N.Z,{className:"w-4 h-4"})}),(0,a.jsx)(u.z,{type:"button",onClick:e=>{e.preventDefault(),A.trim()&&!O&&en(e)},disabled:!A.trim()||O,className:"px-4",children:O?(0,a.jsx)(E.Z,{className:"w-4 h-4 animate-spin"}):(0,a.jsx)(C.Z,{className:"w-4 h-4"})})]})]})]}),K&&X&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"ファイルをアップロード"}),(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-engineering-blue rounded-lg flex items-center justify-center",children:(0,a.jsx)(b.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900",children:X.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:em(X.size)})]})]})}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"コメント（任意）"}),(0,a.jsx)("textarea",{value:G,onChange:e=>V(e.target.value),placeholder:"ファイルについてのコメントを入力してください...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engineering-blue focus:border-transparent resize-none",rows:3})]}),(0,a.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,a.jsx)(u.z,{variant:"outline",onClick:()=>{W(!1),Y(null),V("")},disabled:O,children:"キャンセル"}),(0,a.jsx)(u.z,{variant:"engineering",onClick:()=>el(X,G),disabled:O,children:O?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"アップロード中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(C.Z,{className:"w-4 h-4 mr-2"}),"アップロード"]})})]})]})})]})}var V=s(49168),K=s(49036),W=s(74527),X=s(62442),Y=s(11981);function H(e){let{roomId:t,projectId:s,isVisible:l,onClose:o,className:c=""}=e,{user:d}=(0,D.useAuth)(),[g,f]=(0,r.useState)([]),[y,b]=(0,r.useState)(!0),[v,j]=(0,r.useState)(""),[w,N]=(0,r.useState)(!1),[E,C]=(0,r.useState)([]),[_,F]=(0,r.useState)(!1),[S,A]=(0,r.useState)(!1);(0,r.useEffect)(()=>{l&&t&&(k(),z())},[l,t]);let k=async()=>{try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let s=await fetch("/api/chat/participants?room_id=".concat(t),{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}}),a=await s.json();s.ok?f(a.participants):(console.error("参加者取得エラー:",a.message),f([]))}catch(e){console.error("参加者取得エラー:",e),f([])}finally{b(!1)}},z=async()=>{try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e)return;let t=await fetch("/api/projects/".concat(s),{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}});if(t.ok){let e=(await t.json()).project,{data:s}=await x.OQ.from("users").select("id").eq("auth_user_id",null==d?void 0:d.id).single(),{data:a}=await x.OQ.from("memberships").select("org_id, role").eq("user_id",null==s?void 0:s.id).single();A((null==a?void 0:a.org_id)===e.org_id)}}catch(e){console.error("権限確認エラー:",e),A(!1)}},Z=async()=>{if(v.trim()){N(!0),C([]);try{let{data:{session:e}}=await x.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let s=v.split(/[,\n]/).map(e=>e.trim()).filter(e=>e),a=await fetch("/api/chat/participants/invite",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.access_token)},body:JSON.stringify({room_id:t,user_emails:s})}),r=await a.json();a.ok?(C(r.results),j(""),k()):(console.error("招待エラー:",r.message),C([{email:"全体",success:!1,error:r.message}]))}catch(e){console.error("招待エラー:",e),C([{email:"全体",success:!1,error:"招待処理中にエラーが発生しました"}])}finally{N(!1)}}},B=(e,t)=>"contractor"===e?(0,a.jsx)(Q.Z,{className:"w-4 h-4 text-blue-600"}):"OrgAdmin"===t?(0,a.jsx)(V.Z,{className:"w-4 h-4 text-yellow-600"}):"Staff"===t?(0,a.jsx)(K.Z,{className:"w-4 h-4 text-green-600"}):(0,a.jsx)(Q.Z,{className:"w-4 h-4 text-gray-600"}),O=(e,t)=>"contractor"===e?"受注者":"OrgAdmin"===t?"組織管理者":"Staff"===t?"スタッフ":"メンバー";return l?(0,a.jsxs)(n.E.div,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},className:(0,h.cn)("fixed top-0 right-0 h-full w-80 bg-white border-l border-gray-200 shadow-lg z-50 flex flex-col",c),children:[(0,a.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(i.Z,{className:"w-5 h-5 text-engineering-blue"}),(0,a.jsx)("h3",{className:"font-semibold text-gray-900",children:"参加者"}),(0,a.jsx)(m.C,{variant:"secondary",children:g.length})]}),(0,a.jsx)(u.z,{variant:"ghost",size:"sm",onClick:o,className:"h-8 w-8 p-0",children:(0,a.jsx)(M.Z,{className:"w-4 h-4"})})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:y?(0,a.jsx)("div",{className:"flex items-center justify-center h-32",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:"space-y-4",children:[S&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"招待"}),(0,a.jsxs)(u.z,{variant:"outline",size:"sm",onClick:()=>F(!_),className:"flex items-center gap-2",children:[(0,a.jsx)(W.Z,{className:"w-4 h-4"}),"招待"]})]}),(0,a.jsx)(p.M,{children:_&&(0,a.jsxs)(n.E.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"メールアドレス（複数の場合は改行またはカンマで区切り）"}),(0,a.jsx)("textarea",{value:v,onChange:e=>j(e.target.value),placeholder:"user@example.com",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-engineering-blue focus:border-transparent",rows:3})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(u.z,{onClick:Z,disabled:!v.trim()||w,size:"sm",className:"flex-1",children:w?"招待中...":"招待する"}),(0,a.jsx)(u.z,{variant:"outline",size:"sm",onClick:()=>{F(!1),j(""),C([])},children:"キャンセル"})]})]})}),E.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h5",{className:"text-xs font-medium text-gray-600",children:"招待結果"}),E.map((e,t)=>(0,a.jsxs)("div",{className:(0,h.cn)("p-2 rounded-lg text-xs",e.success?"bg-green-50 text-green-800":"bg-red-50 text-red-800"),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[e.success?(0,a.jsx)(X.Z,{className:"w-3 h-3"}):(0,a.jsx)(Y.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{className:"font-medium",children:e.email})]}),(0,a.jsx)("p",{className:"mt-1",children:e.message||e.error})]},t))]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"現在の参加者"}),(0,a.jsx)("div",{className:"space-y-2",children:g.map(e=>{var t;return(0,a.jsxs)(n.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-engineering-blue flex items-center justify-center text-white text-sm font-medium flex-shrink-0",children:(null===(t=e.display_name)||void 0===t?void 0:t.charAt(0))||e.email.charAt(0)}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.display_name||"名前未設定"}),B(e.role,e.org_role)]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.email}),(0,a.jsx)(m.C,{variant:"secondary",className:"mt-1 text-xs",children:O(e.role,e.org_role)})]})]},e.id)})})]})]})})]}):null}function $(e){let{className:t=""}=e,[s,o]=(0,r.useState)(null),[c,d]=(0,r.useState)(!1),[m,D]=(0,r.useState)(!1);return r.useEffect(()=>{let e=()=>{D(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,r.useEffect)(()=>{let e="/chat",t=sessionStorage.getItem("currentPage");sessionStorage.setItem("currentPage",e),t&&t!==e&&sessionStorage.setItem("previousPage",t)},[]),(0,a.jsxs)("div",{className:(0,h.cn)("flex h-full bg-gray-50",t),children:[(0,a.jsx)(n.E.div,{initial:!1,animate:{width:m?s?0:"100%":320,opacity:m&&s?0:1},className:(0,h.cn)("border-r border-gray-200 bg-white overflow-hidden",m&&s&&"hidden"),children:(0,a.jsx)(f,{selectedRoomId:s||void 0,onRoomSelect:e=>{o(e)},className:"h-full"})}),(0,a.jsx)("div",{className:"flex-1 flex flex-col overflow-hidden",children:s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-white",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[m&&(0,a.jsx)(u.z,{variant:"ghost",size:"icon",onClick:()=>o(null),children:"←"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"font-semibold text-gray-900",children:"チャットルーム"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"プロジェクト関連のディスカッション"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(u.z,{variant:"ghost",size:"icon",onClick:()=>d(!c),className:(0,h.cn)("transition-colors",c&&"bg-engineering-blue/10 text-engineering-blue"),children:(0,a.jsx)(i.Z,{className:"w-4 h-4"})}),(0,a.jsx)(u.z,{variant:"ghost",size:"icon",children:(0,a.jsx)(l.Z,{className:"w-4 h-4"})})]})]}),(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1 flex flex-col",children:(0,a.jsx)(G,{roomId:s,className:"flex-1"})}),c&&(0,a.jsx)(H,{roomId:s,projectId:s.replace("project_",""),isVisible:c,onClose:()=>d(!1)})]})]}):(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center bg-white",children:(0,a.jsxs)("div",{className:"text-center max-w-md",children:[(0,a.jsx)("div",{className:"w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(i.Z,{className:"w-8 h-8 text-gray-400"})}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"チャットルームを選択してください"}),(0,a.jsx)("p",{className:"text-gray-500 mb-6",children:"左のリストからチャットルームを選択して、 プロジェクト関係者とのコミュニケーションを開始してください。"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-gray-400",children:[(0,a.jsx)("p",{children:"\uD83D\uDCAC リアルタイムメッセージング"}),(0,a.jsx)("p",{children:"\uD83D\uDCC1 ファイル共有"}),(0,a.jsx)("p",{children:"\uD83D\uDC65 プロジェクト関係者との連携"})]})]})})})]})}},33277:function(e,t,s){"use strict";s.d(t,{C:function(){return l}});var a=s(57437);s(2265);var r=s(96061),n=s(22169);let i=(0,r.j)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground",success:"border-transparent bg-green-500 text-white shadow hover:bg-green-600",warning:"border-transparent bg-yellow-500 text-white shadow hover:bg-yellow-600",info:"border-transparent bg-blue-500 text-white shadow hover:bg-blue-600",engineering:"border-engineering-blue bg-engineering-blue/10 text-engineering-blue",glass:"glass text-gray-700 border-white/30"}},defaultVariants:{variant:"default"}});function l(e){let{className:t,variant:s,...r}=e;return(0,a.jsx)("div",{className:(0,n.cn)(i({variant:s}),t),...r})}},575:function(e,t,s){"use strict";s.d(t,{z:function(){return o}});var a=s(57437),r=s(2265),n=s(54949),i=s(96061),l=s(22169);let u=(0,i.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline",engineering:"bg-engineering-blue text-white shadow-lg hover:bg-engineering-blue-dark hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300",gradient:"gradient-engineering text-white shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300",glass:"glass text-gray-900 hover:bg-white/20 border-white/30"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",xl:"h-12 rounded-lg px-10 text-base",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=r.forwardRef((e,t)=>{let{className:s,variant:r,size:i,asChild:o=!1,...c}=e,d=o?n.g7:"button";return(0,a.jsx)(d,{className:(0,l.cn)(u({variant:r,size:i,className:s})),ref:t,...c})});o.displayName="Button"},66210:function(e,t,s){"use strict";s.r(t),s.d(t,{AuthProvider:function(){return u},useAuth:function(){return l}});var a=s(57437),r=s(2265),n=s(14958);let i=(0,r.createContext)(void 0);function l(){let e=(0,r.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function u(e){let{children:t}=e,[s,l]=(0,r.useState)(null),[u,o]=(0,r.useState)(null),[c,d]=(0,r.useState)(null),[m,D]=(0,r.useState)(null),[x,h]=(0,r.useState)(!0),g=(0,r.useRef)(null);(0,r.useEffect)(()=>{(async()=>{try{var e;let{data:{session:t},error:s}=await n.OQ.auth.getSession();if(s){console.error("AuthProvider: セッション取得エラー:",s),h(!1);return}l(null!==(e=null==t?void 0:t.user)&&void 0!==e?e:null),(null==t?void 0:t.user)&&(null==t?void 0:t.access_token)?setTimeout(()=>{f(t.user.id)},0):h(!1)}catch(e){console.error("AuthProvider: 初期化エラー:",e),l(null),o(null),d(null),D(null),h(!1)}})();let{data:{subscription:e}}=n.OQ.auth.onAuthStateChange(async(e,t)=>{var s;l(null!==(s=null==t?void 0:t.user)&&void 0!==s?s:null),(null==t?void 0:t.user)&&"SIGNED_IN"===e?setTimeout(()=>{f(t.user.id)},0):"SIGNED_OUT"===e&&(o(null),d(null),D(null)),"INITIAL_SESSION"!==e&&h(!1)});return()=>e.unsubscribe()},[]);let f=async e=>{if(g.current!==e){g.current=e;try{let{data:t,error:s}=await n.OQ.from("users").select("*").eq("auth_user_id",e).single();if(s&&"PGRST116"!==s.code){console.error("Error fetching user profile:",s);return}if(o(t),t){let{data:e,error:s}=await n.OQ.from("memberships").select("role, org_id").eq("user_id",t.id).single();if(s&&"PGRST116"!==s.code){console.error("Error fetching user role:",s);return}if(d((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:t,error:s}=await n.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();s?(console.error("Error fetching organization:",s),D(null)):D({id:t.id,name:t.name})}else D(null)}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{g.current=null,h(!1)}}},p=async(e,t)=>{h(!0);try{let s=n.OQ.auth.signInWithPassword({email:e,password:t}),a=new Promise((e,t)=>{setTimeout(()=>t(Error("認証タイムアウト（30秒）")),3e4)}),{data:r,error:i}=await Promise.race([s,a]);if(i)throw i;(null==r?void 0:r.user)&&setTimeout(()=>{f(r.user.id)},50)}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{h(!1)}},y=async(e,t,s)=>{h(!0);try{let{data:a,error:r}=await n.OQ.auth.signUp({email:e,password:t,options:{data:{display_name:s.display_name,specialties:s.specialties||[],qualifications:s.qualifications||[]}}});if(r)throw r;if(a.user){let{error:e}=await n.OQ.from("users").insert({auth_user_id:a.user.id,email:a.user.email,display_name:s.display_name||"",specialties:s.specialties||[],qualifications:s.qualifications||[],experience_years:s.experience_years});e&&console.error("Error creating user profile:",e)}}finally{h(!1)}},b=async()=>{h(!0);try{let{error:e}=await n.OQ.auth.signOut();if(e)throw e;l(null),o(null),d(null)}finally{h(!1)}},v=async e=>{if(!u)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{let{data:t,error:s}=await n.OQ.from("users").update(e).eq("id",u.id).select().single();if(s)throw console.error("updateProfile: Supabaseエラー",s),s;o({...u,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,a.jsx)(i.Provider,{value:{user:s,userProfile:u,userRole:c,userOrganization:m,loading:x,signIn:p,signUp:y,signOut:b,updateProfile:v,getRedirectPath:()=>{if(!c)return"/dashboard";switch(c){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:t})}},14958:function(e,t,s){"use strict";s.d(t,{OQ:function(){return r}});var a=s(37440);s(62601);let r=(0,a.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},22169:function(e,t,s){"use strict";s.d(t,{XO:function(){return u},cn:function(){return n},xG:function(){return i},z2:function(){return l}});var a=s(57042),r=s(74769);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,r.m6)((0,a.W)(t))}function i(e){return new Intl.NumberFormat("ja-JP",{style:"currency",currency:"JPY"}).format(e)}function l(e){return({draft:"bg-gray-100 text-gray-800",bidding:"bg-blue-100 text-blue-800",contracted:"bg-green-100 text-green-800",in_progress:"bg-yellow-100 text-yellow-800",submitted:"bg-purple-100 text-purple-800",completed:"bg-emerald-100 text-emerald-800",cancelled:"bg-red-100 text-red-800"})[e]||"bg-gray-100 text-gray-800"}function u(e){return({draft:"\uD83D\uDCDD",bidding:"\uD83C\uDFD7️",contracted:"✅",in_progress:"⚡",submitted:"\uD83D\uDCCB",completed:"\uD83C\uDF89",cancelled:"❌"})[e]||"\uD83D\uDCC4"}}},function(e){e.O(0,[778,402,440,829,971,938,744],function(){return e(e.s=17341)}),_N_E=e.O()}]);