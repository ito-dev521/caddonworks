(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[640],{17341:function(e,s,t){Promise.resolve().then(t.bind(t,7403)),Promise.resolve().then(t.bind(t,3779))},7403:function(e,s,t){"use strict";t.r(s),t.d(s,{AuthGuard:function(){return o},useRoleAccess:function(){return m},withAuth:function(){return d}});var a=t(57437),r=t(2265),i=t(24033),n=t(65251),l=t(86264),c=t(66210);function o(e){let{children:s,requiredRole:t,allowedRoles:o,redirectTo:d="/auth/login"}=e,{user:m,userRole:x,loading:h}=(0,c.useAuth)(),u=(0,i.useRouter)(),g=(0,i.usePathname)(),f=(0,r.useRef)(!1);return((0,r.useEffect)(()=>{if(!h&&!f.current){if(!m){sessionStorage.setItem("redirectAfterLogin",g),g!==d&&(f.current=!0,u.push(d));return}if(t&&x!==t||o&&o.length>0&&(!x||!o.includes(x))){"/unauthorized"!==g&&(f.current=!0,u.push("/unauthorized"));return}}},[m,x,h,t,o]),h)?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)(n.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-engineering-blue rounded-xl flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(l.Z,{className:"w-8 h-8 text-white animate-spin"})}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"認証確認中..."}),(0,a.jsx)("p",{className:"text-gray-600",children:"しばらくお待ちください"})]})}):!m||t&&x!==t||o&&o.length>0&&(!x||!o.includes(x))?null:(0,a.jsx)(a.Fragment,{children:s})}function d(e,s){return function(t){return(0,a.jsx)(o,{requiredRole:s,children:(0,a.jsx)(e,{...t})})}}function m(){let{userRole:e}=(0,c.useAuth)(),s=s=>e===s,t=s=>!!e&&s.includes(e);return{hasRole:s,hasAnyRole:t,isAdmin:()=>s("OrgAdmin"),isStaff:()=>s("Staff"),isContractor:()=>s("Contractor"),isReviewer:()=>s("Reviewer"),isAuditor:()=>s("Auditor"),canManageProjects:()=>t(["OrgAdmin","Staff"]),canViewFinancials:()=>t(["OrgAdmin","Staff","Auditor"]),canReviewProjects:()=>t(["Reviewer","OrgAdmin"]),canViewAuditLogs:()=>t(["Auditor","OrgAdmin"])}}},3779:function(e,s,t){"use strict";t.r(s),t.d(s,{ChatLayout:function(){return Q}});var a=t(57437),r=t(2265),i=t(65251),n=t(25750),l=t(29409),c=t(575),o=t(73067),d=t(41827),m=t(32176),x=t(33277),h=t(66210),u=t(14958),g=t(22169),f=t(24033);function j(e){let{selectedRoomId:s,onRoomSelect:t,className:l=""}=e,{user:j}=(0,h.useAuth)(),p=(0,f.useRouter)(),[v,y]=(0,r.useState)([]),[N,b]=(0,r.useState)(!0),[w,_]=(0,r.useState)(""),[z,S]=(0,r.useState)(null);(0,r.useEffect)(()=>{j&&(k(),C())},[j]),(0,r.useEffect)(()=>{S(sessionStorage.getItem("previousPage"))},[]);let k=async()=>{if(j)try{let{data:{session:e}}=await u.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません"),b(!1);return}let s=await fetch("/api/chat/rooms",{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}}),t=await s.json();s.ok?y(t.rooms):(console.error("チャットルーム取得エラー:",t.message),y([]))}catch(e){console.error("チャットルーム取得エラー:",e),y([])}finally{b(!1)}},C=()=>{let e=u.OQ.channel("chat-rooms-changes").on("postgres_changes",{event:"*",schema:"public",table:"chat_rooms"},()=>k()).on("postgres_changes",{event:"*",schema:"public",table:"chat_messages"},()=>k()).subscribe();return()=>{u.OQ.removeChannel(e)}},E=v.filter(e=>{var s;return e.name.toLowerCase().includes(w.toLowerCase())||(null===(s=e.project_name)||void 0===s?void 0:s.toLowerCase().includes(w.toLowerCase()))}),A=e=>{let s=new Date(e),t=new Date,a=Math.floor((t.getTime()-s.getTime())/36e5);return a<1?Math.floor((t.getTime()-s.getTime())/6e4)+"分前":a<24?a+"時間前":s.toLocaleDateString("ja-JP",{month:"numeric",day:"numeric"})};return N?(0,a.jsx)("div",{className:(0,g.cn)("flex items-center justify-center h-64",l),children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:(0,g.cn)("flex flex-col h-full bg-white",l),children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,a.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)(c.z,{variant:"ghost",size:"sm",onClick:()=>{z&&"/chat"!==z?p.push(z):p.push("/projects")},className:"flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[(0,a.jsx)(o.Z,{className:"w-4 h-4"}),"戻る"]}),(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"チャット"})]})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(d.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsx)("input",{type:"text",placeholder:"チャットルームを検索...",value:w,onChange:e=>_(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engineering-blue focus:border-transparent"})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===E.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 text-gray-500",children:[(0,a.jsx)(m.Z,{className:"w-12 h-12 mb-4"}),(0,a.jsx)("p",{children:"チャットルームがありません"}),w&&(0,a.jsx)("p",{className:"text-sm",children:"検索条件に一致するルームが見つかりません"})]}):(0,a.jsx)("div",{className:"space-y-1 p-2",children:E.map(e=>(0,a.jsxs)(i.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:(0,g.cn)("p-3 rounded-lg cursor-pointer transition-colors hover:bg-gray-50",s===e.id&&"bg-engineering-blue/10 border border-engineering-blue/20"),onClick:()=>t(e.id),children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 truncate",children:e.name}),(e.unread_count||0)>0&&(0,a.jsx)(x.C,{variant:"destructive",className:"text-xs px-2 py-0.5",children:(e.unread_count||0)>99?"99+":e.unread_count})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 truncate",children:["プロジェクト: ",e.project_name]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs text-gray-400",children:[(0,a.jsx)(n.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{children:e.participant_count})]})]}),e.last_message&&(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 truncate",children:e.last_message.sender_name}),(0,a.jsx)("span",{className:"text-xs text-gray-400",children:A(e.last_message.created_at)})]}),(0,a.jsx)("p",{className:"text-xs text-gray-600 truncate",children:e.last_message.content})]}),!e.last_message&&(0,a.jsx)("p",{className:"text-xs text-gray-400",children:"メッセージがありません"})]},e.id))})})]})}var p=t(62167),v=t(35817),y=t(28734),N=t(40734),b=t(45367),w=t(74824),_=t(53714),z=t(6141),S=t(76020);function k(e){var s,t;let{roomId:n,className:l=""}=e,{user:o}=(0,h.useAuth)(),[d,m]=(0,r.useState)([]),[x,f]=(0,r.useState)(""),[j,k]=(0,r.useState)(!0),[C,E]=(0,r.useState)(!1),[A,O]=(0,r.useState)(null),[Z,D]=(0,r.useState)(null),[T,P]=(0,r.useState)(""),[Q,R]=(0,r.useState)(!1),[I,B]=(0,r.useState)(null),L=(0,r.useRef)(null),F=(0,r.useRef)(null);(0,r.useEffect)(()=>{n&&(M(),G(),q())},[n]),(0,r.useEffect)(()=>{J()},[d]);let M=async()=>{if(n)try{let{data:{session:s}}=await u.OQ.auth.getSession();if(!s){console.error("セッションが見つかりません"),k(!1);return}let t=await fetch("/api/chat/messages?room_id=".concat(n),{method:"GET",headers:{Authorization:"Bearer ".concat(s.access_token)}}),a=await t.json();if(t.ok){var e;let s=(null===(e=a.messages)||void 0===e?void 0:e.map(e=>({id:e.id,room_id:n,content:e.content,sender_id:e.sender_id,sender:{id:e.sender_id,display_name:e.sender_name||"Unknown",email:e.sender_email,avatar_url:e.sender_avatar_url},sender_type:e.sender_type,created_at:e.created_at,is_deleted:!1,message_type:e.message_type||"text",file_url:e.file_url,file_name:e.file_name,file_size:e.file_size})))||[];m(s)}else console.error("メッセージ取得エラー:",a.message),m([])}catch(e){console.error("Error fetching messages:",e),m([])}finally{k(!1)}},q=()=>{let e=u.OQ.channel("chat-messages-".concat(n)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"room_id=eq.".concat(n)},()=>M()).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_messages",filter:"room_id=eq.".concat(n)},()=>M()).subscribe();return()=>{u.OQ.removeChannel(e)}},G=async()=>{if(n&&o)try{await u.OQ.rpc("mark_messages_as_read",{p_room_id:n})}catch(e){console.error("Error marking messages as read:",e)}},J=()=>{var e;null===(e=L.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},V=async e=>{if(e.preventDefault(),x.trim()&&o&&!C){E(!0);try{let{data:{session:e}}=await u.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let s={room_id:n,content:x.trim(),message_type:"text"},t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.access_token)},body:JSON.stringify(s)}),a=await t.json();t.ok?(f(""),O(null),M()):console.error("メッセージ送信エラー:",a.message)}catch(e){console.error("Error sending message:",e)}finally{E(!1)}}},K=e=>{B(e),P(""),R(!0)},U=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(o&&e)try{E(!0);let{data:{session:t}}=await u.OQ.auth.getSession();if(!t){console.error("セッションが見つかりません");return}let a=new FormData;a.append("file",e),a.append("roomId",n),a.append("comment",s),console.log("ファイルアップロード開始:",{fileName:e.name,fileSize:e.size,fileType:e.type,roomId:n,comment:s});let r=await fetch("/api/chat/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(t.access_token)},body:a}),i=await r.json();r.ok?(console.log("ファイルアップロード成功:",i),M(),R(!1),B(null),P("")):(console.error("ファイルアップロードエラー:",i.message),alert("ファイルのアップロードに失敗しました: "+i.message))}catch(e){console.error("Error uploading file:",e),alert("ファイルのアップロードに失敗しました: "+(e instanceof Error?e.message:"不明なエラー"))}finally{E(!1)}},W=async(e,s)=>{try{let{error:t}=await u.OQ.from("chat_messages").update({content:s,edited_at:new Date().toISOString()}).eq("id",e).eq("sender_id",null==o?void 0:o.id);if(t)throw t;D(null)}catch(e){console.error("Error editing message:",e)}},H=async e=>{try{let{error:s}=await u.OQ.from("chat_messages").update({is_deleted:!0}).eq("id",e).eq("sender_id",null==o?void 0:o.id);if(s)throw s}catch(e){console.error("Error deleting message:",e)}},X=e=>{let s=new Date(e),t=new Date;return s.toDateString()===t.toDateString()?s.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("ja-JP",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})},Y=e=>{if(0===e)return"0 Bytes";let s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]};return j?(0,a.jsx)("div",{className:(0,g.cn)("flex items-center justify-center h-64",l),children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:(0,g.cn)("flex flex-col h-full bg-white",l),children:[(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,a.jsx)(p.M,{children:d.map(e=>{var s,t,r,n,l,d,m,x;let h=e.sender_id===(null==o?void 0:o.id),u=!h;return(0,a.jsxs)(i.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},className:(0,g.cn)("flex gap-3 group",h?"justify-end":"justify-start"),children:[u&&(0,a.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 overflow-hidden",children:(null===(s=e.sender)||void 0===s?void 0:s.avatar_url)?(0,a.jsx)("img",{src:e.sender.avatar_url,alt:(null===(t=e.sender)||void 0===t?void 0:t.display_name)||"User",className:"w-full h-full object-cover"}):(0,a.jsx)("div",{className:"w-full h-full bg-engineering-blue flex items-center justify-center",children:(null===(n=e.sender)||void 0===n?void 0:null===(r=n.display_name)||void 0===r?void 0:r.charAt(0))||(null===(d=e.sender)||void 0===d?void 0:null===(l=d.email)||void 0===l?void 0:l.charAt(0))||"U"})}),(0,a.jsxs)("div",{className:(0,g.cn)("flex flex-col max-w-xs sm:max-w-md",h&&"items-end"),children:[(0,a.jsxs)("div",{className:(0,g.cn)("flex items-center gap-2 mb-1 text-xs text-gray-500",h?"flex-row-reverse":"flex-row"),children:[(0,a.jsx)("span",{className:"font-medium",children:h?"あなた":(null===(m=e.sender)||void 0===m?void 0:m.display_name)||(null===(x=e.sender)||void 0===x?void 0:x.email)||"不明"}),(0,a.jsx)("span",{children:X(e.created_at)}),e.edited_at&&(0,a.jsx)("span",{className:"text-xs text-gray-400",children:"(編集済み)"})]}),e.reply_message&&(0,a.jsxs)("div",{className:"mb-2 p-2 bg-gray-100 border-l-2 border-engineering-blue rounded text-xs",children:[(0,a.jsx)("div",{className:"font-medium text-engineering-blue",children:e.reply_message.sender_name}),(0,a.jsx)("div",{className:"text-gray-600 truncate",children:e.reply_message.content})]}),(0,a.jsxs)("div",{className:(0,g.cn)("relative px-4 py-2 rounded-2xl max-w-full break-words",h?"bg-engineering-blue text-white":"bg-gray-100 text-gray-900"),children:[Z===e.id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{type:"text",defaultValue:e.content,className:"flex-1 bg-transparent border-none outline-none",onKeyDown:s=>{"Enter"===s.key?W(e.id,s.currentTarget.value):"Escape"===s.key&&D(null)},autoFocus:!0}),(0,a.jsx)(c.z,{size:"sm",variant:"ghost",onClick:()=>D(null),className:"text-current hover:bg-white/20",children:"キャンセル"})]}):(0,a.jsxs)(a.Fragment,{children:["text"===e.message_type&&(0,a.jsx)("p",{children:e.content}),("file"===e.message_type||"image"===e.message_type)&&(0,a.jsxs)("div",{className:"space-y-2",children:[e.content!==e.file_name&&(0,a.jsx)("p",{className:"text-sm",children:e.content}),"image"===e.message_type?(0,a.jsxs)("div",{children:[(0,a.jsx)("img",{src:e.file_url,alt:e.file_name,className:"max-w-xs rounded-lg"}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsx)("p",{className:"text-xs opacity-75",children:e.file_name}),(0,a.jsx)(c.z,{size:"sm",variant:"ghost",className:"text-current hover:bg-white/20 h-6 px-2",onClick:()=>window.open(e.file_url,"_blank"),children:(0,a.jsx)(v.Z,{className:"w-3 h-3"})})]})]}):(0,a.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-white/10 rounded-lg",children:[(0,a.jsx)(y.Z,{className:"w-4 h-4"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:e.file_name}),e.file_size&&(0,a.jsx)("p",{className:"text-xs opacity-75",children:Y(e.file_size)})]}),(0,a.jsx)(c.z,{size:"sm",variant:"ghost",className:"text-current hover:bg-white/20",onClick:()=>window.open(e.file_url,"_blank"),children:(0,a.jsx)(v.Z,{className:"w-3 h-3"})})]})]})]}),h&&Z!==e.id&&(0,a.jsx)("div",{className:"absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(c.z,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white text-gray-600 hover:text-engineering-blue",onClick:()=>D(e.id),children:(0,a.jsx)(N.Z,{className:"w-3 h-3"})}),(0,a.jsx)(c.z,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white text-gray-600 hover:text-red-600",onClick:()=>H(e.id),children:(0,a.jsx)(b.Z,{className:"w-3 h-3"})})]})})]}),!h&&(0,a.jsxs)(c.z,{size:"sm",variant:"ghost",className:"mt-1 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-gray-500 hover:text-engineering-blue",onClick:()=>O(e),children:[(0,a.jsx)(w.Z,{className:"w-3 h-3 mr-1"}),"返信"]})]})]},e.id)})}),(0,a.jsx)("div",{ref:L})]}),A&&(0,a.jsx)("div",{className:"px-4 py-2 bg-gray-50 border-t",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"text-xs text-engineering-blue font-medium",children:[(null===(s=A.sender)||void 0===s?void 0:s.display_name)||(null===(t=A.sender)||void 0===t?void 0:t.email),"への返信"]}),(0,a.jsx)("div",{className:"text-sm text-gray-600 truncate",children:A.content})]}),(0,a.jsx)(c.z,{size:"sm",variant:"ghost",onClick:()=>O(null),children:"\xd7"})]})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,a.jsxs)("form",{onSubmit:V,className:"flex items-end gap-2",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)("textarea",{value:x,onChange:e=>f(e.target.value),placeholder:"メッセージを入力...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-engineering-blue focus:border-transparent",rows:1,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()}})}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"file",ref:F,onChange:e=>{var s;let t=null===(s=e.target.files)||void 0===s?void 0:s[0];t&&K(t)},className:"hidden"}),(0,a.jsx)(c.z,{type:"button",variant:"outline",size:"icon",onClick:()=>{var e;return null===(e=F.current)||void 0===e?void 0:e.click()},disabled:C,children:(0,a.jsx)(_.Z,{className:"w-4 h-4"})}),(0,a.jsx)(c.z,{type:"submit",disabled:!x.trim()||C,className:"px-4",children:C?(0,a.jsx)(z.Z,{className:"w-4 h-4 animate-spin"}):(0,a.jsx)(S.Z,{className:"w-4 h-4"})})]})]})}),Q&&I&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"ファイルをアップロード"}),(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-engineering-blue rounded-lg flex items-center justify-center",children:(0,a.jsx)(y.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900",children:I.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:Y(I.size)})]})]})}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"コメント（任意）"}),(0,a.jsx)("textarea",{value:T,onChange:e=>P(e.target.value),placeholder:"ファイルについてのコメントを入力してください...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engineering-blue focus:border-transparent resize-none",rows:3})]}),(0,a.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,a.jsx)(c.z,{variant:"outline",onClick:()=>{R(!1),B(null),P("")},disabled:C,children:"キャンセル"}),(0,a.jsx)(c.z,{variant:"engineering",onClick:()=>U(I,T),disabled:C,children:C?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"アップロード中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(S.Z,{className:"w-4 h-4 mr-2"}),"アップロード"]})})]})]})})]})}var C=t(67972),E=t(49168),A=t(49036),O=t(82549),Z=t(74527),D=t(62442),T=t(11981);function P(e){let{roomId:s,projectId:t,isVisible:l,onClose:o,className:d=""}=e,{user:m}=(0,h.useAuth)(),[f,j]=(0,r.useState)([]),[v,y]=(0,r.useState)(!0),[N,b]=(0,r.useState)(""),[w,_]=(0,r.useState)(!1),[z,S]=(0,r.useState)([]),[k,P]=(0,r.useState)(!1),[Q,R]=(0,r.useState)(!1);(0,r.useEffect)(()=>{l&&s&&(I(),B())},[l,s]);let I=async()=>{try{let{data:{session:e}}=await u.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let t=await fetch("/api/chat/participants?room_id=".concat(s),{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}}),a=await t.json();t.ok?j(a.participants):(console.error("参加者取得エラー:",a.message),j([]))}catch(e){console.error("参加者取得エラー:",e),j([])}finally{y(!1)}},B=async()=>{try{let{data:{session:e}}=await u.OQ.auth.getSession();if(!e)return;let s=await fetch("/api/projects/".concat(t),{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token)}});if(s.ok){let e=(await s.json()).project,{data:t}=await u.OQ.from("users").select("id").eq("auth_user_id",null==m?void 0:m.id).single(),{data:a}=await u.OQ.from("memberships").select("org_id, role").eq("user_id",null==t?void 0:t.id).single();R((null==a?void 0:a.org_id)===e.org_id)}}catch(e){console.error("権限確認エラー:",e),R(!1)}},L=async()=>{if(N.trim()){_(!0),S([]);try{let{data:{session:e}}=await u.OQ.auth.getSession();if(!e){console.error("セッションが見つかりません");return}let t=N.split(/[,\n]/).map(e=>e.trim()).filter(e=>e),a=await fetch("/api/chat/participants/invite",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.access_token)},body:JSON.stringify({room_id:s,user_emails:t})}),r=await a.json();a.ok?(S(r.results),b(""),I()):(console.error("招待エラー:",r.message),S([{email:"全体",success:!1,error:r.message}]))}catch(e){console.error("招待エラー:",e),S([{email:"全体",success:!1,error:"招待処理中にエラーが発生しました"}])}finally{_(!1)}}},F=(e,s)=>"contractor"===e?(0,a.jsx)(C.Z,{className:"w-4 h-4 text-blue-600"}):"OrgAdmin"===s?(0,a.jsx)(E.Z,{className:"w-4 h-4 text-yellow-600"}):"Staff"===s?(0,a.jsx)(A.Z,{className:"w-4 h-4 text-green-600"}):(0,a.jsx)(C.Z,{className:"w-4 h-4 text-gray-600"}),M=(e,s)=>"contractor"===e?"受注者":"OrgAdmin"===s?"組織管理者":"Staff"===s?"スタッフ":"メンバー";return l?(0,a.jsxs)(i.E.div,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},className:(0,g.cn)("fixed top-0 right-0 h-full w-80 bg-white border-l border-gray-200 shadow-lg z-50 flex flex-col",d),children:[(0,a.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(n.Z,{className:"w-5 h-5 text-engineering-blue"}),(0,a.jsx)("h3",{className:"font-semibold text-gray-900",children:"参加者"}),(0,a.jsx)(x.C,{variant:"secondary",children:f.length})]}),(0,a.jsx)(c.z,{variant:"ghost",size:"sm",onClick:o,className:"h-8 w-8 p-0",children:(0,a.jsx)(O.Z,{className:"w-4 h-4"})})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:v?(0,a.jsx)("div",{className:"flex items-center justify-center h-32",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-engineering-blue"})}):(0,a.jsxs)("div",{className:"space-y-4",children:[Q&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"招待"}),(0,a.jsxs)(c.z,{variant:"outline",size:"sm",onClick:()=>P(!k),className:"flex items-center gap-2",children:[(0,a.jsx)(Z.Z,{className:"w-4 h-4"}),"招待"]})]}),(0,a.jsx)(p.M,{children:k&&(0,a.jsxs)(i.E.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"メールアドレス（複数の場合は改行またはカンマで区切り）"}),(0,a.jsx)("textarea",{value:N,onChange:e=>b(e.target.value),placeholder:"user@example.com",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-engineering-blue focus:border-transparent",rows:3})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(c.z,{onClick:L,disabled:!N.trim()||w,size:"sm",className:"flex-1",children:w?"招待中...":"招待する"}),(0,a.jsx)(c.z,{variant:"outline",size:"sm",onClick:()=>{P(!1),b(""),S([])},children:"キャンセル"})]})]})}),z.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h5",{className:"text-xs font-medium text-gray-600",children:"招待結果"}),z.map((e,s)=>(0,a.jsxs)("div",{className:(0,g.cn)("p-2 rounded-lg text-xs",e.success?"bg-green-50 text-green-800":"bg-red-50 text-red-800"),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[e.success?(0,a.jsx)(D.Z,{className:"w-3 h-3"}):(0,a.jsx)(T.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{className:"font-medium",children:e.email})]}),(0,a.jsx)("p",{className:"mt-1",children:e.message||e.error})]},s))]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"現在の参加者"}),(0,a.jsx)("div",{className:"space-y-2",children:f.map(e=>{var s;return(0,a.jsxs)(i.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-engineering-blue flex items-center justify-center text-white text-sm font-medium flex-shrink-0",children:(null===(s=e.display_name)||void 0===s?void 0:s.charAt(0))||e.email.charAt(0)}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.display_name||"名前未設定"}),F(e.role,e.org_role)]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.email}),(0,a.jsx)(x.C,{variant:"secondary",className:"mt-1 text-xs",children:M(e.role,e.org_role)})]})]},e.id)})})]})]})})]}):null}function Q(e){let{className:s=""}=e,[t,o]=(0,r.useState)(null),[d,m]=(0,r.useState)(!1),[x,h]=(0,r.useState)(!1);return r.useEffect(()=>{let e=()=>{h(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,r.useEffect)(()=>{let e="/chat",s=sessionStorage.getItem("currentPage");sessionStorage.setItem("currentPage",e),s&&s!==e&&sessionStorage.setItem("previousPage",s)},[]),(0,a.jsxs)("div",{className:(0,g.cn)("flex h-full bg-gray-50",s),children:[(0,a.jsx)(i.E.div,{initial:!1,animate:{width:x?t?0:"100%":320,opacity:x&&t?0:1},className:(0,g.cn)("border-r border-gray-200 bg-white overflow-hidden",x&&t&&"hidden"),children:(0,a.jsx)(j,{selectedRoomId:t||void 0,onRoomSelect:e=>{o(e)},className:"h-full"})}),(0,a.jsx)("div",{className:"flex-1 flex flex-col overflow-hidden",children:t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-white",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[x&&(0,a.jsx)(c.z,{variant:"ghost",size:"icon",onClick:()=>o(null),children:"←"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"font-semibold text-gray-900",children:"チャットルーム"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"プロジェクト関連のディスカッション"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(c.z,{variant:"ghost",size:"icon",onClick:()=>m(!d),className:(0,g.cn)("transition-colors",d&&"bg-engineering-blue/10 text-engineering-blue"),children:(0,a.jsx)(n.Z,{className:"w-4 h-4"})}),(0,a.jsx)(c.z,{variant:"ghost",size:"icon",children:(0,a.jsx)(l.Z,{className:"w-4 h-4"})})]})]}),(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1 flex flex-col",children:(0,a.jsx)(k,{roomId:t,className:"flex-1"})}),d&&(0,a.jsx)(P,{roomId:t,projectId:t.replace("project_",""),isVisible:d,onClose:()=>m(!1)})]})]}):(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center bg-white",children:(0,a.jsxs)("div",{className:"text-center max-w-md",children:[(0,a.jsx)("div",{className:"w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(n.Z,{className:"w-8 h-8 text-gray-400"})}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"チャットルームを選択してください"}),(0,a.jsx)("p",{className:"text-gray-500 mb-6",children:"左のリストからチャットルームを選択して、 プロジェクト関係者とのコミュニケーションを開始してください。"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-gray-400",children:[(0,a.jsx)("p",{children:"\uD83D\uDCAC リアルタイムメッセージング"}),(0,a.jsx)("p",{children:"\uD83D\uDCC1 ファイル共有"}),(0,a.jsx)("p",{children:"\uD83D\uDC65 プロジェクト関係者との連携"})]})]})})})]})}}},function(e){e.O(0,[14,402,440,416,97,971,938,744],function(){return e(e.s=17341)}),_N_E=e.O()}]);