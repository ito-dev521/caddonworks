(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[361],{24121:function(e,r,l){Promise.resolve().then(l.bind(l,64523))},64523:function(e,r,l){"use strict";l.r(r),l.d(r,{default:function(){return n}});var o=l(57437);l(2265);var s=l(66210);function n(){let{user:e,userProfile:r,userRole:l,userOrganization:n,loading:i}=(0,s.useAuth)();return(0,o.jsx)("div",{className:"min-h-screen bg-gray-100 p-8",children:(0,o.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,o.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"認証デバッグ情報"}),(0,o.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"認証状態"}),(0,o.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Loading:"})," ",i?"true":"false"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User:"})," ",e?"あり":"なし"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User ID:"})," ",(null==e?void 0:e.id)||"なし"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User Email:"})," ",(null==e?void 0:e.email)||"なし"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User Profile:"})," ",r?"あり":"なし"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User Role:"})," ",l||"なし"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"User Organization:"})," ",n?n.name:"なし"]})]})]}),r&&(0,o.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"ユーザープロフィール詳細"}),(0,o.jsx)("pre",{className:"text-xs bg-gray-100 p-4 rounded overflow-auto",children:JSON.stringify(r,null,2)})]}),e&&(0,o.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Supabase User詳細"}),(0,o.jsx)("pre",{className:"text-xs bg-gray-100 p-4 rounded overflow-auto",children:JSON.stringify({id:e.id,email:e.email,created_at:e.created_at,updated_at:e.updated_at,aud:e.aud,role:e.role},null,2)})]}),(0,o.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"利用可能なアクション"}),(0,o.jsxs)("div",{className:"space-y-2",children:[(0,o.jsx)("a",{href:"/auth/login",className:"block text-blue-600 hover:underline",children:"ログインページ"}),(0,o.jsx)("a",{href:"/projects",className:"block text-blue-600 hover:underline",children:"案件一覧"}),(0,o.jsx)("a",{href:"/contracts",className:"block text-blue-600 hover:underline",children:"契約一覧"}),(0,o.jsx)("a",{href:"/jobs",className:"block text-blue-600 hover:underline",children:"案件一覧（受注者）"})]})]})]})})}},66210:function(e,r,l){"use strict";l.r(r),l.d(r,{AuthProvider:function(){return a},useAuth:function(){return t}});var o=l(57437),s=l(2265),n=l(14958);let i=(0,s.createContext)(void 0);function t(){let e=(0,s.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function a(e){let{children:r}=e,[l,t]=(0,s.useState)(null),[a,c]=(0,s.useState)(null),[u,d]=(0,s.useState)(null),[h,f]=(0,s.useState)(null),[g,v]=(0,s.useState)(!0),m=(0,s.useRef)(null);(0,s.useEffect)(()=>{(async()=>{try{var e,r,l;console.log("AuthProvider: 初期セッション取得開始");let{data:{session:o},error:s}=await n.OQ.auth.getSession();if(s){console.error("AuthProvider: セッション取得エラー:",s),v(!1);return}console.log("AuthProvider: セッション取得結果:",{hasSession:!!o,userId:null==o?void 0:null===(e=o.user)||void 0===e?void 0:e.id,hasAccessToken:!!(null==o?void 0:o.access_token),tokenLength:null==o?void 0:null===(r=o.access_token)||void 0===r?void 0:r.length}),t(null!==(l=null==o?void 0:o.user)&&void 0!==l?l:null),(null==o?void 0:o.user)&&(null==o?void 0:o.access_token)?(console.log("\uD83D\uDE80 AuthProvider: 初期セッション - ユーザープロフィール取得開始"),setTimeout(()=>{console.log("⏱️ setTimeout実行: fetchUserProfile呼び出し (初期セッション)"),p(o.user.id)},0)):console.log("AuthProvider: セッションまたはトークンなし、ローディング終了")}catch(e){console.error("AuthProvider: 初期化エラー:",e),t(null),c(null),d(null),f(null)}finally{v(!1)}})();let{data:{subscription:e}}=n.OQ.auth.onAuthStateChange(async(e,r)=>{var l,o;let s=new Date().toISOString();console.log("\uD83D\uDD04 [".concat(s,"] Auth state change:"),{event:e,userId:null==r?void 0:null===(l=r.user)||void 0===l?void 0:l.id,hasToken:!!(null==r?void 0:r.access_token)}),t(null!==(o=null==r?void 0:r.user)&&void 0!==o?o:null),(null==r?void 0:r.user)&&"SIGNED_IN"===e?(console.log("\uD83D\uDD11 [".concat(s,"] Auth state change: SIGNED_IN, fetching profile")),setTimeout(()=>{console.log("⏱️ [".concat(s,"] setTimeout実行: fetchUserProfile呼び出し (SIGNED_IN)")),p(r.user.id)},0)):"SIGNED_OUT"===e&&(console.log("Auth state change: SIGNED_OUT, clearing profile"),c(null),d(null),f(null)),"INITIAL_SESSION"!==e&&v(!1)});return()=>e.unsubscribe()},[]);let p=async e=>{var r;let l=new Date().toISOString(),o=null===(r=Error().stack)||void 0===r?void 0:r.split("\n").slice(1,4).join(" -> ");if(console.log("\uD83D\uDD0D [".concat(l,"] fetchUserProfile: 開始"),{authUserId:e,fetchingRef:m.current,callStack:o}),m.current===e){console.log("⚠️ [".concat(l,"] fetchUserProfile: 既に実行中のためスキップ"),{authUserId:e});return}m.current=e,console.log("\uD83C\uDFC3 [".concat(l,"] fetchUserProfile: 実行開始"),{authUserId:e});try{console.log("fetchUserProfile: ユーザープロフィール取得開始");let{data:r,error:l}=await n.OQ.from("users").select("*").eq("auth_user_id",e).single();if(console.log("fetchUserProfile: ユーザープロフィール結果",{profile:null==r?void 0:r.id,error:null==l?void 0:l.message}),l&&"PGRST116"!==l.code){console.error("Error fetching user profile:",l);return}if(c(r),r){console.log("fetchUserProfile: メンバーシップ取得開始",{profileId:r.id});let{data:e,error:l}=await n.OQ.from("memberships").select("role, org_id").eq("user_id",r.id).single();if(console.log("fetchUserProfile: メンバーシップ結果",{role:null==e?void 0:e.role,org_id:null==e?void 0:e.org_id,error:null==l?void 0:l.message}),l&&"PGRST116"!==l.code){console.error("Error fetching user role:",l);return}if(d((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:r,error:l}=await n.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();l?(console.error("Error fetching organization:",l),f(null)):f({id:r.id,name:r.name})}else f(null);console.log("fetchUserProfile: 完了",{role:null==e?void 0:e.role,organization:null==e?void 0:e.org_id})}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{m.current=null,console.log("✅ [".concat(l,"] fetchUserProfile: 実行完了"),{authUserId:e})}},x=async(e,r)=>{console.log("signIn: 開始",{email:e}),v(!0);try{var l;console.log("signIn: Supabase認証開始");let o=n.OQ.auth.signInWithPassword({email:e,password:r}),s=new Promise((e,r)=>{setTimeout(()=>r(Error("認証タイムアウト（30秒）")),3e4)}),{data:i,error:t}=await Promise.race([o,s]);if(console.log("signIn: Supabase認証結果",{data:null==i?void 0:null===(l=i.user)||void 0===l?void 0:l.id,error:null==t?void 0:t.message}),t)throw t;console.log("signIn: 認証成功"),(null==i?void 0:i.user)&&(console.log("signIn: ユーザープロフィール取得開始"),setTimeout(()=>{p(i.user.id)},50),console.log("signIn: ユーザープロフィール取得完了"))}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{console.log("signIn: 終了"),v(!1)}},_=async(e,r,l)=>{v(!0);try{let{data:o,error:s}=await n.OQ.auth.signUp({email:e,password:r,options:{data:{display_name:l.display_name,specialties:l.specialties||[],qualifications:l.qualifications||[]}}});if(s)throw s;if(o.user){let{error:e}=await n.OQ.from("users").insert({auth_user_id:o.user.id,email:o.user.email,display_name:l.display_name||"",specialties:l.specialties||[],qualifications:l.qualifications||[],experience_years:l.experience_years});e&&console.error("Error creating user profile:",e)}}finally{v(!1)}},b=async()=>{v(!0);try{let{error:e}=await n.OQ.auth.signOut();if(e)throw e;t(null),c(null),d(null)}finally{v(!1)}},j=async e=>{if(!a)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{console.log("updateProfile: 更新開始",{userId:a.id,updates:e});let{data:r,error:l}=await n.OQ.from("users").update(e).eq("id",a.id).select().single();if(l)throw console.error("updateProfile: Supabaseエラー",l),l;console.log("updateProfile: 更新成功",r),c({...a,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,o.jsx)(i.Provider,{value:{user:l,userProfile:a,userRole:u,userOrganization:h,loading:g,signIn:x,signUp:_,signOut:b,updateProfile:j,getRedirectPath:()=>{if(!u)return"/dashboard";switch(u){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:r})}},14958:function(e,r,l){"use strict";l.d(r,{OQ:function(){return s}});var o=l(37440);l(62601);let s=(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},30622:function(e,r,l){"use strict";var o=l(2265),s=Symbol.for("react.element"),n=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,t=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function c(e,r,l){var o,n={},c=null,u=null;for(o in void 0!==l&&(c=""+l),void 0!==r.key&&(c=""+r.key),void 0!==r.ref&&(u=r.ref),r)i.call(r,o)&&!a.hasOwnProperty(o)&&(n[o]=r[o]);if(e&&e.defaultProps)for(o in r=e.defaultProps)void 0===n[o]&&(n[o]=r[o]);return{$$typeof:s,type:e,key:c,ref:u,props:n,_owner:t.current}}r.Fragment=n,r.jsx=c,r.jsxs=c},57437:function(e,r,l){"use strict";e.exports=l(30622)}},function(e){e.O(0,[440,971,938,744],function(){return e(e.s=24121)}),_N_E=e.O()}]);