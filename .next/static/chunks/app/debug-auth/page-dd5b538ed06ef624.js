(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[361],{24121:function(e,r,s){Promise.resolve().then(s.bind(s,64523))},64523:function(e,r,s){"use strict";s.r(r),s.d(r,{default:function(){return i}});var l=s(57437);s(2265);var t=s(66210);function i(){let{user:e,userProfile:r,userRole:s,userOrganization:i,loading:n}=(0,t.useAuth)();return(0,l.jsx)("div",{className:"min-h-screen bg-gray-100 p-8",children:(0,l.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,l.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"認証デバッグ情報"}),(0,l.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"認証状態"}),(0,l.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"Loading:"})," ",n?"true":"false"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User:"})," ",e?"あり":"なし"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User ID:"})," ",(null==e?void 0:e.id)||"なし"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User Email:"})," ",(null==e?void 0:e.email)||"なし"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User Profile:"})," ",r?"あり":"なし"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User Role:"})," ",s||"なし"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"User Organization:"})," ",i?i.name:"なし"]})]})]}),r&&(0,l.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"ユーザープロフィール詳細"}),(0,l.jsx)("pre",{className:"text-xs bg-gray-100 p-4 rounded overflow-auto",children:JSON.stringify(r,null,2)})]}),e&&(0,l.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg mb-6",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Supabase User詳細"}),(0,l.jsx)("pre",{className:"text-xs bg-gray-100 p-4 rounded overflow-auto",children:JSON.stringify({id:e.id,email:e.email,created_at:e.created_at,updated_at:e.updated_at,aud:e.aud,role:e.role},null,2)})]}),(0,l.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"利用可能なアクション"}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("a",{href:"/auth/login",className:"block text-blue-600 hover:underline",children:"ログインページ"}),(0,l.jsx)("a",{href:"/projects",className:"block text-blue-600 hover:underline",children:"案件一覧"}),(0,l.jsx)("a",{href:"/contracts",className:"block text-blue-600 hover:underline",children:"契約一覧"}),(0,l.jsx)("a",{href:"/jobs",className:"block text-blue-600 hover:underline",children:"案件一覧（受注者）"})]})]})]})})}},66210:function(e,r,s){"use strict";s.r(r),s.d(r,{AuthProvider:function(){return o},useAuth:function(){return a}});var l=s(57437),t=s(2265),i=s(14958);let n=(0,t.createContext)(void 0);function a(){let e=(0,t.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function o(e){let{children:r}=e,[s,a]=(0,t.useState)(null),[o,u]=(0,t.useState)(null),[c,d]=(0,t.useState)(null),[h,f]=(0,t.useState)(null),[m,x]=(0,t.useState)(!0),g=(0,t.useRef)(null);(0,t.useEffect)(()=>{(async()=>{try{var e;let{data:{session:r},error:s}=await i.OQ.auth.getSession();if(s){console.error("AuthProvider: セッション取得エラー:",s),x(!1);return}a(null!==(e=null==r?void 0:r.user)&&void 0!==e?e:null),(null==r?void 0:r.user)&&(null==r?void 0:r.access_token)?setTimeout(()=>{p(r.user.id)},0):x(!1)}catch(e){console.error("AuthProvider: 初期化エラー:",e),a(null),u(null),d(null),f(null),x(!1)}})();let{data:{subscription:e}}=i.OQ.auth.onAuthStateChange(async(e,r)=>{var s;a(null!==(s=null==r?void 0:r.user)&&void 0!==s?s:null),(null==r?void 0:r.user)&&"SIGNED_IN"===e?setTimeout(()=>{p(r.user.id)},0):"SIGNED_OUT"===e&&(u(null),d(null),f(null)),"INITIAL_SESSION"!==e&&x(!1)});return()=>e.unsubscribe()},[]);let p=async e=>{if(g.current!==e){g.current=e;try{let{data:r,error:s}=await i.OQ.from("users").select("*").eq("auth_user_id",e).single();if(s&&"PGRST116"!==s.code){console.error("Error fetching user profile:",s);return}if(u(r),r){let{data:e,error:s}=await i.OQ.from("memberships").select("role, org_id").eq("user_id",r.id).single();if(s&&"PGRST116"!==s.code){console.error("Error fetching user role:",s);return}if(d((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:r,error:s}=await i.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();s?(console.error("Error fetching organization:",s),f(null)):f({id:r.id,name:r.name})}else f(null)}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{g.current=null,x(!1)}}},v=async(e,r)=>{x(!0);try{let s=i.OQ.auth.signInWithPassword({email:e,password:r}),l=new Promise((e,r)=>{setTimeout(()=>r(Error("認証タイムアウト（30秒）")),3e4)}),{data:t,error:n}=await Promise.race([s,l]);if(n)throw n;(null==t?void 0:t.user)&&setTimeout(()=>{p(t.user.id)},50)}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{x(!1)}},b=async(e,r,s)=>{x(!0);try{let{data:l,error:t}=await i.OQ.auth.signUp({email:e,password:r,options:{data:{display_name:s.display_name,specialties:s.specialties||[],qualifications:s.qualifications||[]}}});if(t)throw t;if(l.user){let{error:e}=await i.OQ.from("users").insert({auth_user_id:l.user.id,email:l.user.email,display_name:s.display_name||"",specialties:s.specialties||[],qualifications:s.qualifications||[],experience_years:s.experience_years});e&&console.error("Error creating user profile:",e)}}finally{x(!1)}},j=async()=>{x(!0);try{let{error:e}=await i.OQ.auth.signOut();if(e)throw e;a(null),u(null),d(null)}finally{x(!1)}},y=async e=>{if(!o)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{let{data:r,error:s}=await i.OQ.from("users").update(e).eq("id",o.id).select().single();if(s)throw console.error("updateProfile: Supabaseエラー",s),s;u({...o,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,l.jsx)(n.Provider,{value:{user:s,userProfile:o,userRole:c,userOrganization:h,loading:m,signIn:v,signUp:b,signOut:j,updateProfile:y,getRedirectPath:()=>{if(!c)return"/dashboard";switch(c){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:r})}},14958:function(e,r,s){"use strict";s.d(r,{OQ:function(){return t}});var l=s(37440);s(62601);let t=(0,l.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},30622:function(e,r,s){"use strict";var l=s(2265),t=Symbol.for("react.element"),i=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,a=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function u(e,r,s){var l,i={},u=null,c=null;for(l in void 0!==s&&(u=""+s),void 0!==r.key&&(u=""+r.key),void 0!==r.ref&&(c=r.ref),r)n.call(r,l)&&!o.hasOwnProperty(l)&&(i[l]=r[l]);if(e&&e.defaultProps)for(l in r=e.defaultProps)void 0===i[l]&&(i[l]=r[l]);return{$$typeof:t,type:e,key:u,ref:c,props:i,_owner:a.current}}r.Fragment=i,r.jsx=u,r.jsxs=u},57437:function(e,r,s){"use strict";e.exports=s(30622)}},function(e){e.O(0,[440,971,938,744],function(){return e(e.s=24121)}),_N_E=e.O()}]);