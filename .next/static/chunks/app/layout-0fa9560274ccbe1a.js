(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{15457:function(e,r,t){Promise.resolve().then(t.t.bind(t,99646,23)),Promise.resolve().then(t.t.bind(t,63385,23)),Promise.resolve().then(t.bind(t,66210))},66210:function(e,r,t){"use strict";t.r(r),t.d(r,{AuthProvider:function(){return u},useAuth:function(){return s}});var n=t(57437),i=t(2265),o=t(14958);let l=(0,i.createContext)(void 0);function s(){let e=(0,i.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function u(e){let{children:r}=e,[t,s]=(0,i.useState)(null),[u,a]=(0,i.useState)(null),[c,f]=(0,i.useState)(null),[d,h]=(0,i.useState)(null),[_,p]=(0,i.useState)(!0),m=(0,i.useRef)(null);(0,i.useEffect)(()=>{(async()=>{try{var e;let{data:{session:r},error:t}=await o.OQ.auth.getSession();if(t){console.error("AuthProvider: セッション取得エラー:",t),p(!1);return}s(null!==(e=null==r?void 0:r.user)&&void 0!==e?e:null),(null==r?void 0:r.user)&&(null==r?void 0:r.access_token)?setTimeout(()=>{y(r.user.id)},0):p(!1)}catch(e){console.error("AuthProvider: 初期化エラー:",e),s(null),a(null),f(null),h(null),p(!1)}})();let{data:{subscription:e}}=o.OQ.auth.onAuthStateChange(async(e,r)=>{var t;s(null!==(t=null==r?void 0:r.user)&&void 0!==t?t:null),(null==r?void 0:r.user)&&"SIGNED_IN"===e?setTimeout(()=>{y(r.user.id)},0):"SIGNED_OUT"===e&&(a(null),f(null),h(null)),"INITIAL_SESSION"!==e&&p(!1)});return()=>e.unsubscribe()},[]);let y=async e=>{if(m.current!==e){m.current=e;try{let{data:r,error:t}=await o.OQ.from("users").select("*").eq("auth_user_id",e).single();if(t&&"PGRST116"!==t.code){console.error("Error fetching user profile:",t);return}if(a(r),r){let{data:e,error:t}=await o.OQ.from("memberships").select("role, org_id").eq("user_id",r.id).single();if(t&&"PGRST116"!==t.code){console.error("Error fetching user role:",t);return}if(f((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:r,error:t}=await o.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();t?(console.error("Error fetching organization:",t),h(null)):h({id:r.id,name:r.name})}else h(null)}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{m.current=null,p(!1)}}},v=async(e,r)=>{p(!0);try{let t=o.OQ.auth.signInWithPassword({email:e,password:r}),n=new Promise((e,r)=>{setTimeout(()=>r(Error("認証タイムアウト（30秒）")),3e4)}),{data:i,error:l}=await Promise.race([t,n]);if(l)throw l;(null==i?void 0:i.user)&&setTimeout(()=>{y(i.user.id)},50)}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{p(!1)}},w=async(e,r,t)=>{p(!0);try{let{data:n,error:i}=await o.OQ.auth.signUp({email:e,password:r,options:{data:{display_name:t.display_name,specialties:t.specialties||[],qualifications:t.qualifications||[]}}});if(i)throw i;if(n.user){let{error:e}=await o.OQ.from("users").insert({auth_user_id:n.user.id,email:n.user.email,display_name:t.display_name||"",specialties:t.specialties||[],qualifications:t.qualifications||[],experience_years:t.experience_years});e&&console.error("Error creating user profile:",e)}}finally{p(!1)}},I=async()=>{p(!0);try{let{error:e}=await o.OQ.auth.signOut();if(e)throw e;s(null),a(null),f(null)}finally{p(!1)}},O=async e=>{if(!u)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{let{data:r,error:t}=await o.OQ.from("users").update(e).eq("id",u.id).select().single();if(t)throw console.error("updateProfile: Supabaseエラー",t),t;a({...u,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,n.jsx)(l.Provider,{value:{user:t,userProfile:u,userRole:c,userOrganization:d,loading:_,signIn:v,signUp:w,signOut:I,updateProfile:O,getRedirectPath:()=>{if(!c)return"/dashboard";switch(c){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:r})}},14958:function(e,r,t){"use strict";t.d(r,{OQ:function(){return i}});var n=t(37440);t(62601);let i=(0,n.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},63385:function(){},99646:function(e){e.exports={style:{fontFamily:"'__Inter_f367f3', '__Inter_Fallback_f367f3'",fontStyle:"normal"},className:"__className_f367f3"}},30622:function(e,r,t){"use strict";var n=t(2265),i=Symbol.for("react.element"),o=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function a(e,r,t){var n,o={},a=null,c=null;for(n in void 0!==t&&(a=""+t),void 0!==r.key&&(a=""+r.key),void 0!==r.ref&&(c=r.ref),r)l.call(r,n)&&!u.hasOwnProperty(n)&&(o[n]=r[n]);if(e&&e.defaultProps)for(n in r=e.defaultProps)void 0===o[n]&&(o[n]=r[n]);return{$$typeof:i,type:e,key:a,ref:c,props:o,_owner:s.current}}r.Fragment=o,r.jsx=a,r.jsxs=a},57437:function(e,r,t){"use strict";e.exports=t(30622)}},function(e){e.O(0,[440,971,938,744],function(){return e(e.s=15457)}),_N_E=e.O()}]);