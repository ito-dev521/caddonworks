(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[913],{28203:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(62898).Z)("Calendar",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}]])},6141:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(62898).Z)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},99670:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(62898).Z)("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]])},86264:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(62898).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},2882:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,s(62898).Z)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]])},99742:function(e,t,s){Promise.resolve().then(s.bind(s,3086))},3086:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return S}});var a=s(57437),n=s(2265),r=s(65251),i=s(11981),c=s(76637),l=s(28203),o=s(99670),d=s(2882),x=s(6141),m=s(55340),h=s(575),u=s(15671),g=s(33277),j=s(66210),p=s(7403),y=s(65592),b=s(24033),f=s(14958),N=s(22169);let v=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)("textarea",{className:(0,N.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:t,...n})});v.displayName="Textarea";let w=[{key:"deadline_score",label:"納期",description:"約束した納期を守れていたか"},{key:"quality_score",label:"成果品の質",description:"提出された成果品の品質は満足できるものだったか"},{key:"communication_score",label:"コミュニケーション",description:"連絡や報告は適切で分かりやすかったか"},{key:"understanding_score",label:"理解度",description:"要求事項を正しく理解し対応できていたか"},{key:"professionalism_score",label:"プロフェッショナリズム",description:"専門性と責任感を持って業務に取り組んでいたか"}];function _(e){let{projectId:t,contractId:s,contractorId:i,contractorName:c,onSuccess:l,onCancel:o}=e,[d,x]=(0,n.useState)({deadline_score:0,quality_score:0,communication_score:0,understanding_score:0,professionalism_score:0,comment:""}),[g,j]=(0,n.useState)(!1),[p,y]=(0,n.useState)(""),b=(e,t)=>{x(s=>({...s,[e]:t}))},N=e=>{x(t=>({...t,comment:e}))},_=()=>d.deadline_score>0&&d.quality_score>0&&d.communication_score>0&&d.understanding_score>0&&d.professionalism_score>0,k=async()=>{if(!_()){y("すべての評価項目を選択してください");return}j(!0),y("");try{let{data:{session:e}}=await f.OQ.auth.getSession();if(!e){y("認証が必要です。ログインし直してください。"),j(!1);return}let a={project_id:t,contract_id:s,contractor_id:i,...d},n=await fetch("/api/evaluations/contractor",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e.access_token)},body:JSON.stringify(a)}),r=await n.json();n.ok?l():y(r.message||"評価の保存に失敗しました")}catch(e){console.error("評価送信エラー:",e),y("ネットワークエラーが発生しました")}finally{j(!1)}},S=e=>{let{score:t,onScoreChange:s,label:n,description:r}=e;return(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:n}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:r})]}),(0,a.jsxs)("div",{className:"flex gap-1",children:[[1,2,3,4,5].map(e=>(0,a.jsx)("button",{type:"button",onClick:()=>s(e),className:"focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded",children:(0,a.jsx)(m.Z,{className:"w-6 h-6 transition-colors ".concat(e<=t?"text-yellow-400 fill-yellow-400":"text-gray-300 hover:text-yellow-200")})},e)),(0,a.jsx)("span",{className:"ml-2 text-sm text-gray-600",children:t>0?"".concat(t,"/5"):"未評価"})]})]})};return(0,a.jsx)(r.E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)(u.Zb,{className:"w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(u.Ol,{children:[(0,a.jsx)(u.ll,{className:"text-xl font-bold text-gray-900",children:"受注者評価"}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:[c," さんへの評価をお願いします"]})]}),(0,a.jsxs)(u.aY,{className:"space-y-6",children:[p&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:(0,a.jsx)("p",{className:"text-sm text-red-600",children:p})}),(0,a.jsx)("div",{className:"space-y-6",children:w.map(e=>(0,a.jsx)(S,{score:d[e.key],onScoreChange:t=>b(e.key,t),label:e.label,description:e.description},e.key))}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"コメント（任意）"}),(0,a.jsx)(v,{value:d.comment,onChange:e=>N(e.target.value),placeholder:"受注者へのコメントがあれば記入してください...",rows:4,className:"resize-none"})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200",children:[(0,a.jsx)(h.z,{variant:"outline",onClick:o,disabled:g,children:"キャンセル"}),(0,a.jsx)(h.z,{onClick:k,disabled:!_()||g,className:"bg-blue-600 hover:bg-blue-700",children:g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"送信中..."]}):"評価を送信"})]})]})]})})}function k(){let{userProfile:e,userRole:t}=(0,j.useAuth)(),s=(0,b.useRouter)(),[p,N]=(0,n.useState)([]),[v,w]=(0,n.useState)([]),[k,S]=(0,n.useState)([]),[C,z]=(0,n.useState)([]),[A,Z]=(0,n.useState)(!0),[O,D]=(0,n.useState)(null),[P,L]=(0,n.useState)("signed"),J=(0,n.useRef)(null),[I,T]=(0,n.useState)(!1),[R,E]=(0,n.useState)(null),[B,F]=(0,n.useState)(new Set),[M,Q]=(0,n.useState)(new Set),[q,V]=(0,n.useState)(new Map),G=async()=>{try{Z(!0);let{data:{session:e},error:t}=await f.OQ.auth.getSession();if(t||!e){console.error("セッション取得エラー:",t),D("認証が必要です");return}let s=await fetch("/api/contracts",{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}}),a=await s.json();if(s.ok){let e=a.contracts||[];if(0===e.length)N([]),w([]);else{let t=e.filter(e=>"signed"===e.status||"completed"===e.status),s=e.filter(e=>"pending_contractor"===e.status||"pending_org"===e.status);N(t),w(s)}}else console.error("契約取得エラー:",a.message),D(a.message||"契約データの取得に失敗しました")}catch(e){console.error("契約取得エラー:",e),D("サーバーエラーが発生しました")}finally{Z(!1)}},U=async()=>{try{let{data:{session:e},error:t}=await f.OQ.auth.getSession();if(t||!e){console.error("セッション取得エラー:",t);return}let[s,a]=await Promise.all([fetch("/api/projects?status=completed",{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}}),fetch("/api/contracts",{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}})]);if(s.ok&&a.ok){let[e,t]=await Promise.all([s.json(),a.json()]),n=e.projects||[],r=t.contracts||[];S(n),await X(n,r)}}catch(e){console.error("完了案件取得エラー:",e)}},Y=async()=>{try{let{data:{session:e},error:t}=await f.OQ.auth.getSession();if(t||!e){console.error("セッション取得エラー:",t);return}let s=await fetch("/api/invoices",{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}});if(s.ok){let e=await s.json();z(e.invoices||[])}}catch(e){console.error("請求書取得エラー:",e)}};(0,n.useEffect)(()=>{if(!e||!t){Z(!1);return}let s="".concat(e.id,":").concat(t);J.current!==s&&(J.current=s,G(),"OrgAdmin"===t?U():"Contractor"===t&&Y())},[e,t]);let H=async e=>{try{let{data:{session:t},error:s}=await f.OQ.auth.getSession();if(s||!t){console.error("セッション取得エラー:",s),D("認証が必要です");return}let a=await fetch("/api/contracts/".concat(e,"/sign"),{method:"POST",headers:{Authorization:"Bearer ".concat(t.access_token),"Content-Type":"application/json"}}),n=await a.json();a.ok?await G():D(n.message||"契約の署名に失敗しました")}catch(e){console.error("契約署名エラー:",e),D("サーバーエラーが発生しました")}},W=async e=>{try{let{data:{session:t},error:s}=await f.OQ.auth.getSession();if(s||!t){console.error("セッション取得エラー:",s),alert("認証が必要です");return}let a=await fetch("/api/invoices",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t.access_token)},body:JSON.stringify({project_id:e,type:"completion"})}),n=await a.json();a.ok?(alert("業務完了届が作成されました。受注者に通知が送信されます。"),await U()):alert("業務完了届作成に失敗しました: "+n.message)}catch(e){console.error("業務完了届作成エラー:",e),alert("ネットワークエラーが発生しました")}},K=e=>{if(B.has(e.id)){alert("この案件は既に評価済みです。");return}let t=p.find(t=>t.project_id===e.id);t&&(E({projectId:e.id,contractId:t.id,contractorId:e.contractor_id,contractorName:e.contractor_name||"受注者"}),T(!0))},X=async(e,t)=>{try{let{data:{session:s},error:a}=await f.OQ.auth.getSession();if(a){console.error("セッション取得エラー:",a);return}if(!s)return;let n=new Set,r=new Set,i=new Map,c=e.map(async e=>{let a=t.find(t=>t.project_id===e.id),c=null;try{c=await fetch("/api/evaluations/contractor?contractor_id=".concat(e.contractor_id,"&project_id=").concat(e.id),{headers:{Authorization:"Bearer ".concat(s.access_token)}})}catch(t){console.error("プロジェクト ".concat(e.id," の評価データ取得でエラー:"),t),c=null}let l=null;if(a)try{l=await fetch("/api/invoices/contract/".concat(a.id),{headers:{Authorization:"Bearer ".concat(s.access_token)}})}catch(t){console.error("プロジェクト ".concat(e.id," の請求書取得でネットワークエラー:"),t),l=null}if(c&&c.ok){let t=await c.json();t.evaluations&&t.evaluations.length>0&&n.add(e.id)}else c&&console.error("プロジェクト ".concat(e.id," の評価データ取得エラー:"),c.status,c.statusText);if(l&&l.ok){let t=await l.json();t.invoice&&(r.add(e.id),i.set(e.id,t.invoice))}else l&&console.error("プロジェクト ".concat(e.id," の請求書取得エラー:"),l.status,l.statusText)});await Promise.all(c),F(n),Q(r),V(i)}catch(e){console.error("プロジェクト状態確認エラー:",e)}};return A?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-engineering-blue mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-gray-600",children:"データを読み込み中..."})]})}):e&&t?O?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center bg-white p-8 rounded-lg shadow-xl max-w-md",children:[(0,a.jsx)(i.Z,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:O}),(0,a.jsx)(h.z,{onClick:G,variant:"engineering",children:"再試行"})]})}):(0,a.jsxs)("div",{className:"min-h-screen bg-gradient-mesh",children:[(0,a.jsx)(y.W,{}),(0,a.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,a.jsxs)(r.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-6xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"契約管理"}),(0,a.jsx)("p",{className:"text-gray-600",children:"OrgAdmin"===t?"発注者としての契約一覧":"受注者としての契約一覧"})]}),(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)("div",{className:"border-b border-gray-200",children:(0,a.jsxs)("nav",{className:"-mb-px flex space-x-8",children:[(0,a.jsxs)("button",{onClick:()=>L("signed"),className:"py-2 px-1 border-b-2 font-medium text-sm ".concat("signed"===P?"border-engineering-blue text-engineering-blue":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:["署名済み契約",p.length>0&&(0,a.jsx)("span",{className:"ml-2 bg-engineering-blue text-white text-xs px-2 py-1 rounded-full",children:p.length})]}),(0,a.jsxs)("button",{onClick:()=>L("pending"),className:"py-2 px-1 border-b-2 font-medium text-sm ".concat("pending"===P?"border-engineering-blue text-engineering-blue":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:["署名待ち契約",v.length>0&&(0,a.jsx)("span",{className:"ml-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full",children:v.length})]}),(0,a.jsxs)("button",{onClick:()=>L("invoices"),className:"py-2 px-1 border-b-2 font-medium text-sm ".concat("invoices"===P?"border-engineering-blue text-engineering-blue":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:["OrgAdmin"===t?"業務完了届発行":"請求書","OrgAdmin"===t&&k.length>0&&(0,a.jsx)("span",{className:"ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full",children:k.length}),"Contractor"===t&&C.length>0&&(0,a.jsx)("span",{className:"ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full",children:C.length})]})]})})}),"signed"===P&&(0===p.length?(0,a.jsxs)(u.Zb,{className:"p-8 text-center",children:[(0,a.jsx)(c.Z,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"署名済み契約がありません"}),(0,a.jsx)("p",{className:"text-gray-600",children:"まだ署名済みの契約がありません。"})]}):(0,a.jsx)("div",{className:"space-y-8",children:Object.values(p.reduce((e,t)=>{let s=new Date(t.created_at),a="".concat(s.getFullYear(),"-").concat(String(s.getMonth()+1).padStart(2,"0"));return e[a]||(e[a]={monthName:s.toLocaleDateString("ja-JP",{year:"numeric",month:"long"}),contracts:[]}),e[a].contracts.push(t),e},{})).sort((e,t)=>t.monthName.localeCompare(e.monthName)).map((e,n)=>(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[(0,a.jsx)(l.Z,{className:"w-5 h-5 mr-2"}),e.monthName,(0,a.jsxs)("span",{className:"ml-2 text-sm font-normal text-gray-500",children:["(",e.contracts.length,"件)"]})]}),(0,a.jsx)("div",{className:"grid gap-4",children:e.contracts.map(e=>(0,a.jsx)(r.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:(0,a.jsxs)(u.Zb,{className:"p-6 border-l-4 border-l-green-500",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:e.project_title}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["契約ID: ",e.id.slice(0,8).toUpperCase()]}),(0,a.jsx)(g.C,{variant:"default",className:"bg-green-100 text-green-800",children:"署名完了"})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("p",{className:"text-2xl font-bold text-engineering-blue",children:["\xa5",e.bid_amount.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["署名日: ",e.signed_at?new Date(e.signed_at).toLocaleDateString("ja-JP"):"不明"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("span",{className:"text-gray-600",children:["OrgAdmin"===t?"受注者":"発注者",":"]}),(0,a.jsx)("p",{className:"font-medium text-gray-900",children:"OrgAdmin"===t?e.contractor_name:e.org_name})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"契約期間:"}),(0,a.jsxs)("p",{className:"text-gray-900",children:[new Date(e.start_date).toLocaleDateString("ja-JP")," - ",new Date(e.end_date).toLocaleDateString("ja-JP")]})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>s.push("/contracts/".concat(e.id)),children:[(0,a.jsx)(o.Z,{className:"w-4 h-4 mr-2"}),"詳細表示"]}),(0,a.jsxs)(h.z,{variant:"engineering",size:"sm",onClick:()=>s.push("/chat?contractId=".concat(e.id)),children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 mr-2"}),"チャット開始"]})]})]})},e.id))})]},n))})),"pending"===P&&(0===v.length?(0,a.jsxs)(u.Zb,{className:"p-8 text-center",children:[(0,a.jsx)(x.Z,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"署名待ち契約がありません"}),(0,a.jsx)("p",{className:"text-gray-600",children:"現在署名待ちの契約はありません。"})]}):(0,a.jsx)("div",{className:"space-y-6",children:v.map(e=>(0,a.jsx)(r.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:(0,a.jsxs)(u.Zb,{className:"p-6 border-l-4 border-l-yellow-500",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:e.project_title}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["契約ID: ",e.id.slice(0,8).toUpperCase()]}),(0,a.jsx)(g.C,{variant:"outline",className:"bg-yellow-50 text-yellow-700 border-yellow-300",children:"署名待ち"})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("p",{className:"text-2xl font-bold text-engineering-blue",children:["\xa5",e.bid_amount.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["作成日: ",new Date(e.created_at).toLocaleDateString("ja-JP")]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("span",{className:"text-gray-600",children:["OrgAdmin"===t?"受注者":"発注者",":"]}),(0,a.jsx)("p",{className:"font-medium text-gray-900",children:"OrgAdmin"===t?e.contractor_name:e.org_name})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"契約期間:"}),(0,a.jsxs)("p",{className:"text-gray-900",children:[new Date(e.start_date).toLocaleDateString("ja-JP")," - ",new Date(e.end_date).toLocaleDateString("ja-JP")]})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>s.push("/contracts/".concat(e.id)),children:[(0,a.jsx)(o.Z,{className:"w-4 h-4 mr-2"}),"詳細表示"]}),(0,a.jsxs)("div",{className:"flex gap-2",children:["pending_contractor"===e.status&&"Contractor"===t&&(0,a.jsx)(h.z,{onClick:()=>H(e.id),variant:"engineering",size:"sm",children:"署名する"}),"pending_org"===e.status&&"OrgAdmin"===t&&(0,a.jsx)(h.z,{onClick:()=>H(e.id),variant:"engineering",size:"sm",children:"署名する"})]})]}),(0,a.jsx)("div",{className:"border-t pt-4 mt-4",children:(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"発注者署名:"}),(0,a.jsx)("span",{className:"ml-2 ".concat(e.org_signed_at?"text-green-600":"text-gray-400"),children:e.org_signed_at?new Date(e.org_signed_at).toLocaleString("ja-JP"):"未署名"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"受注者署名:"}),(0,a.jsx)("span",{className:"ml-2 ".concat(e.contractor_signed_at?"text-green-600":"text-gray-400"),children:e.contractor_signed_at?new Date(e.contractor_signed_at).toLocaleString("ja-JP"):"未署名"})]})]})})]})},e.id))})),"invoices"===P&&("OrgAdmin"===t?0===k.length?(0,a.jsxs)(u.Zb,{className:"p-8 text-center",children:[(0,a.jsx)(c.Z,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"完了案件がありません"}),(0,a.jsx)("p",{className:"text-gray-600",children:"業務完了届発行可能な完了案件がありません。"})]}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,a.jsx)("h3",{className:"font-semibold text-blue-900 mb-2",children:"業務完了届発行について"}),(0,a.jsx)("p",{className:"text-sm text-blue-800",children:"完了した案件の業務完了届を発行できます。業務完了届は受注者に送信され、PDF形式でダウンロードも可能です。"})]}),(0,a.jsx)("div",{className:"grid gap-4",children:k.map(e=>(0,a.jsx)(u.Zb,{className:"p-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:e.title}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"受注者:"})," ",e.contractor_name]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"完了日:"})," ",new Date(e.end_date).toLocaleDateString("ja-JP")]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"契約金額:"})," \xa5",e.budget.toLocaleString()]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"カテゴリ:"})," ",e.category]})]}),(0,a.jsx)(g.C,{className:"bg-green-100 text-green-800",children:"完了済み"})]}),(0,a.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>K(e),disabled:B.has(e.id),className:B.has(e.id)?"bg-green-50 border-green-200 text-green-800 opacity-75 cursor-not-allowed":"bg-yellow-50 border-yellow-200 text-yellow-800 hover:bg-yellow-100",title:B.has(e.id)?"評価済み":"受注者を評価する",children:[(0,a.jsx)(m.Z,{className:"w-4 h-4 mr-2"}),B.has(e.id)?"評価済み":"受注者評価"]}),(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>W(e.id),disabled:!B.has(e.id)||M.has(e.id),className:M.has(e.id)?"bg-green-50 border-green-200 text-green-800 opacity-75 cursor-not-allowed":B.has(e.id)?"":"opacity-50 cursor-not-allowed",title:M.has(e.id)?"業務完了届作成済み":B.has(e.id)?"業務完了届を作成する":"受注者評価を完了してから業務完了届を作成してください",children:[(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-2"}),M.has(e.id)?"作成済み":"業務完了届作成"]}),(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>{let t=p.find(t=>t.project_id===e.id);t?s.push("/contracts/".concat(t.id)):alert("この案件の契約情報が見つかりません")},children:[(0,a.jsx)(o.Z,{className:"w-4 h-4 mr-2"}),"詳細"]})]})]})},e.id))})]}):0===C.length?(0,a.jsxs)(u.Zb,{className:"p-8 text-center",children:[(0,a.jsx)(c.Z,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"請求書がありません"}),(0,a.jsx)("p",{className:"text-gray-600",children:"まだ請求書が発行されていません。"})]}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,a.jsx)("h3",{className:"font-semibold text-green-900 mb-2",children:"請求書について"}),(0,a.jsx)("p",{className:"text-sm text-green-800",children:"発注者から発行された請求書の一覧です。支払い状況を確認し、PDF形式でダウンロードできます。"})]}),(0,a.jsx)("div",{className:"grid gap-4",children:C.map(e=>(0,a.jsx)(u.Zb,{className:"p-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-gray-900",children:["請求書番号: ",e.invoice_number]}),(0,a.jsx)(g.C,{className:"paid"===e.status?"bg-green-100 text-green-800":"overdue"===e.status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800",children:"paid"===e.status?"支払済み":"overdue"===e.status?"支払期限超過":"sent"===e.status?"送信済み":"発行済み"})]}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:e.description}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"発行日:"})," ",new Date(e.issue_date).toLocaleDateString("ja-JP")]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"支払期限:"})," ",new Date(e.due_date).toLocaleDateString("ja-JP")]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"税抜金額:"})," \xa5",e.amount.toLocaleString()]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"税込金額:"})," \xa5",e.total_amount.toLocaleString()]})]}),e.paid_date&&(0,a.jsxs)("div",{className:"text-sm text-green-600 mb-2",children:["支払完了日: ",new Date(e.paid_date).toLocaleDateString("ja-JP")]})]}),(0,a.jsx)("div",{className:"flex gap-2 ml-4",children:(0,a.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>{alert("PDF生成機能は準備中です")},children:[(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-2"}),"PDF表示"]})})]})},e.id))})]}))]})}),I&&R&&(0,a.jsx)(_,{projectId:R.projectId,contractId:R.contractId,contractorId:R.contractorId,contractorName:R.contractorName,onSuccess:()=>{R&&F(e=>new Set(Array.from(e).concat(R.projectId))),T(!1),E(null),alert("評価が完了しました。業務完了届を作成できます。")},onCancel:()=>{T(!1),E(null)}})]}):(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center bg-white p-8 rounded-lg shadow-xl max-w-md",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログインが必要です"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"契約管理ページにアクセスするにはログインしてください。"}),(0,a.jsx)(h.z,{onClick:()=>window.location.href="/auth/login",variant:"engineering",children:"ログインページへ"})]})})}function S(){return(0,a.jsx)(p.AuthGuard,{allowedRoles:["OrgAdmin","Contractor"],children:(0,a.jsx)(k,{})})}},7403:function(e,t,s){"use strict";s.r(t),s.d(t,{AuthGuard:function(){return o},useRoleAccess:function(){return x},withAuth:function(){return d}});var a=s(57437),n=s(2265),r=s(24033),i=s(65251),c=s(86264),l=s(66210);function o(e){let{children:t,requiredRole:s,allowedRoles:o,redirectTo:d="/auth/login"}=e,{user:x,userRole:m,loading:h}=(0,l.useAuth)(),u=(0,r.useRouter)(),g=(0,r.usePathname)(),j=(0,n.useRef)(!1);return((0,n.useEffect)(()=>{if(!h&&!j.current){if(!x){sessionStorage.setItem("redirectAfterLogin",g),g!==d&&(j.current=!0,u.push(d));return}if(s&&m!==s||o&&o.length>0&&(!m||!o.includes(m))){"/unauthorized"!==g&&(j.current=!0,u.push("/unauthorized"));return}}},[x,m,h,s,o,u,d,g]),h)?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,a.jsxs)(i.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-engineering-blue rounded-xl flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(c.Z,{className:"w-8 h-8 text-white animate-spin"})}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"認証確認中..."}),(0,a.jsx)("p",{className:"text-gray-600",children:"しばらくお待ちください"})]})}):!x||s&&m!==s||o&&o.length>0&&(!m||!o.includes(m))?null:(0,a.jsx)(a.Fragment,{children:t})}function d(e,t){return function(s){return(0,a.jsx)(o,{requiredRole:t,children:(0,a.jsx)(e,{...s})})}}function x(){let{userRole:e}=(0,l.useAuth)(),t=t=>e===t,s=t=>!!e&&t.includes(e);return{hasRole:t,hasAnyRole:s,isAdmin:()=>t("OrgAdmin"),isStaff:()=>t("Staff"),isContractor:()=>t("Contractor"),isReviewer:()=>t("Reviewer"),isAuditor:()=>t("Auditor"),canManageProjects:()=>s(["OrgAdmin","Staff"]),canViewFinancials:()=>s(["OrgAdmin","Staff","Auditor"]),canReviewProjects:()=>s(["Reviewer","OrgAdmin"]),canViewAuditLogs:()=>s(["Auditor","OrgAdmin"])}}}},function(e){e.O(0,[778,402,440,250,677,650,971,938,744],function(){return e(e.s=99742)}),_N_E=e.O()}]);