(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[153],{11981:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},73067:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},13008:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},41298:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]])},76637:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]])},86264:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(62898).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},35260:function(e,t,r){Promise.resolve().then(r.bind(r,63850))},63850:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return y}});var n=r(57437),s=r(2265),a=r(65251),i=r(11981),l=r(73067),c=r(76637),o=r(41298),d=r(13008),u=r(575),x=r(15671),h=r(33277),m=r(66210),g=r(7403),f=r(24033),p=r(14958);function b(){let{userProfile:e,userRole:t}=(0,m.useAuth)(),r=(0,f.useRouter)(),g=(0,f.useSearchParams)(),b=g.get("projectId"),y=g.get("bidId"),[j,v]=(0,s.useState)(null),[w,N]=(0,s.useState)(null),[_,k]=(0,s.useState)(!0),[C,S]=(0,s.useState)(null),[A,D]=(0,s.useState)(!1),O=async()=>{if(!b||!y){console.error("契約作成ページ: パラメータ不足",{projectId:b,bidId:y}),S("案件IDまたは入札IDが指定されていません"),k(!1);return}try{k(!0);let{data:{session:e},error:t}=await p.OQ.auth.getSession();if(t||!e){console.error("セッション取得エラー:",t),S("認証が必要です");return}let r=await fetch("/api/projects/".concat(b),{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}});if(r.ok){let e=await r.json();v(e.project)}else{let e=await r.json();console.error("契約作成ページ: 案件取得エラー",{status:r.status,error:e}),S("案件の取得に失敗しました: ".concat(e.message||"不明なエラー"));return}let n=await fetch("/api/bids/".concat(y),{headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}});if(n.ok){let e=await n.json();N(e.bid)}else{let e=await n.json();console.error("契約作成ページ: 入札取得エラー",{status:n.status,error:e}),S("入札情報の取得に失敗しました: ".concat(e.message||"不明なエラー"));return}}catch(e){console.error("データ取得エラー:",e),S("データの取得に失敗しました")}finally{k(!1)}};(0,s.useEffect)(()=>{e&&t&&b&&y&&O()},[e,t,b,y]);let I=async()=>{if(!j||!w){S("案件または入札情報が見つかりません");return}try{D(!0);let{data:{session:e},error:t}=await p.OQ.auth.getSession();if(t||!e){console.error("セッション取得エラー:",t),S("認証が必要です");return}let n=await fetch("/api/contracts",{method:"POST",headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"},body:JSON.stringify({project_id:j.id,bid_id:w.id,contract_amount:w.bid_amount,start_date:j.start_date,end_date:j.end_date,contractor_id:w.contractor_id,org_id:j.org_id})}),s=await n.json();n.ok?r.push("/contracts"):S(s.message||"契約の作成に失敗しました")}catch(e){console.error("契約作成エラー:",e),S("サーバーエラーが発生しました")}finally{D(!1)}};return _?(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-engineering-blue mx-auto mb-4"}),(0,n.jsx)("p",{className:"text-gray-600",children:"認証確認中..."})]})}):e&&t?C?(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center bg-white p-8 rounded-lg shadow-xl max-w-md",children:[(0,n.jsx)(i.Z,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"エラーが発生しました"}),(0,n.jsx)("p",{className:"text-gray-600 mb-4",children:C}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(u.z,{onClick:O,variant:"engineering",children:"再試行"}),(0,n.jsx)(u.z,{onClick:()=>r.push("/projects"),variant:"outline",children:"案件一覧に戻る"})]})]})}):j&&w?(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh",children:(0,n.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,n.jsxs)(a.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-4xl mx-auto",children:[(0,n.jsxs)("div",{className:"mb-8",children:[(0,n.jsxs)(u.z,{variant:"ghost",onClick:()=>r.push("/projects"),className:"mb-4",children:[(0,n.jsx)(l.Z,{className:"w-4 h-4 mr-2"}),"案件一覧に戻る"]}),(0,n.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"契約書作成"}),(0,n.jsx)("p",{className:"text-gray-600",children:"入札を承認して契約書を作成します"})]}),(0,n.jsxs)("div",{className:"grid gap-6",children:[(0,n.jsxs)(x.Zb,{className:"p-6",children:[(0,n.jsxs)("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[(0,n.jsx)(c.Z,{className:"w-5 h-5 mr-2"}),"案件情報"]}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"案件名:"}),(0,n.jsx)("p",{className:"font-medium text-gray-900",children:j.title})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"説明:"}),(0,n.jsx)("p",{className:"text-gray-900",children:j.description})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"予算:"}),(0,n.jsxs)("p",{className:"font-medium text-gray-900",children:["\xa5",j.budget.toLocaleString()]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"カテゴリ:"}),(0,n.jsx)("p",{className:"text-gray-900",children:j.category})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"開始日:"}),(0,n.jsx)("p",{className:"text-gray-900",children:new Date(j.start_date).toLocaleDateString("ja-JP")})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"終了日:"}),(0,n.jsx)("p",{className:"text-gray-900",children:new Date(j.end_date).toLocaleDateString("ja-JP")})]})]})]})]}),(0,n.jsxs)(x.Zb,{className:"p-6",children:[(0,n.jsxs)("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[(0,n.jsx)(o.Z,{className:"w-5 h-5 mr-2"}),"入札情報"]}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"受注者:"}),(0,n.jsx)("p",{className:"font-medium text-gray-900",children:w.contractor_name})]}),(0,n.jsx)(h.C,{variant:"default",className:"bg-green-100 text-green-800",children:"承認済み"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"入札金額:"}),(0,n.jsxs)("p",{className:"text-2xl font-bold text-engineering-blue",children:["\xa5",w.bid_amount.toLocaleString()]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"入札メッセージ:"}),(0,n.jsx)("p",{className:"text-gray-900 bg-gray-50 p-3 rounded-lg",children:w.message})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"text-sm text-gray-600",children:"入札日時:"}),(0,n.jsx)("p",{className:"text-gray-900",children:new Date(w.created_at).toLocaleString("ja-JP")})]})]})]}),(0,n.jsxs)(x.Zb,{className:"p-6",children:[(0,n.jsxs)("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[(0,n.jsx)(d.Z,{className:"w-5 h-5 mr-2"}),"契約内容確認"]}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,n.jsx)("h3",{className:"font-semibold text-blue-900 mb-2",children:"契約条件"}),(0,n.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{className:"text-blue-700",children:"契約金額:"}),(0,n.jsxs)("span",{className:"font-medium text-blue-900",children:["\xa5",w.bid_amount.toLocaleString()]})]}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{className:"text-blue-700",children:"契約期間:"}),(0,n.jsxs)("span",{className:"text-blue-900",children:[new Date(j.start_date).toLocaleDateString("ja-JP")," - ",new Date(j.end_date).toLocaleDateString("ja-JP")]})]}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{className:"text-blue-700",children:"受注者:"}),(0,n.jsx)("span",{className:"text-blue-900",children:w.contractor_name})]})]})]}),(0,n.jsxs)("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[(0,n.jsx)("h3",{className:"font-semibold text-yellow-900 mb-2",children:"注意事項"}),(0,n.jsxs)("ul",{className:"text-sm text-yellow-800 space-y-1",children:[(0,n.jsx)("li",{children:"• 契約書を作成すると、受注者に通知が送信されます"}),(0,n.jsx)("li",{children:"• 受注者が署名すると契約が有効になります"}),(0,n.jsx)("li",{children:"• 契約金額は入札金額と同じになります"})]})]})]})]}),(0,n.jsxs)("div",{className:"flex justify-end gap-4",children:[(0,n.jsx)(u.z,{variant:"outline",onClick:()=>r.push("/projects"),disabled:A,children:"キャンセル"}),(0,n.jsx)(u.z,{onClick:I,disabled:A,variant:"engineering",className:"min-w-[120px]",children:A?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"作成中..."]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(c.Z,{className:"w-4 h-4 mr-2"}),"契約書を作成"]})})]})]})]})})}):(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center bg-white p-8 rounded-lg shadow-xl max-w-md",children:[(0,n.jsx)(i.Z,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"データが見つかりません"}),(0,n.jsx)("p",{className:"text-gray-600 mb-4",children:"案件または入札情報が見つかりません。"}),(0,n.jsx)(u.z,{onClick:()=>r.push("/projects"),variant:"engineering",children:"案件一覧に戻る"})]})}):(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center bg-white p-8 rounded-lg shadow-xl max-w-md",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"ログインが必要です"}),(0,n.jsx)("p",{className:"text-gray-600 mb-4",children:"契約作成ページにアクセスするにはログインしてください。"}),(0,n.jsx)(u.z,{onClick:()=>window.location.href="/auth/login",variant:"engineering",children:"ログインページへ"})]})})}function y(){return(0,n.jsx)(g.AuthGuard,{requiredRole:"OrgAdmin",children:(0,n.jsx)(b,{})})}},7403:function(e,t,r){"use strict";r.r(t),r.d(t,{AuthGuard:function(){return o},useRoleAccess:function(){return u},withAuth:function(){return d}});var n=r(57437),s=r(2265),a=r(24033),i=r(65251),l=r(86264),c=r(66210);function o(e){let{children:t,requiredRole:r,allowedRoles:o,redirectTo:d="/auth/login"}=e,{user:u,userRole:x,loading:h}=(0,c.useAuth)(),m=(0,a.useRouter)(),g=(0,a.usePathname)(),f=(0,s.useRef)(!1);return((0,s.useEffect)(()=>{if(!h&&!f.current){if(!u){sessionStorage.setItem("redirectAfterLogin",g),g!==d&&(f.current=!0,m.push(d));return}if(r&&x!==r||o&&o.length>0&&(!x||!o.includes(x))){"/unauthorized"!==g&&(f.current=!0,m.push("/unauthorized"));return}}},[u,x,h,r,o,m,d,g]),h)?(0,n.jsx)("div",{className:"min-h-screen bg-gradient-mesh flex items-center justify-center",children:(0,n.jsxs)(i.E.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"text-center",children:[(0,n.jsx)("div",{className:"w-16 h-16 bg-engineering-blue rounded-xl flex items-center justify-center mx-auto mb-4",children:(0,n.jsx)(l.Z,{className:"w-8 h-8 text-white animate-spin"})}),(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"認証確認中..."}),(0,n.jsx)("p",{className:"text-gray-600",children:"しばらくお待ちください"})]})}):!u||r&&x!==r||o&&o.length>0&&(!x||!o.includes(x))?null:(0,n.jsx)(n.Fragment,{children:t})}function d(e,t){return function(r){return(0,n.jsx)(o,{requiredRole:t,children:(0,n.jsx)(e,{...r})})}}function u(){let{userRole:e}=(0,c.useAuth)(),t=t=>e===t,r=t=>!!e&&t.includes(e);return{hasRole:t,hasAnyRole:r,isAdmin:()=>t("OrgAdmin"),isStaff:()=>t("Staff"),isContractor:()=>t("Contractor"),isReviewer:()=>t("Reviewer"),isAuditor:()=>t("Auditor"),canManageProjects:()=>r(["OrgAdmin","Staff"]),canViewFinancials:()=>r(["OrgAdmin","Staff","Auditor"]),canReviewProjects:()=>r(["Reviewer","OrgAdmin"]),canViewAuditLogs:()=>r(["Auditor","OrgAdmin"])}}},33277:function(e,t,r){"use strict";r.d(t,{C:function(){return l}});var n=r(57437);r(2265);var s=r(96061),a=r(22169);let i=(0,s.j)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground",success:"border-transparent bg-green-500 text-white shadow hover:bg-green-600",warning:"border-transparent bg-yellow-500 text-white shadow hover:bg-yellow-600",info:"border-transparent bg-blue-500 text-white shadow hover:bg-blue-600",engineering:"border-engineering-blue bg-engineering-blue/10 text-engineering-blue",glass:"glass text-gray-700 border-white/30"}},defaultVariants:{variant:"default"}});function l(e){let{className:t,variant:r,...s}=e;return(0,n.jsx)("div",{className:(0,a.cn)(i({variant:r}),t),...s})}},575:function(e,t,r){"use strict";r.d(t,{z:function(){return o}});var n=r(57437),s=r(2265),a=r(54949),i=r(96061),l=r(22169);let c=(0,i.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline",engineering:"bg-engineering-blue text-white shadow-lg hover:bg-engineering-blue-dark hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300",gradient:"gradient-engineering text-white shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300",glass:"glass text-gray-900 hover:bg-white/20 border-white/30"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",xl:"h-12 rounded-lg px-10 text-base",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=s.forwardRef((e,t)=>{let{className:r,variant:s,size:i,asChild:o=!1,...d}=e,u=o?a.g7:"button";return(0,n.jsx)(u,{className:(0,l.cn)(c({variant:s,size:i,className:r})),ref:t,...d})});o.displayName="Button"},15671:function(e,t,r){"use strict";r.d(t,{Ol:function(){return l},SZ:function(){return o},Zb:function(){return i},aY:function(){return d},ll:function(){return c}});var n=r(57437),s=r(2265),a=r(22169);let i=s.forwardRef((e,t)=>{let{className:r,variant:s="default",...i}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("rounded-xl border bg-card text-card-foreground shadow-sm","glass"===s&&"glass backdrop-blur-md","gradient"===s&&"gradient-engineering text-white border-0","engineering"===s&&"border-engineering-blue/20 bg-gradient-to-br from-white to-engineering-blue/5 hover-lift",r),...i})});i.displayName="Card";let l=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("flex flex-col space-y-1.5 p-6",r),...s})});l.displayName="CardHeader";let c=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,n.jsx)("h3",{ref:t,className:(0,a.cn)("font-semibold leading-none tracking-tight",r),...s})});c.displayName="CardTitle";let o=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,n.jsx)("p",{ref:t,className:(0,a.cn)("text-sm text-muted-foreground",r),...s})});o.displayName="CardDescription";let d=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("p-6 pt-0",r),...s})});d.displayName="CardContent",s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("flex items-center p-6 pt-0",r),...s})}).displayName="CardFooter"},66210:function(e,t,r){"use strict";r.r(t),r.d(t,{AuthProvider:function(){return c},useAuth:function(){return l}});var n=r(57437),s=r(2265),a=r(14958);let i=(0,s.createContext)(void 0);function l(){let e=(0,s.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function c(e){let{children:t}=e,[r,l]=(0,s.useState)(null),[c,o]=(0,s.useState)(null),[d,u]=(0,s.useState)(null),[x,h]=(0,s.useState)(null),[m,g]=(0,s.useState)(!0),f=(0,s.useRef)(null);(0,s.useEffect)(()=>{(async()=>{try{var e;let{data:{session:t},error:r}=await a.OQ.auth.getSession();if(r){console.error("AuthProvider: セッション取得エラー:",r),g(!1);return}l(null!==(e=null==t?void 0:t.user)&&void 0!==e?e:null),(null==t?void 0:t.user)&&(null==t?void 0:t.access_token)?setTimeout(()=>{p(t.user.id)},0):g(!1)}catch(e){console.error("AuthProvider: 初期化エラー:",e),l(null),o(null),u(null),h(null),g(!1)}})();let{data:{subscription:e}}=a.OQ.auth.onAuthStateChange(async(e,t)=>{var r;l(null!==(r=null==t?void 0:t.user)&&void 0!==r?r:null),(null==t?void 0:t.user)&&"SIGNED_IN"===e?setTimeout(()=>{p(t.user.id)},0):"SIGNED_OUT"===e&&(o(null),u(null),h(null)),"INITIAL_SESSION"!==e&&g(!1)});return()=>e.unsubscribe()},[]);let p=async e=>{if(f.current!==e){f.current=e;try{let{data:t,error:r}=await a.OQ.from("users").select("*").eq("auth_user_id",e).single();if(r&&"PGRST116"!==r.code){console.error("Error fetching user profile:",r);return}if(o(t),t){let{data:e,error:r}=await a.OQ.from("memberships").select("role, org_id").eq("user_id",t.id).single();if(r&&"PGRST116"!==r.code){console.error("Error fetching user role:",r);return}if(u((null==e?void 0:e.role)||null),null==e?void 0:e.org_id){let{data:t,error:r}=await a.OQ.from("organizations").select("id, name").eq("id",e.org_id).single();r?(console.error("Error fetching organization:",r),h(null)):h({id:t.id,name:t.name})}else h(null)}}catch(e){console.error("Error in fetchUserProfile:",e)}finally{f.current=null,g(!1)}}},b=async(e,t)=>{g(!0);try{let r=a.OQ.auth.signInWithPassword({email:e,password:t}),n=new Promise((e,t)=>{setTimeout(()=>t(Error("認証タイムアウト（30秒）")),3e4)}),{data:s,error:i}=await Promise.race([r,n]);if(i)throw i;(null==s?void 0:s.user)&&setTimeout(()=>{p(s.user.id)},50)}catch(e){throw console.error("signIn: 認証エラー",e),e}finally{g(!1)}},y=async(e,t,r)=>{g(!0);try{let{data:n,error:s}=await a.OQ.auth.signUp({email:e,password:t,options:{data:{display_name:r.display_name,specialties:r.specialties||[],qualifications:r.qualifications||[]}}});if(s)throw s;if(n.user){let{error:e}=await a.OQ.from("users").insert({auth_user_id:n.user.id,email:n.user.email,display_name:r.display_name||"",specialties:r.specialties||[],qualifications:r.qualifications||[],experience_years:r.experience_years});e&&console.error("Error creating user profile:",e)}}finally{g(!1)}},j=async()=>{g(!0);try{let{error:e}=await a.OQ.auth.signOut();if(e)throw e;l(null),o(null),u(null)}finally{g(!1)}},v=async e=>{if(!c)throw console.error("updateProfile: userProfile is null"),Error("ユーザープロフィールが見つかりません");try{let{data:t,error:r}=await a.OQ.from("users").update(e).eq("id",c.id).select().single();if(r)throw console.error("updateProfile: Supabaseエラー",r),r;o({...c,...e})}catch(e){throw console.error("Error updating profile:",e),e}};return(0,n.jsx)(i.Provider,{value:{user:r,userProfile:c,userRole:d,userOrganization:x,loading:m,signIn:b,signUp:y,signOut:j,updateProfile:v,getRedirectPath:()=>{if(!d)return"/dashboard";switch(d){case"Contractor":return"/jobs";case"OrgAdmin":return"/projects";case"Reviewer":return"/reviews";default:return"/dashboard"}}},children:t})}},14958:function(e,t,r){"use strict";r.d(t,{OQ:function(){return s}});var n=r(37440);r(62601);let s=(0,n.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU")},22169:function(e,t,r){"use strict";r.d(t,{XO:function(){return c},cn:function(){return a},xG:function(){return i},z2:function(){return l}});var n=r(57042),s=r(74769);function a(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,s.m6)((0,n.W)(t))}function i(e){return new Intl.NumberFormat("ja-JP",{style:"currency",currency:"JPY"}).format(e)}function l(e){return({draft:"bg-gray-100 text-gray-800",bidding:"bg-blue-100 text-blue-800",contracted:"bg-green-100 text-green-800",in_progress:"bg-yellow-100 text-yellow-800",submitted:"bg-purple-100 text-purple-800",completed:"bg-emerald-100 text-emerald-800",cancelled:"bg-red-100 text-red-800"})[e]||"bg-gray-100 text-gray-800"}function c(e){return({draft:"\uD83D\uDCDD",bidding:"\uD83C\uDFD7️",contracted:"✅",in_progress:"⚡",submitted:"\uD83D\uDCCB",completed:"\uD83C\uDF89",cancelled:"❌"})[e]||"\uD83D\uDCC4"}},24033:function(e,t,r){e.exports=r(15313)}},function(e){e.O(0,[778,402,440,971,938,744],function(){return e(e.s=35260)}),_N_E=e.O()}]);