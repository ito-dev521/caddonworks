"use strict";(()=>{var e={};e.id=1996,e.ids=[1996],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},47345:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>j,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{GET:()=>c,PUT:()=>d});var a=r(95419),o=r(69108),i=r(99678),n=r(78070);let u=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function c(e){try{console.log("notifications API: リクエスト開始");let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),{data:{user:s},error:a}=await u.auth.getUser(r);if(a||!s)return console.error("notifications API: 認証エラー:",a),n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:i}=await u.from("users").select("id").eq("auth_user_id",s.id).single();if(i||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:c,error:d}=await u.from("notifications").select("*").eq("user_id",o.id).order("created_at",{ascending:!1}).limit(50);if(d)return console.error("notifications API: 通知取得エラー:",d),n.Z.json({message:"通知の取得に失敗しました"},{status:400});let{count:l,error:f}=await u.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",o.id).is("read_at",null);return f&&console.error("notifications API: 未読数取得エラー:",f),console.log("notifications API: 通知取得成功",{count:c?.length||0,unread:l||0}),n.Z.json({notifications:c||[],unreadCount:l||0},{status:200})}catch(e){return console.error("notifications API: サーバーエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function d(e){try{let{notificationId:t,action:r}=await e.json();if(!t||!r)return n.Z.json({message:"必須項目が入力されていません"},{status:400});let s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),{data:{user:o},error:i}=await u.auth.getUser(a);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:d}=await u.from("users").select("id").eq("auth_user_id",o.id).single();if(d||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let l={};if("mark_read"===r)l={read_at:new Date().toISOString()};else{if("mark_unread"!==r)return n.Z.json({message:"無効なアクションです"},{status:400});l={read_at:null}}let{data:f,error:p}=await u.from("notifications").update(l).eq("id",t).eq("user_id",c.id).select().single();if(p)return console.error("notifications API: 通知更新エラー:",p),n.Z.json({message:"通知の更新に失敗しました"},{status:400});return n.Z.json({message:"通知を更新しました",notification:f},{status:200})}catch(e){return console.error("notifications API: サーバーエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/notifications/route",pathname:"/api/notifications",filename:"route",bundlePath:"app/api/notifications/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/notifications/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:m,staticGenerationBailout:h}=l,j="/api/notifications/route";function _(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(47345));module.exports=s})();