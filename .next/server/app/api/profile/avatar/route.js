"use strict";(()=>{var e={};e.id=8151,e.ids=[8151],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},16222:(e,r,a)=>{a.r(r),a.d(r,{headerHooks:()=>c,originalPathname:()=>v,patchFetch:()=>h,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var t={};a.r(t),a.d(t,{POST:()=>p});var s=a(95419),o=a(69108),i=a(99678),u=a(78070);let n=(0,a(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function p(e){try{let r=(await e.formData()).get("avatar");if(!r)return u.Z.json({message:"ファイルが必要です"},{status:400});let a=e.headers.get("authorization");if(!a)return u.Z.json({message:"認証が必要です"},{status:401});let t=a.replace("Bearer ",""),{data:{user:s},error:o}=await n.auth.getUser(t);if(o||!s)return u.Z.json({message:"認証に失敗しました"},{status:401});let{data:i,error:p}=await n.from("users").select("id, email, display_name").eq("auth_user_id",s.id).single();if(p||!i)return u.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});if(r.size>5242880)return u.Z.json({message:"ファイルサイズが大きすぎます（5MB以下にしてください）"},{status:400});if(!["image/jpeg","image/png","image/gif","image/webp"].includes(r.type))return u.Z.json({message:"サポートされていないファイル形式です（JPEG、PNG、GIF、WebPのみ）"},{status:400});let l=r.name.split(".").pop(),d=`avatar-${i.id}-${Date.now()}.${l}`,m=`avatars/${d}`,{data:g,error:c}=await n.storage.from("avatars").upload(m,r,{cacheControl:"3600",upsert:!0});if(c)return console.error("アバターアップロードエラー:",c),u.Z.json({message:"ファイルのアップロードに失敗しました: "+c.message},{status:400});let{data:{publicUrl:f}}=n.storage.from("avatars").getPublicUrl(m),{error:v}=await n.from("users").update({avatar_url:f}).eq("id",i.id);if(v)return console.error("アバターURL更新エラー:",v),u.Z.json({message:"プロフィールの更新に失敗しました: "+v.message},{status:400});return u.Z.json({message:"アバターが更新されました",avatar_url:f})}catch(e){return console.error("アバターアップロードAPI エラー:",e),u.Z.json({message:"サーバーエラーが発生しました: "+(e instanceof Error?e.message:"不明なエラー")},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/profile/avatar/route",pathname:"/api/profile/avatar",filename:"route",bundlePath:"app/api/profile/avatar/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/profile/avatar/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:c,staticGenerationBailout:f}=l,v="/api/profile/avatar/route";function h(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[1638,6206,2409],()=>a(16222));module.exports=t})();