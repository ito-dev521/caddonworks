"use strict";(()=>{var e={};e.id=7951,e.ids=[7951],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},82975:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>I});var o={};r.r(o),r.d(o,{GET:()=>u});var s=r(95419),a=r(69108),n=r(99678),i=r(78070),c=r(6517),l=r(67082);async function u(e){let t=(0,c.ST)();try{let{searchParams:r}=new URL(e.url),o=Number(r.get("year"))||new Date().getFullYear(),s=Number(r.get("month"))||new Date().getMonth()+1,a=new Date(Date.UTC(o,s-1,20)),n=new Date(Date.UTC(o,s-2,21)),c=new Date(Date.UTC(o,s,0)),{data:u,error:d}=await t.from("invoices").select("id, contractor_id, subtotal").eq("direction","to_operator").gte("issue_date",n.toISOString().slice(0,10)).lte("issue_date",a.toISOString().slice(0,10));if(d)return i.Z.json({message:"請求データ取得に失敗"},{status:500});let p=Array.from(new Set((u||[]).map(e=>e.contractor_id).filter(Boolean))),{data:m}=await t.from("users").select("id, company_number").in("id",p),h=new Map;for(let e of m||[])h.set(e.id,!!e.company_number);let g=new Map;for(let e of u||[]){let t=g.get(e.contractor_id)||0;g.set(e.contractor_id,t+(e.subtotal||0))}let I=[];for(let[e,r]of Array.from(g.entries())){let o=(0,l.b)({businessType:h.get(e)?"corporation":"individual",totalBilled:r}),{data:s,error:u}=await t.from("payouts").insert({contractor_id:e,period_start:n.toISOString().slice(0,10),period_end:a.toISOString().slice(0,10),scheduled_pay_date:c.toISOString().slice(0,10),gross_amount:o.grossAmount,tax_withholding:o.withholdingTax,transfer_fee:o.transferFee,net_amount:o.netAmount,status:"scheduled"}).select().single();if(u)return i.Z.json({message:"payout作成に失敗"},{status:500});I.push(s)}return i.Z.json({period:{start:n.toISOString().slice(0,10),end:a.toISOString().slice(0,10),payDate:c.toISOString().slice(0,10)},payouts:I})}catch(e){return console.error("close-contractors error:",e),i.Z.json({message:"サーバーエラー"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/billing/close-contractors/route",pathname:"/api/billing/close-contractors",filename:"route",bundlePath:"app/api/billing/close-contractors/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/billing/close-contractors/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:g,staticGenerationBailout:I}=d,w="/api/billing/close-contractors/route";function S(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},67082:(e,t,r)=>{function o(e){let t=Math.max(0,Math.round(e.totalBilled));if("corporation"===e.businessType)return{grossAmount:t,withholdingTax:0,transferFee:0,netAmount:t};let r=Math.round(.1021*t);return{grossAmount:t,withholdingTax:r,transferFee:550,netAmount:Math.max(0,t-r-550)}}function s(e){let t=Math.max(0,Math.round(e.contractorsTotal)),r=Math.round(.3*t);return{contractorsTotal:t,operatorFee:r,totalAmount:t+r}}r.d(t,{b:()=>o,n:()=>s})},6517:(e,t,r)=>{r.d(t,{OQ:()=>s,ST:()=>a});var o=r(32409);let s=(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),a=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2409],()=>r(82975));module.exports=o})();