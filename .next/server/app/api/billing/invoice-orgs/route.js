"use strict";(()=>{var e={};e.id=5230,e.ids=[5230],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},4570:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>I,originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>b});var o={};r.r(o),r.d(o,{GET:()=>d});var a=r(95419),n=r(69108),i=r(99678),s=r(78070),l=r(6517),u=r(67082),c=r(68612);async function d(e){let t=(0,l.ST)();try{let{searchParams:r}=new URL(e.url),o=Number(r.get("year"))||new Date().getFullYear(),a=Number(r.get("month"))||new Date().getMonth()+1,n=r.get("org_id")||"";if(!n)return s.Z.json({message:"org_id is required"},{status:400});let i=new Date(Date.UTC(o,a-1,20)),l=new Date(Date.UTC(o,a-2,21)),d=new Date(Date.UTC(o,a,5)),{data:g,error:p}=await t.from("invoices").select("subtotal").eq("direction","to_operator").eq("org_id",n).gte("issue_date",l.toISOString().slice(0,10)).lte("issue_date",i.toISOString().slice(0,10));if(p)return s.Z.json({message:"請求集計に失敗"},{status:500});let h=(g||[]).reduce((e,t)=>e+(t.subtotal||0),0),m=(0,u.n)({contractorsTotal:h}),I=await (0,c.C)({title:"発注者向け月次請求書",issueDate:new Date().toISOString().slice(0,10),dueDate:d.toISOString().slice(0,10),party:{name:String(n)},items:[{description:`期間 ${l.toISOString().slice(0,10)}〜${i.toISOString().slice(0,10)}`,amount:m.contractorsTotal}],totals:{subtotal:m.contractorsTotal,adjustments:m.operatorFee,total:m.totalAmount}}),{data:b,error:S}=await t.from("monthly_statements").insert({org_id:n,period_start:l.toISOString().slice(0,10),period_end:i.toISOString().slice(0,10),due_date:d.toISOString().slice(0,10),contractors_total:m.contractorsTotal,operator_fee:m.operatorFee,total_amount:m.totalAmount,pdf_url:I,status:"issued"}).select().single();if(S)return s.Z.json({message:"発注者向け請求の作成に失敗"},{status:500});return s.Z.json({statement:b})}catch(e){return console.error("invoice-orgs error:",e),s.Z.json({message:"サーバーエラー"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/billing/invoice-orgs/route",pathname:"/api/billing/invoice-orgs",filename:"route",bundlePath:"app/api/billing/invoice-orgs/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/billing/invoice-orgs/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:m,headerHooks:I,staticGenerationBailout:b}=g,S="/api/billing/invoice-orgs/route";function w(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},67082:(e,t,r)=>{function o(e){let t=Math.max(0,Math.round(e.totalBilled));if("corporation"===e.businessType)return{grossAmount:t,withholdingTax:0,transferFee:0,netAmount:t};let r=Math.round(.1021*t);return{grossAmount:t,withholdingTax:r,transferFee:550,netAmount:Math.max(0,t-r-550)}}function a(e){let t=Math.max(0,Math.round(e.contractorsTotal)),r=Math.round(.3*t);return{contractorsTotal:t,operatorFee:r,totalAmount:t+r}}r.d(t,{b:()=>o,n:()=>a})},68612:(e,t,r)=>{r.d(t,{C:()=>a,b:()=>n});var o=r(95564);async function a(e){let t=JSON.stringify(e,null,2);return`data:application/json;base64,${Buffer.from(t).toString("base64")}`}async function n(e,t){let r=await o.PDFDocument.create(),a=r.addPage([595.28,841.89]),n=await r.embedFont(o.StandardFonts.Helvetica),i=(e,t,r,i=12)=>a.drawText(e,{x:t,y:r,size:i,font:n,color:(0,o.rgb)(0,0,0)});i(new Date().toLocaleDateString("ja-JP"),500,810,10),i(t.title,240,790,20),a.drawRectangle({x:36,y:700-18*(t.lines.length+1),width:523,height:18*(t.lines.length+1),borderColor:(0,o.rgb)(0,0,0),borderWidth:1}),t.lines.forEach((e,r)=>{i(e,44,686-18*r,9),r<t.lines.length&&a.drawLine({start:{x:36,y:700-18*(r+1)},end:{x:559,y:700-18*(r+1)},color:(0,o.rgb)(0,0,0)})});let s=700-18*(t.lines.length+1)-90;return a.drawRectangle({x:36,y:s,width:523,height:70,borderColor:(0,o.rgb)(0,0,0),borderWidth:1}),i("金額",46,s+52,12),i(`${t.amount.toLocaleString("ja-JP")} 円`,106,s+30,22),i(t.note||"注: 電子契約につき収入印紙は不要です。",36,s-16,9),Buffer.from(await r.save())}},6517:(e,t,r)=>{r.d(t,{OQ:()=>a,ST:()=>n});var o=r(32409);let a=(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),n=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2409,5564],()=>r(4570));module.exports=o})();