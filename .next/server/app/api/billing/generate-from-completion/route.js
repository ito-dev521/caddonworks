"use strict";(()=>{var e={};e.id=659,e.ids=[659],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},41753:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>b,originalPathname:()=>I,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var o={};r.r(o),r.d(o,{POST:()=>d});var n=r(95419),a=r(69108),i=r(99678),s=r(78070),l=r(6517),u=r(67082),c=r(68612);async function d(e){let t=(0,l.ST)();try{let{contract_id:r}=await e.json();if(!r)return s.Z.json({message:"contract_id is required"},{status:400});let{data:o,error:n}=await t.from("contracts").select("id, project_id, contractor_id, org_id, bid_amount, status").eq("id",r).single();if(n||!o)return s.Z.json({message:"契約が見つかりません"},{status:404});let{data:a,error:i}=await t.from("users").select("id, company_number").eq("id",o.contractor_id).single();if(i||!a)return s.Z.json({message:"受注者が見つかりません"},{status:404});let l=!!a.company_number,d=(0,u.b)({businessType:l?"corporation":"individual",totalBilled:o.bid_amount||0}),m=await (0,c.C)({title:"請求書（受注者→運営）",issueDate:new Date().toISOString().slice(0,10),party:{name:String(o.contractor_id)},items:[{description:`契約 ${o.id}`,amount:o.bid_amount||0}],totals:{subtotal:o.bid_amount||0,total:d.netAmount}}),{data:p,error:g}=await t.from("invoices").insert({direction:"to_operator",contractor_id:o.contractor_id,contract_id:o.id,org_id:o.org_id,subtotal:o.bid_amount||0,tax_withholding:d.withholdingTax,transfer_fee:d.transferFee,total_amount:d.netAmount,pdf_url:m,status:"pending"}).select().single();if(g)return s.Z.json({message:"受注者請求の作成に失敗しました"},{status:500});return s.Z.json({message:"生成完了",contractorInvoice:p},{status:200})}catch(e){return console.error("generate-from-completion error:",e),s.Z.json({message:"サーバーエラー"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/billing/generate-from-completion/route",pathname:"/api/billing/generate-from-completion",filename:"route",bundlePath:"app/api/billing/generate-from-completion/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/billing/generate-from-completion/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:b,staticGenerationBailout:f}=m,I="/api/billing/generate-from-completion/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},67082:(e,t,r)=>{function o(e){let t=Math.max(0,Math.round(e.totalBilled));if("corporation"===e.businessType)return{grossAmount:t,withholdingTax:0,transferFee:0,netAmount:t};let r=Math.round(.1021*t);return{grossAmount:t,withholdingTax:r,transferFee:550,netAmount:Math.max(0,t-r-550)}}function n(e){let t=Math.max(0,Math.round(e.contractorsTotal)),r=Math.round(.3*t);return{contractorsTotal:t,operatorFee:r,totalAmount:t+r}}r.d(t,{b:()=>o,n:()=>n})},68612:(e,t,r)=>{r.d(t,{C:()=>n,b:()=>a});var o=r(95564);async function n(e){let t=JSON.stringify(e,null,2);return`data:application/json;base64,${Buffer.from(t).toString("base64")}`}async function a(e,t){let r=await o.PDFDocument.create(),n=r.addPage([595.28,841.89]),a=await r.embedFont(o.StandardFonts.Helvetica),i=(e,t,r,i=12)=>n.drawText(e,{x:t,y:r,size:i,font:a,color:(0,o.rgb)(0,0,0)});i(new Date().toLocaleDateString("ja-JP"),500,810,10),i(t.title,240,790,20),n.drawRectangle({x:36,y:700-18*(t.lines.length+1),width:523,height:18*(t.lines.length+1),borderColor:(0,o.rgb)(0,0,0),borderWidth:1}),t.lines.forEach((e,r)=>{i(e,44,686-18*r,9),r<t.lines.length&&n.drawLine({start:{x:36,y:700-18*(r+1)},end:{x:559,y:700-18*(r+1)},color:(0,o.rgb)(0,0,0)})});let s=700-18*(t.lines.length+1)-90;return n.drawRectangle({x:36,y:s,width:523,height:70,borderColor:(0,o.rgb)(0,0,0),borderWidth:1}),i("金額",46,s+52,12),i(`${t.amount.toLocaleString("ja-JP")} 円`,106,s+30,22),i(t.note||"注: 電子契約につき収入印紙は不要です。",36,s-16,9),Buffer.from(await r.save())}},6517:(e,t,r)=>{r.d(t,{OQ:()=>n,ST:()=>a});var o=r(32409);let n=(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),a=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,o.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2409,5564],()=>r(41753));module.exports=o})();