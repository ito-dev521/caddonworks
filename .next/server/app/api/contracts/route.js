"use strict";(()=>{var e={};e.id=8326,e.ids=[8326],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},17252:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>j,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var a={};r.r(a),r.d(a,{GET:()=>l,POST:()=>d});var s=r(95419),o=r(69108),i=r(99678),n=r(78070);let c=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function d(e){try{let{project_id:t,bid_id:r,contract_amount:a,start_date:s,end_date:o,contractor_id:i,org_id:d}=await e.json();if(!t||!r||!a||!s||!o||!i||!d)return n.Z.json({message:"必須項目が入力されていません"},{status:400});let l=e.headers.get("authorization");if(!l)return n.Z.json({message:"認証が必要です"},{status:401});let u=l.replace("Bearer ",""),{data:{user:m},error:g}=await c.auth.getUser(u);if(g||!m)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:p,error:f}=await c.from("users").select("id, display_name").eq("auth_user_id",m.id).single();if(f||!p)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:_,error:h}=await c.from("memberships").select("role, org_id").eq("user_id",p.id);if(h||!_||0===_.length)return n.Z.json({message:"組織情報の取得に失敗しました"},{status:403});let j=_.find(e=>"OrgAdmin"===e.role);if(!j)return n.Z.json({message:"この操作を実行する権限がありません（発注者権限が必要です）"},{status:403});let{data:w,error:q}=await c.from("projects").select("id, title, org_id").eq("id",t).eq("org_id",j.org_id).single();if(q||!w)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:y,error:Z}=await c.from("users").select("id, display_name, email").eq("id",i).single();if(Z||!y)return n.Z.json({message:"受注者情報が見つかりません"},{status:404});let{data:A,error:x}=await c.from("contracts").insert({project_id:t,org_id:j.org_id,contractor_id:i,contract_title:w.title,contract_content:`案件「${w.title}」の契約書

契約金額: \xa5${Number(a).toLocaleString()}
契約期間: ${s} - ${o}

受注者: ${y.display_name}
発注者: ${j.org_id}`,bid_amount:Number(a),start_date:s,end_date:o,status:"pending_contractor"}).select().single();if(x)return console.error("契約作成エラー:",x),n.Z.json({message:"契約の作成に失敗しました: "+x.message},{status:400});await c.from("projects").update({status:"contract_pending",contractor_id:i}).eq("id",t);let{data:P,error:S}=await c.from("users").select("id, display_name").eq("id",i).single();return!S&&P&&await c.from("notifications").insert({user_id:P.id,type:"contract_created",title:"新しい契約書が作成されました",message:`案件「${w.title}」の契約書が作成されました。内容を確認し、署名してください。`,data:{project_id:t,contract_id:A.id,org_id:j.org_id,org_name:(await c.from("organizations").select("name").eq("id",j.org_id).single()).data?.name}}),n.Z.json({message:"契約書が正常に作成されました",contract:A},{status:201})}catch(e){return console.error("契約作成エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function l(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),{data:{user:a},error:s}=await c.auth.getUser(r);if(s||!a)return console.error("contracts API: 認証エラー",{authError:s?.message,hasUser:!!a}),n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:i}=await c.from("users").select("id").eq("auth_user_id",a.id).single();if(i||!o)return console.error("contracts API: ユーザープロフィール取得エラー",{userError:i?.message,hasProfile:!!o}),n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:d,error:l}=await c.from("memberships").select("org_id, role").eq("user_id",o.id);if(l||!d||0===d.length)return console.error("contracts API: メンバーシップ取得エラー",{membershipError:l?.message,membershipsCount:d?.length}),n.Z.json({message:"組織情報が見つかりません"},{status:403});let u=[],m=null,g=d.find(e=>"OrgAdmin"===e.role);if(g){let{data:e,error:t}=await c.from("contracts").select("*").eq("org_id",g.org_id).order("created_at",{ascending:!1});if(t)console.error("contracts API: 基本契約データ取得エラー",t),u=[],m=t;else{let t=Array.from(new Set(e?.map(e=>e.project_id)||[])),r=Array.from(new Set(e?.map(e=>e.contractor_id)||[])),a={};if(t.length>0){let{data:e}=await c.from("projects").select("id, title").in("id",t);a=e?.reduce((e,t)=>(e[t.id]=t,e),{})||{}}let{data:s}=await c.from("organizations").select("id, name").eq("id",g.org_id).single(),o={};if(r.length>0){let{data:e}=await c.from("users").select("id, display_name, email").in("id",r);o=e?.reduce((e,t)=>(e[t.id]=t,e),{})||{}}u=e?.map(e=>({...e,projects:a[e.project_id],organizations:s,contractors:o[e.contractor_id]}))||[],m=null}}else{if(!d.some(e=>"Contractor"===e.role))return n.Z.json({message:"この操作を実行する権限がありません"},{status:403});let{data:e,error:t}=await c.from("contracts").select("*").eq("contractor_id",o.id).order("created_at",{ascending:!1});if(t)console.error("contracts API: 基本契約データ取得エラー",t),u=[],m=t;else{let t=Array.from(new Set(e?.map(e=>e.project_id)||[])),r=Array.from(new Set(e?.map(e=>e.org_id)||[])),a={};if(t.length>0){let{data:e}=await c.from("projects").select("id, title").in("id",t);a=e?.reduce((e,t)=>(e[t.id]=t,e),{})||{}}let s={};if(r.length>0){let{data:e}=await c.from("organizations").select("id, name").in("id",r);s=e?.reduce((e,t)=>(e[t.id]=t,e),{})||{}}let{data:i}=await c.from("users").select("id, display_name, email").eq("id",o.id).single();u=e?.map(e=>({...e,projects:a[e.project_id],organizations:s[e.org_id],contractors:i}))||[],m=null}}if(m)return console.error("契約取得エラー:",m),n.Z.json({message:"契約の取得に失敗しました"},{status:500});let p=u?.map(e=>({...e,project_title:e.projects?.title||e.contract_title,org_name:e.organizations?.name,contractor_name:e.contractors?.display_name,contractor_email:e.contractors?.email}))||[];return n.Z.json({contracts:p},{status:200})}catch(e){return console.error("contracts API: サーバーエラー:",e),n.Z.json({message:"サーバーエラーが発生しました",error:e instanceof Error?e.message:"不明なエラー"},{status:500})}}let u=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/contracts/route",pathname:"/api/contracts",filename:"route",bundlePath:"app/api/contracts/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/contracts/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:p,headerHooks:f,staticGenerationBailout:_}=u,h="/api/contracts/route";function j(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2409],()=>r(17252));module.exports=a})();