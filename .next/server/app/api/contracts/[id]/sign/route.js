"use strict";(()=>{var e={};e.id=624,e.ids=[624],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},4237:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>_});var s={};r.r(s),r.d(s,{POST:()=>d});var a=r(95419),o=r(69108),i=r(99678),n=r(78070);let u=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function d(e,{params:t}){try{let r=t.id,s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),{data:{user:o},error:i}=await u.auth.getUser(a);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:d,error:c}=await u.from("users").select("id, display_name").eq("auth_user_id",o.id).single();if(c||!d)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:p,error:l}=await u.from("memberships").select("role").eq("user_id",d.id);if(l||!p||0===p.length)return n.Z.json({message:"組織情報が見つかりません"},{status:403});if(!p.some(e=>"Contractor"===e.role))return n.Z.json({message:"この操作を実行する権限がありません（受注者権限が必要です）"},{status:403});let{data:g,error:m}=await u.from("contracts").select("*").eq("id",r).eq("contractor_id",d.id).single();if(m||!g)return n.Z.json({message:"契約が見つかりません"},{status:404});if("pending_contractor"!==g.status)return n.Z.json({message:"この契約は既に署名済みです"},{status:400});let{data:_,error:f}=await u.from("contracts").update({status:"signed",contractor_signed_at:new Date().toISOString(),signed_at:new Date().toISOString()}).eq("id",r).select().single();if(f)return console.error("契約署名エラー:",f),n.Z.json({message:"署名に失敗しました: "+f.message},{status:400});await u.from("projects").update({status:"in_progress",contractor_id:d.id}).eq("id",g.project_id);let{data:h,error:q}=await u.from("memberships").select("user_id").eq("org_id",g.org_id).eq("role","OrgAdmin");if(!q&&h&&h.length>0){let{data:e,error:t}=await u.from("projects").select("title").eq("id",g.project_id).single();if(!t&&e){let t=h.map(t=>({user_id:t.user_id,type:"contract_signed",title:"契約が署名されました",message:`案件「${e.title}」の契約が受注者によって署名されました。チャットルームでやりとりを開始できます。`,data:{project_id:g.project_id,contract_id:r,contractor_id:d.id,contractor_name:d.display_name}}));await u.from("notifications").insert(t)}}return n.Z.json({message:"契約に署名しました",contract:_},{status:200})}catch(e){return console.error("契約署名エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/contracts/[id]/sign/route",pathname:"/api/contracts/[id]/sign",filename:"route",bundlePath:"app/api/contracts/[id]/sign/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/contracts/[id]/sign/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:g,headerHooks:m,staticGenerationBailout:_}=c,f="/api/contracts/[id]/sign/route";function h(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:l})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(4237));module.exports=s})();