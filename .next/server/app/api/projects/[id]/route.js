"use strict";(()=>{var e={};e.id=7361,e.ids=[7361],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},31899:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>j});var s={};r.r(s),r.d(s,{GET:()=>d,PUT:()=>l});var a=r(95419),o=r(69108),i=r(99678),n=r(78070),u=r(32409);async function d(e,{params:t}){try{let r=t.id;if(!r)return n.Z.json({message:"案件IDが必要です"},{status:400});let s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),o=(0,u.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:i},error:d}=await o.auth.getUser(a);if(d||!i)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:l,error:c}=await o.from("users").select("id").eq("auth_user_id",i.id).single();if(c||!l)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:g,error:p}=await o.from("projects").select("*").eq("id",r).single();if(p||!g)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:m,error:_}=await o.from("organizations").select("name").eq("id",g.org_id).single();_&&console.error("組織情報取得エラー:",_);let{data:j,error:f}=await o.from("memberships").select("role, org_id").eq("user_id",l.id).single();if(f||!j)return n.Z.json({message:"組織情報が見つかりません"},{status:403});let h="OrgAdmin"===j.role&&g.org_id===j.org_id,q="Contractor"===j.role;if(!h&&!q)return n.Z.json({message:"この案件を閲覧する権限がありません"},{status:403});let Z={id:g.id,title:g.title,description:g.description,status:g.status,budget:g.budget,start_date:g.start_date,end_date:g.end_date,category:g.category,created_at:g.created_at,org_id:g.org_id,org_name:m?.name,required_contractors:g.required_contractors,assignee_name:g.assignee_name,bidding_deadline:g.bidding_deadline};return n.Z.json({project:Z},{status:200})}catch(e){return console.error("案件取得APIエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function l(e,{params:t}){try{let r=t.id;if(!r)return n.Z.json({message:"案件IDが必要です"},{status:400});let s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),o=(0,u.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:i},error:d}=await o.auth.getUser(a);if(d||!i)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:l,error:c}=await o.from("users").select("id").eq("auth_user_id",i.id).single();if(c||!l)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{title:g,description:p,budget:m,start_date:_,end_date:j,category:f,required_contractors:h,required_level:q,assignee_name:Z,status:w}=await e.json();if(!g||!p||!m||!_||!j||!f||!h)return n.Z.json({message:"必須フィールドが不足しています"},{status:400});let{data:x,error:b}=await o.from("projects").select("*").eq("id",r).single();if(b||!x)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:y,error:A}=await o.from("memberships").select("role, org_id").eq("user_id",l.id).single();if(A||!y)return n.Z.json({message:"組織情報が見つかりません"},{status:403});if(!("OrgAdmin"===y.role&&x.org_id===y.org_id))return n.Z.json({message:"この案件を編集する権限がありません"},{status:403});let E={title:g,description:p,budget:Number(m),start_date:_,end_date:j,category:f,required_contractors:Number(h),required_level:q||"beginner",assignee_name:Z||null,updated_at:new Date().toISOString()};w&&(E.status=w);let{data:S,error:v}=await o.from("projects").update(E).eq("id",r).select().single();if(v)return console.error("案件更新エラー:",v),n.Z.json({message:"案件の更新に失敗しました"},{status:500});return n.Z.json({message:"案件が正常に更新されました",project:S},{status:200})}catch(e){return console.error("案件更新APIエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/projects/[id]/route",pathname:"/api/projects/[id]",filename:"route",bundlePath:"app/api/projects/[id]/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/projects/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:_,staticGenerationBailout:j}=c,f="/api/projects/[id]/route";function h(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(31899));module.exports=s})();