"use strict";(()=>{var e={};e.id=8864,e.ids=[8864],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},64587:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>j});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>d});var a=r(95419),o=r(69108),i=r(99678),n=r(78070),p=r(6517);async function c(e,{params:t}){try{let{id:r}=t,s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),{data:{user:o},error:i}=await p.OQ.auth.getUser(a);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:d}=await p.OQ.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(d||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:l,error:u}=await p.OQ.from("projects").select("id, org_id, title").eq("id",r).single();if(u||!l)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:m,error:g}=await p.OQ.from("memberships").select("role, org_id").eq("user_id",c.id).eq("org_id",l.org_id).single();if(g||!m)return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});if(!["OrgAdmin","Contractor"].includes(m.role))return n.Z.json({message:"添付資料の閲覧権限がありません"},{status:403});let f=(0,p.ST)(),{data:j,error:h}=await f.from("project_attachments").select(`
        id,
        file_name,
        file_path,
        file_size,
        file_type,
        created_at,
        uploaded_by,
        uploader:users!project_attachments_uploaded_by_fkey (
          display_name
        )
      `).eq("project_id",r).order("created_at",{ascending:!1});if(h)return console.error("添付資料の取得に失敗:",h),n.Z.json({message:"添付資料の取得に失敗しました"},{status:400});return n.Z.json({attachments:j||[]},{status:200})}catch(e){return console.error("添付資料取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function d(e,{params:t}){let r=Date.now();try{let{id:r}=t,s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let a=s.replace("Bearer ",""),{data:{user:o},error:i}=await p.OQ.auth.getUser(a);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:d}=await p.OQ.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(d||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:l,error:u}=await p.OQ.from("projects").select("id, org_id, title").eq("id",r).single();if(u||!l)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:m,error:g}=await p.OQ.from("memberships").select("role, org_id").eq("user_id",c.id).eq("org_id",l.org_id).single();if(g||!m)return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});if(!["OrgAdmin","Contractor"].includes(m.role))return n.Z.json({message:"ファイルアップロードの権限がありません"},{status:403});let f=(await e.formData()).get("file");if(!f)return n.Z.json({message:"ファイルが選択されていません"},{status:400});if(f.size>209715200)return n.Z.json({message:"ファイルサイズが大きすぎます（最大200MB）"},{status:400});let j="."+f.name.split(".").pop()?.toLowerCase();if(!["application/pdf","image/jpeg","image/png","image/gif","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain","application/zip","application/x-rar-compressed","application/dwg","application/x-dwg","image/vnd.dwg","application/step","application/step+zip","application/octet-stream","application/x-step","application/x-sfc","application/x-bfo"].includes(f.type)&&![".pdf",".jpg",".jpeg",".png",".gif",".webp",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".zip",".rar",".dwg",".p21",".sfc",".bfo"].includes(j))return n.Z.json({message:"サポートされていないファイル形式です",details:`対応形式: PDF, Word, Excel, PowerPoint, 画像, ZIP, RAR, DWG, P21, SFC, BFO。現在のファイル: ${f.name} (${f.type})`},{status:400});let h=Date.now(),_=(e=>{let t=e.lastIndexOf("."),r=t>0?e.substring(0,t):e,s=t>0?e.substring(t):"";return r.replace(/[^\w\-_.]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"").substring(0,100)+s})(f.name),w=`${h}_${_}`,I=`projects/${r}/${w}`,x=(0,p.ST)(),{data:Z,error:y}=await x.storage.listBuckets();if(y)return console.error("バケット一覧取得エラー:",y),n.Z.json({message:"Storageバケットの確認に失敗しました",error:y.message},{status:500});if(!Z?.some(e=>"project-attachments"===e.id))return console.error("バケットが存在しません:",{requestedBucket:"project-attachments",availableBuckets:Z?.map(e=>e.id)}),n.Z.json({message:'Storageバケット "project-attachments" が存在しません',error:"Bucket not found",details:`利用可能なバケット: ${Z?.map(e=>e.id).join(", ")||"なし"}`},{status:404});let{data:b,error:z}=await x.storage.from("project-attachments").upload(I,f);if(z)return console.error("ファイルアップロードエラー:",{error:z,filePath:I,fileName:f.name,fileSize:f.size,errorCode:z.statusCode||"UNKNOWN",errorMessage:z.message}),n.Z.json({message:"ファイルのアップロードに失敗しました",error:z.message,details:`エラーコード: ${z.statusCode||"Unknown"}, バケット: project-attachments`},{status:400});let{data:O,error:q}=await x.from("project_attachments").insert({project_id:r,file_name:f.name,file_path:I,file_size:f.size,file_type:f.type,uploaded_by:c.id}).select().single();if(q)return console.error("添付資料保存エラー:",{error:q,project_id:r,uploaded_by:c.id}),await x.storage.from("project-attachments").remove([I]),n.Z.json({message:"添付資料の保存に失敗しました",error:q.message,details:"project_attachmentsテーブルが存在しないか、アクセス権限がありません"},{status:400});return Date.now(),n.Z.json({message:"ファイルが正常にアップロードされました",attachment:O},{status:201})}catch(s){let e=Date.now()-r;return console.error("=== ファイルアップロードエラー ===",{error:s,duration:`${e}ms`,projectId:t.id,timestamp:new Date().toISOString()}),n.Z.json({message:"サーバーエラーが発生しました",error:s instanceof Error?s.message:"Unknown error",duration:`${e}ms`},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/projects/[id]/attachments/route",pathname:"/api/projects/[id]/attachments",filename:"route",bundlePath:"app/api/projects/[id]/attachments/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/projects/[id]/attachments/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:f,staticGenerationBailout:j}=l,h="/api/projects/[id]/attachments/route";function _(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>a,ST:()=>o});var s=r(32409);let a=(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),o=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(64587));module.exports=s})();