"use strict";(()=>{var e={};e.id=8864,e.ids=[8864],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},64587:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>j});var s={};a.r(s),a.d(s,{GET:()=>p,POST:()=>c});var r=a(95419),o=a(69108),i=a(99678),n=a(78070),l=a(6517);async function p(e,{params:t}){try{let{id:a}=t,s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let r=s.replace("Bearer ",""),{data:{user:o},error:i}=await l.OQ.auth.getUser(r);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:p,error:c}=await l.OQ.from("project_attachments").select(`
        id,
        file_name,
        file_path,
        file_size,
        file_type,
        created_at,
        uploaded_by,
        uploader:users!project_attachments_uploaded_by_fkey (
          display_name
        )
      `).eq("project_id",a).order("created_at",{ascending:!1});if(c)return console.error("添付資料の取得に失敗:",c),n.Z.json({message:"添付資料の取得に失敗しました"},{status:400});return n.Z.json({attachments:p},{status:200})}catch(e){return console.error("添付資料取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function c(e,{params:t}){let a=Date.now();console.log("=== ファイルアップロード開始 ===",{projectId:t.id,timestamp:new Date().toISOString()});try{let{id:s}=t,r=e.headers.get("authorization");if(!r)return console.log("認証ヘッダーなし"),n.Z.json({message:"認証が必要です"},{status:401});let o=r.replace("Bearer ","");console.log("認証トークン取得:",{tokenLength:o.length});let{data:{user:i},error:p}=await l.OQ.auth.getUser(o);if(p||!i)return console.log("認証失敗:",p),n.Z.json({message:"認証に失敗しました"},{status:401});console.log("認証成功:",{userId:i.id,email:i.email});let{data:c,error:d}=await l.OQ.from("users").select("id, email, display_name").eq("auth_user_id",i.id).single();if(d||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:m,error:u}=await l.OQ.from("projects").select("id, org_id, title").eq("id",s).single();if(u||!m)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:g,error:f}=await l.OQ.from("memberships").select("role, org_id").eq("user_id",c.id).eq("org_id",m.org_id).single();if(f||!g)return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});if(!["OrgAdmin","Contractor"].includes(g.role))return n.Z.json({message:"ファイルアップロードの権限がありません"},{status:403});console.log("FormData解析開始");let j=await e.formData();console.log("FormData解析完了");let h=j.get("file");if(console.log("ファイル取得:",{fileName:h?.name,fileSize:h?.size,fileType:h?.type,hasFile:!!h}),!h)return console.log("ファイルが選択されていません"),n.Z.json({message:"ファイルが選択されていません"},{status:400});if(h.size>209715200)return n.Z.json({message:"ファイルサイズが大きすぎます（最大200MB）"},{status:400});let _="."+h.name.split(".").pop()?.toLowerCase();if(!["application/pdf","image/jpeg","image/png","image/gif","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain","application/zip","application/x-rar-compressed","application/dwg","application/x-dwg","image/vnd.dwg","application/step","application/step+zip","application/octet-stream","application/x-step","application/x-sfc","application/x-bfo"].includes(h.type)&&![".pdf",".jpg",".jpeg",".png",".gif",".webp",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".zip",".rar",".dwg",".p21",".sfc",".bfo"].includes(_))return n.Z.json({message:"サポートされていないファイル形式です",details:`対応形式: PDF, Word, Excel, PowerPoint, 画像, ZIP, RAR, DWG, P21, SFC, BFO。現在のファイル: ${h.name} (${h.type})`},{status:400});let w=Date.now(),x=`${w}_${h.name}`,y=`projects/${s}/${x}`;console.log("バケット存在確認開始");let{data:z,error:I}=await l.OQ.storage.listBuckets();if(I)return console.error("バケット一覧取得エラー:",I),n.Z.json({message:"Storageバケットの確認に失敗しました",error:I.message},{status:500});let Z=z?.some(e=>"project-attachments"===e.id);if(console.log("バケット存在確認結果:",{bucketExists:Z,availableBuckets:z?.map(e=>e.id)}),!Z)return console.error("バケットが存在しません:",{requestedBucket:"project-attachments",availableBuckets:z?.map(e=>e.id)}),n.Z.json({message:'Storageバケット "project-attachments" が存在しません',error:"Bucket not found",details:`利用可能なバケット: ${z?.map(e=>e.id).join(", ")||"なし"}`},{status:404});console.log("ファイルアップロード開始:",{filePath:y,fileName:h.name,fileSize:h.size,fileType:h.type});let{data:b,error:O}=await l.OQ.storage.from("project-attachments").upload(y,h);if(O)return console.error("ファイルアップロードエラー:",{error:O,filePath:y,fileName:h.name,fileSize:h.size,errorCode:O.statusCode||"UNKNOWN",errorMessage:O.message}),n.Z.json({message:"ファイルのアップロードに失敗しました",error:O.message,details:`エラーコード: ${O.statusCode||"Unknown"}, バケット: project-attachments`},{status:400});console.log("ファイルアップロード成功:",b),console.log("データベース保存開始:",{project_id:s,file_name:h.name,file_path:y,file_size:h.size,file_type:h.type,uploaded_by:c.id});let{data:S,error:v}=await l.OQ.from("project_attachments").insert({project_id:s,file_name:h.name,file_path:y,file_size:h.size,file_type:h.type,uploaded_by:c.id}).select().single();if(v)return console.error("添付資料保存エラー:",{error:v,project_id:s,uploaded_by:c.id}),await l.OQ.storage.from("project-attachments").remove([y]),n.Z.json({message:"添付資料の保存に失敗しました",error:v.message,details:"project_attachmentsテーブルが存在しないか、アクセス権限がありません"},{status:400});console.log("データベース保存成功:",S);let k=Date.now();return console.log("=== ファイルアップロード完了 ===",{duration:`${k-a}ms`,projectId:s,fileName:h.name,fileSize:h.size}),n.Z.json({message:"ファイルが正常にアップロードされました",attachment:S},{status:201})}catch(s){let e=Date.now()-a;return console.error("=== ファイルアップロードエラー ===",{error:s,duration:`${e}ms`,projectId:t.id,timestamp:new Date().toISOString()}),n.Z.json({message:"サーバーエラーが発生しました",error:s instanceof Error?s.message:"Unknown error",duration:`${e}ms`},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/projects/[id]/attachments/route",pathname:"/api/projects/[id]/attachments",filename:"route",bundlePath:"app/api/projects/[id]/attachments/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/projects/[id]/attachments/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:u,serverHooks:g,headerHooks:f,staticGenerationBailout:j}=d,h="/api/projects/[id]/attachments/route";function _(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:u})}},6517:(e,t,a)=>{a.d(t,{OQ:()=>r,ST:()=>o});var s=a(32409);let r=(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),o=()=>(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>a(64587));module.exports=s})();