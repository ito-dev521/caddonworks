"use strict";(()=>{var e={};e.id=4871,e.ids=[4871],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},33828:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>_,originalPathname:()=>h,patchFetch:()=>j,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var s={};t.r(s),t.d(s,{GET:()=>c,POST:()=>d});var a=t(95419),o=t(69108),i=t(99678),n=t(78070);let u=(0,t(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function d(e){try{let{title:r,description:t,budget:s,start_date:a,end_date:o,bidding_deadline:i,category:d,contractor_id:c,assignee_name:l,required_contractors:m=1,required_level:g="beginner"}=await e.json();if(!r||!t||!s||!a||!o||!i||!d)return n.Z.json({message:"必須項目が入力されていません"},{status:400});let p=e.headers.get("authorization");if(!p)return n.Z.json({message:"認証が必要です"},{status:401});let _=p.replace("Bearer ",""),{data:{user:f},error:h}=await u.auth.getUser(_);if(h||!f)return console.error("認証エラー:",h),n.Z.json({message:"認証に失敗しました"},{status:401});let{data:j,error:q}=await u.from("users").select("id, email, display_name").eq("auth_user_id",f.id).single();if(q||!j)return console.error("ユーザープロフィールが見つかりません:",q),n.Z.json({message:"ユーザープロフィールが見つかりません。デモアカウントを再作成してください。"},{status:403});let{data:Z,error:w}=await u.from("memberships").select(`
        org_id,
        role,
        organizations (
          id,
          name
        )
      `).eq("user_id",j.id);if(w||!Z||0===Z.length)return console.error("組織情報の取得に失敗:",w),n.Z.json({message:"組織情報の取得に失敗しました: "+(w?.message||"メンバーシップが見つかりません")},{status:403});let y=Z.find(e=>"OrgAdmin"===e.role);if(!y)return n.Z.json({message:"この操作を実行する権限がありません（OrgAdmin権限が必要です）"},{status:403});let b=y.organizations,x={title:r,description:t,budget:Number(s),start_date:a,end_date:o,bidding_deadline:i,category:d,contractor_id:c||null,assignee_name:l||null,org_id:b.id,status:"bidding"};void 0!==m&&(x.required_contractors=Number(m)),void 0!==g&&(x.required_level=g);let{data:v,error:A}=await u.from("projects").insert(x).select().single();if(A){if(console.error("案件作成エラー:",A),A.message.includes("required_contractors"))return n.Z.json({message:"データベーススキーマが古いです。required_contractorsカラムを追加してください。",error:A.message,suggestion:"SupabaseのSQLエディタでadd-required-contractors-column.sqlを実行してください。"},{status:500});return n.Z.json({message:"案件の作成に失敗しました: "+A.message},{status:400})}return n.Z.json({message:"案件が正常に作成されました",project:v},{status:201})}catch(e){return console.error("案件作成エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function c(e){try{let r=e.headers.get("authorization");if(!r)return n.Z.json({message:"認証が必要です"},{status:401});let t=r.replace("Bearer ",""),{data:{user:s},error:a}=await u.auth.getUser(t);if(a||!s)return console.error("projects API: 認証エラー:",a),n.Z.json({message:"認証に失敗しました: "+(a?.message||"ユーザーが見つかりません")},{status:401});let{data:o,error:i}=await u.from("users").select("id, email, display_name").eq("auth_user_id",s.id).single();if(i||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません。デモアカウントを再作成してください。"},{status:403});let{data:d,error:c}=await u.from("memberships").select(`
        org_id,
        role,
        organizations (
          id,
          name
        )
      `).eq("user_id",o.id);if(c||!d||0===d.length)return n.Z.json({message:"組織情報の取得に失敗しました"},{status:403});let l=d.find(e=>"OrgAdmin"===e.role);if(!l)return n.Z.json({message:"この操作を実行する権限がありません（OrgAdmin権限が必要です）"},{status:403});let m=l.organizations,{searchParams:g}=new URL(e.url),p=g.get("status"),_=u.from("projects").select(`
        id,
        title,
        description,
        status,
        budget,
        start_date,
        end_date,
        contractor_id,
        assignee_name,
        category,
        created_at
      `).eq("org_id",m.id);p&&(_=_.eq("status",p));let{data:f,error:h}=await _.order("created_at",{ascending:!1});if(h)return console.error("案件データの取得に失敗:",h),n.Z.json({message:"案件データの取得に失敗しました"},{status:400});let j=Array.from(new Set(f?.map(e=>e.contractor_id).filter(Boolean)||[])),q={};if(j.length>0){let{data:e}=await u.from("users").select("id, display_name, email").in("id",j);q=e?.reduce((e,r)=>(e[r.id]=r,e),{})||{}}let Z=f?.map(e=>({id:e.id,title:e.title,description:e.description,status:e.status,budget:e.budget,start_date:e.start_date,end_date:e.end_date,contractor_id:e.contractor_id,contractor_name:q[e.contractor_id]?.display_name||"未割当",contractor_email:q[e.contractor_id]?.email||"",progress:Math.floor(100*Math.random()),category:e.category||"道路設計",assignee_name:e.assignee_name,created_at:e.created_at}))||[];return n.Z.json({projects:Z},{status:200})}catch(e){return console.error("案件取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/projects/route",pathname:"/api/projects",filename:"route",bundlePath:"app/api/projects/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/projects/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:p,headerHooks:_,staticGenerationBailout:f}=l,h="/api/projects/route";function j(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,6206,2409],()=>t(33828));module.exports=s})();