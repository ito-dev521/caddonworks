"use strict";(()=>{var e={};e.id=4871,e.ids=[4871],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},33828:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>j,originalPathname:()=>h,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{GET:()=>d,POST:()=>u});var o=r(95419),a=r(69108),n=r(99678),i=r(78070),l=r(32409);console.log("環境変数チェック:"),console.log("NEXT_PUBLIC_SUPABASE_URL:","https://rxnozwuamddqlcwysxag.supabase.co"),console.log("SUPABASE_SERVICE_ROLE_KEY:",process.env.SUPABASE_SERVICE_ROLE_KEY?"設定済み":"未設定");let c=(0,l.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{let{title:t,description:r,budget:s,start_date:o,end_date:a,bidding_deadline:n,category:l,contractor_id:u,assignee_name:d,required_contractors:g=1,required_level:m="beginner"}=await e.json();if(!t||!r||!s||!o||!a||!n||!l)return i.Z.json({message:"必須項目が入力されていません"},{status:400});let p=e.headers.get("authorization");if(!p)return i.Z.json({message:"認証が必要です"},{status:401});let _=p.replace("Bearer ",""),{data:{user:j},error:f}=await c.auth.getUser(_);if(f||!j)return console.error("認証エラー:",f),i.Z.json({message:"認証に失敗しました"},{status:401});console.log("ユーザーID:",j.id),console.log("ユーザーEmail:",j.email);let{data:h,error:A}=await c.from("users").select("id, email, display_name").eq("auth_user_id",j.id).single();if(console.log("ユーザープロフィール:",h),console.log("ユーザープロフィールエラー:",A),A||!h)return console.error("ユーザープロフィールが見つかりません:",A),i.Z.json({message:"ユーザープロフィールが見つかりません。デモアカウントを再作成してください。"},{status:403});let{data:q,error:E}=await c.from("memberships").select(`
        org_id,
        role,
        organizations (
          id,
          name
        )
      `).eq("user_id",h.id);if(console.log("メンバーシップ情報:",q),console.log("メンバーシップエラー:",E),E||!q||0===q.length)return console.error("組織情報の取得に失敗:",E),i.Z.json({message:"組織情報の取得に失敗しました: "+(E?.message||"メンバーシップが見つかりません")},{status:403});let y=q.find(e=>"OrgAdmin"===e.role);if(!y)return i.Z.json({message:"この操作を実行する権限がありません（OrgAdmin権限が必要です）"},{status:403});let w=y.organizations,b={title:t,description:r,budget:Number(s),start_date:o,end_date:a,bidding_deadline:n,category:l,contractor_id:u||null,assignee_name:d||null,org_id:w.id,status:"bidding"};void 0!==g&&(b.required_contractors=Number(g)),void 0!==m&&(b.required_level=m),console.log("挿入データ:",b),console.log("company.id:",w.id),console.log("company:",w),console.log("supabaseAdminクライアント作成完了");let{data:P,error:S}=await c.from("projects").insert(b).select().single();if(S){if(console.error("案件作成エラー:",S),S.message.includes("required_contractors"))return i.Z.json({message:"データベーススキーマが古いです。required_contractorsカラムを追加してください。",error:S.message,suggestion:"SupabaseのSQLエディタでadd-required-contractors-column.sqlを実行してください。"},{status:500});return i.Z.json({message:"案件の作成に失敗しました: "+S.message},{status:400})}return i.Z.json({message:"案件が正常に作成されました",project:P},{status:201})}catch(e){return console.error("案件作成エラー:",e),i.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function d(e){try{console.log("projects API: リクエスト開始");let t=e.headers.get("authorization");if(console.log("projects API: 認証ヘッダー",t?"あり":"なし"),!t)return console.log("projects API: 認証ヘッダーなし"),i.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ","");console.log("projects API: トークン取得完了",r.substring(0,20)+"...");let{data:{user:s},error:o}=await c.auth.getUser(r);if(o||!s)return console.error("projects API: 認証エラー:",o),i.Z.json({message:"認証に失敗しました: "+(o?.message||"ユーザーが見つかりません")},{status:401});console.log("projects API: 認証成功, ユーザーID:",s.id,"Email:",s.email);let{data:a,error:n}=await c.from("users").select("id, email, display_name").eq("auth_user_id",s.id).single();if(n||!a)return i.Z.json({message:"ユーザープロフィールが見つかりません。デモアカウントを再作成してください。"},{status:403});let{data:l,error:u}=await c.from("memberships").select(`
        org_id,
        role,
        organizations (
          id,
          name
        )
      `).eq("user_id",a.id);if(u||!l||0===l.length)return i.Z.json({message:"組織情報の取得に失敗しました"},{status:403});let d=l.find(e=>"OrgAdmin"===e.role);if(!d)return i.Z.json({message:"この操作を実行する権限がありません（OrgAdmin権限が必要です）"},{status:403});let g=d.organizations,{searchParams:m}=new URL(e.url),p=m.get("status"),_=c.from("projects").select(`
        id,
        title,
        description,
        status,
        budget,
        start_date,
        end_date,
        contractor_id,
        assignee_name,
        category,
        created_at
      `).eq("org_id",g.id);p&&(_=_.eq("status",p));let{data:j,error:f}=await _.order("created_at",{ascending:!1});if(f)return console.error("案件データの取得に失敗:",f),i.Z.json({message:"案件データの取得に失敗しました"},{status:400});let h=Array.from(new Set(j?.map(e=>e.contractor_id).filter(Boolean)||[])),A={};if(h.length>0){let{data:e}=await c.from("users").select("id, display_name, email").in("id",h);A=e?.reduce((e,t)=>(e[t.id]=t,e),{})||{}}let q=j?.map(e=>({id:e.id,title:e.title,description:e.description,status:e.status,budget:e.budget,start_date:e.start_date,end_date:e.end_date,contractor_id:e.contractor_id,contractor_name:A[e.contractor_id]?.display_name||"未割当",contractor_email:A[e.contractor_id]?.email||"",progress:Math.floor(100*Math.random()),category:e.category||"道路設計",assignee_name:e.assignee_name,created_at:e.created_at}))||[];return i.Z.json({projects:q},{status:200})}catch(e){return console.error("案件取得エラー:",e),i.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/projects/route",pathname:"/api/projects",filename:"route",bundlePath:"app/api/projects/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/projects/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:_,headerHooks:j,staticGenerationBailout:f}=g,h="/api/projects/route";function A(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:p})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(33828));module.exports=s})();