"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},82777:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>_,originalPathname:()=>f,patchFetch:()=>j,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>h});var r={};s.r(r),s.d(r,{GET:()=>c,POST:()=>d});var a=s(95419),i=s(69108),o=s(99678),n=s(78070);let u=(0,s(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function d(e){try{let{project_id:t,message:s,sender_type:r}=await e.json();if(!t||!s||!r)return n.Z.json({message:"必須項目が入力されていません"},{status:400});let a=e.headers.get("authorization");if(!a)return n.Z.json({message:"認証が必要です"},{status:401});let i=a.replace("Bearer ",""),{data:{user:o},error:d}=await u.auth.getUser(i);if(d||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:l}=await u.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(l||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:m,error:g}=await u.from("projects").select("id, title, org_id, contractor_id").eq("id",t).single();if(g||!m)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:p}=await u.from("memberships").select("org_id, role").eq("user_id",c.id).single();if(!(p?.org_id===m.org_id||m.contractor_id===c.id))return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});let{data:_,error:h}=await u.from("chat_messages").insert({project_id:t,sender_id:c.id,sender_type:r,message:s,created_at:new Date().toISOString()}).select().single();if(h)return console.error("メッセージ保存エラー:",h),n.Z.json({message:"メッセージの保存に失敗しました"},{status:400});return n.Z.json({message:"メッセージが送信されました",chat_message:_},{status:201})}catch(e){return console.error("チャット送信エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function c(e){try{let{searchParams:t}=new URL(e.url),s=t.get("project_id");if(!s)return n.Z.json({message:"案件IDが必要です"},{status:400});let r=e.headers.get("authorization");if(!r)return n.Z.json({message:"認証が必要です"},{status:401});let a=r.replace("Bearer ",""),{data:{user:i},error:o}=await u.auth.getUser(a);if(o||!i)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:d,error:c}=await u.from("users").select("id, email, display_name").eq("auth_user_id",i.id).single();if(c||!d)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:l,error:m}=await u.from("projects").select("id, title, org_id, contractor_id").eq("id",s).single();if(m||!l)return n.Z.json({message:"案件が見つかりません"},{status:404});let{data:g}=await u.from("memberships").select("org_id, role").eq("user_id",d.id).single();if(!(g?.org_id===l.org_id||l.contractor_id===d.id))return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});let{data:p,error:_}=await u.from("chat_messages").select(`
        id,
        message,
        sender_type,
        created_at,
        users!chat_messages_sender_id_fkey (
          display_name,
          email
        )
      `).eq("project_id",s).order("created_at",{ascending:!0});if(_)return console.error("メッセージ取得エラー:",_),n.Z.json({message:"メッセージの取得に失敗しました"},{status:400});let h=p?.map(e=>({id:e.id,message:e.message,sender_type:e.sender_type,sender_name:e.users?.display_name||"Unknown",created_at:e.created_at}))||[];return n.Z.json({messages:h},{status:200})}catch(e){return console.error("チャット取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:p,headerHooks:_,staticGenerationBailout:h}=l,f="/api/chat/route";function j(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[1638,6206,2409],()=>s(82777));module.exports=r})();