"use strict";(()=>{var e={};e.id=1505,e.ids=[1505],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},65216:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>f,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>g});var s={};r.r(s),r.d(s,{POST:()=>c});var a=r(95419),i=r(69108),o=r(99678),n=r(78070);let u=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function c(e){try{let{room_id:t,user_emails:r}=await e.json();if(!t||!r||!Array.isArray(r))return n.Z.json({message:"必須項目が入力されていません"},{status:400});let s=t.replace("project_",""),a=e.headers.get("authorization");if(!a)return n.Z.json({message:"認証が必要です"},{status:401});let i=a.replace("Bearer ",""),{data:{user:o},error:c}=await u.auth.getUser(i);if(c||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:l,error:p}=await u.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(p||!l)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:d,error:m}=await u.from("projects").select("id, title, org_id, contractor_id").eq("id",s).single();if(m||!d)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:h}=await u.from("memberships").select("org_id, role").eq("user_id",l.id).single();if(h?.org_id!==d.org_id)return n.Z.json({message:"この操作を行う権限がありません（発注者側のメンバーのみ招待可能）"},{status:403});let{data:g,error:f}=await u.from("chat_rooms").select("id").eq("project_id",s).single();if(f||!g){let{data:e,error:t}=await u.from("chat_rooms").insert({project_id:s,name:d.title,description:`${d.title}のチャットルーム`,created_by:l.id}).select("id").single();if(t)return n.Z.json({message:"チャットルームの作成に失敗しました"},{status:400});g=e}let{data:_,error:j}=await u.from("users").select("id, email, display_name").in("email",r);if(j)return n.Z.json({message:"ユーザー検索に失敗しました"},{status:400});let q=_?.map(e=>e.email)||[],w=r.filter(e=>!q.includes(e)),v=[];for(let e of _||[])try{let{data:t}=await u.from("chat_participants").select("id").eq("room_id",g.id).eq("user_id",e.id).single();if(t)v.push({email:e.email,success:!0,message:"既にチャットルームに参加しています"});else{let{error:t}=await u.from("chat_participants").insert({room_id:g.id,user_id:e.id,role:"member"});t?(console.error("参加者追加エラー:",t),v.push({email:e.email,success:!1,error:"参加者の追加に失敗しました"})):v.push({email:e.email,success:!0,message:"チャットルームに招待されました"})}}catch(t){console.error("招待処理エラー:",t),v.push({email:e.email,success:!1,error:"招待処理中にエラーが発生しました"})}for(let e of w)v.push({email:e,success:!1,error:"ユーザーが見つかりません"});return n.Z.json({message:"招待処理が完了しました",results:v},{status:200})}catch(e){return console.error("参加者招待エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/participants/invite/route",pathname:"/api/chat/participants/invite",filename:"route",bundlePath:"app/api/chat/participants/invite/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/participants/invite/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:m,headerHooks:h,staticGenerationBailout:g}=l,f="/api/chat/participants/invite/route";function _(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(65216));module.exports=s})();