"use strict";(()=>{var e={};e.id=8702,e.ids=[8702],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},63466:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>_,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var a={};r.r(a),r.d(a,{GET:()=>l});var i=r(95419),s=r(69108),o=r(99678),n=r(78070);let d=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("room_id");if(!r)return n.Z.json({message:"ルームIDが必要です"},{status:400});let a=r.replace("project_",""),i=e.headers.get("authorization");if(!i)return n.Z.json({message:"認証が必要です"},{status:401});let s=i.replace("Bearer ",""),{data:{user:o},error:l}=await d.auth.getUser(s);if(l||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:u,error:c}=await d.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(c||!u)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:p,error:_}=await d.from("projects").select("id, title, org_id, contractor_id").eq("id",a).single();if(_||!p)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:m}=await d.from("memberships").select("org_id, role").eq("user_id",u.id).single();if(!(m?.org_id===p.org_id||p.contractor_id===u.id))return n.Z.json({message:"このプロジェクトへのアクセス権限がありません"},{status:403});let g=[],{data:h,error:f}=await d.from("chat_rooms").select("id").eq("project_id",a).single();if(f||!h){if(p.contractor_id){let{data:e}=await d.from("users").select("id, display_name, email").eq("id",p.contractor_id).single();e&&g.push({id:e.id,email:e.email,display_name:e.display_name,role:"contractor",org_role:null,joined_at:new Date().toISOString(),is_active:!0})}}else{let{data:e}=await d.from("chat_participants").select(`
          user_id,
          role,
          joined_at,
          is_active,
          users:user_id (
            id,
            display_name,
            email
          )
        `).eq("room_id",h.id).eq("is_active",!0);if(e)for(let t of e){let e=t.user_id===p.contractor_id,r=null;if(!e){let{data:e}=await d.from("memberships").select("role").eq("user_id",t.user_id).eq("org_id",p.org_id).single();r=e?.role}g.push({id:t.users.id,email:t.users.email,display_name:t.users.display_name,role:e?"contractor":"client",org_role:r,joined_at:t.joined_at,is_active:t.is_active})}if(p.contractor_id&&!g.some(e=>e.id===p.contractor_id)){let{data:e}=await d.from("users").select("id, display_name, email").eq("id",p.contractor_id).single();e&&g.push({id:e.id,email:e.email,display_name:e.display_name,role:"contractor",org_role:null,joined_at:new Date().toISOString(),is_active:!0})}}return n.Z.json({participants:g},{status:200})}catch(e){return console.error("参加者取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let u=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/chat/participants/route",pathname:"/api/chat/participants",filename:"route",bundlePath:"app/api/chat/participants/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/participants/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:_,headerHooks:m,staticGenerationBailout:g}=u,h="/api/chat/participants/route";function f(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:p})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2409],()=>r(63466));module.exports=a})();