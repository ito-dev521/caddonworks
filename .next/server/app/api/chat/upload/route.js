"use strict";(()=>{var e={};e.id=339,e.ids=[339],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},56835:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>g,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>f});var s={};a.r(s),a.d(s,{POST:()=>l});var r=a(95419),i=a(69108),o=a(99678),n=a(78070);let p=(0,a(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function l(e){try{let t=await e.formData(),a=t.get("file"),s=t.get("roomId"),r=t.get("comment");if(!a||!s)return n.Z.json({message:"ファイルとルームIDが必要です"},{status:400});let i=e.headers.get("authorization");if(!i)return n.Z.json({message:"認証が必要です"},{status:401});let o=i.replace("Bearer ",""),{data:{user:l},error:c}=await p.auth.getUser(o);if(c||!l)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:u,error:d}=await p.from("users").select("id, email, display_name").eq("auth_user_id",l.id).single();if(d||!u)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let m=s.replace("project_",""),{data:g,error:f}=await p.from("projects").select("id, title, org_id, contractor_id").eq("id",m).single();if(f||!g)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:h}=await p.from("memberships").select("org_id, role").eq("user_id",u.id).single();if(!(h?.org_id===g.org_id||g.contractor_id===u.id))return n.Z.json({message:"このプロジェクトへのアクセス権限がありません"},{status:403});if(a.size>104857600)return n.Z.json({message:"ファイルサイズが大きすぎます（100MB以下にしてください）"},{status:400});let _=a.name.split(".").pop()?.toLowerCase(),x=["dwg","p21","sfc","bfo","step","stp","iges","igs"].includes(_||"");if(!["image/jpeg","image/png","image/gif","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","application/zip","application/x-zip-compressed","application/dwg","application/x-dwg","application/acad","application/x-acad","application/step","application/x-step","application/iges","application/x-iges","application/octet-stream"].includes(a.type)&&!x)return n.Z.json({message:"サポートされていないファイル形式です"},{status:400});let w=a.name.split(".").pop(),j=`${Date.now()}-${Math.random().toString(36).substring(2)}.${w}`,y=`chat-attachments/${s}/${j}`,{data:q,error:v}=await p.storage.from("attachments").upload(y,a,{cacheControl:"3600",upsert:!1});if(v)return console.error("ファイルアップロードエラー:",v),n.Z.json({message:"ファイルのアップロードに失敗しました: "+v.message},{status:400});let{data:{publicUrl:Z}}=p.storage.from("attachments").getPublicUrl(y),z=h?.org_id===g.org_id?"client":"contractor",P=r.trim()?r:a.name,{data:b,error:S}=await p.from("chat_messages").insert({project_id:m,sender_id:u.id,sender_type:z,message:P,file_url:Z,file_name:a.name,file_size:a.size,message_type:a.type.startsWith("image/")?"image":"file"}).select().single();if(S)return console.error("チャットメッセージ保存エラー:",S),n.Z.json({message:"メッセージの保存に失敗しました: "+S.message},{status:400});return n.Z.json({message:"ファイルがアップロードされました",file:{id:b.id,name:a.name,url:Z,size:a.size,type:a.type.startsWith("image/")?"image":"file"}})}catch(e){return console.error("ファイルアップロードAPI エラー:",e),n.Z.json({message:"サーバーエラーが発生しました: "+(e instanceof Error?e.message:"不明なエラー")},{status:500})}}let c=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/upload/route",pathname:"/api/chat/upload",filename:"route",bundlePath:"app/api/chat/upload/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/upload/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:u,staticGenerationAsyncStorage:d,serverHooks:m,headerHooks:g,staticGenerationBailout:f}=c,h="/api/chat/upload/route";function _(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>a(56835));module.exports=s})();