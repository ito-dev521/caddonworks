"use strict";(()=>{var e={};e.id=339,e.ids=[339],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},56835:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>c,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{POST:()=>u});var a=r(95419),o=r(69108),i=r(99678),n=r(78070);let p=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{let t=await e.formData(),r=t.get("file"),s=t.get("roomId"),a=t.get("comment");if(!r||!s)return n.Z.json({message:"ファイルとルームIDが必要です"},{status:400});let o=e.headers.get("authorization");if(!o)return n.Z.json({message:"認証が必要です"},{status:401});let i=o.replace("Bearer ",""),{data:{user:u},error:l}=await p.auth.getUser(i);if(l||!u)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:d,error:m}=await p.from("users").select("id, email, display_name").eq("auth_user_id",u.id).single();if(m||!d)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let c=s.replace("project_",""),g=t.get("reply_to"),{data:f,error:h}=await p.from("projects").select("id, title, org_id, contractor_id").eq("id",c).single();if(h||!f)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:_}=await p.from("memberships").select("org_id, role").eq("user_id",d.id).single();if(!(_?.org_id===f.org_id||f.contractor_id===d.id))return n.Z.json({message:"このプロジェクトへのアクセス権限がありません"},{status:403});let v=r.type.startsWith("video/");if(r.size>(v?314572800:104857600))return n.Z.json({message:`ファイルサイズが大きすぎます（${v?"300MB":"100MB"}以下にしてください）`},{status:400});let j=r.name.split(".").pop()?.toLowerCase(),w=["jpg","jpeg","png","gif","webp","mp4","avi","mov","wmv","flv","webm","mkv","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","zip","dwg","p21","sfc","bfo","step","stp","iges","igs"].includes(j||"");if(["mp4","avi","mov","wmv","flv","webm","mkv"].includes(j||""),!w)return n.Z.json({message:"サポートされていないファイル形式です"},{status:400});let x=r.name.split(".").pop(),y=`${Date.now()}-${Math.random().toString(36).substring(2)}.${x}`,q=`chat-attachments/${s}/${y}`,Z=v?"project-attachments":"attachments",{data:b,error:P}=await p.storage.from(Z).upload(q,r,{cacheControl:"3600",upsert:!1,contentType:"application/octet-stream"});if(P)return console.error("ファイルアップロードエラー:",P),n.Z.json({message:"ファイルのアップロードに失敗しました: "+P.message},{status:400});let{data:{publicUrl:z}}=p.storage.from(Z).getPublicUrl(q),k=_?.org_id===f.org_id?"client":"contractor",S=a.trim()?a:r.name,{data:A,error:E}=await p.from("chat_messages").insert({project_id:c,sender_id:d.id,sender_type:k,message:S,file_url:z,file_name:r.name,file_size:r.size,reply_to:g||null,message_type:r.type.startsWith("image/")?"image":r.type.startsWith("video/")?"video":"file"}).select().single();if(E)return console.error("チャットメッセージ保存エラー:",E),n.Z.json({message:"メッセージの保存に失敗しました: "+E.message},{status:400});return n.Z.json({message:"ファイルがアップロードされました",file:{id:A.id,name:r.name,url:z,size:r.size,type:r.type.startsWith("image/")?"image":"file"}})}catch(e){return console.error("ファイルアップロードAPI エラー:",e),n.Z.json({message:"サーバーエラーが発生しました: "+(e instanceof Error?e.message:"不明なエラー")},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/upload/route",pathname:"/api/chat/upload",filename:"route",bundlePath:"app/api/chat/upload/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/upload/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:c,headerHooks:g,staticGenerationBailout:f}=l,h="/api/chat/upload/route";function _(){return(0,i.patchFetch)({serverHooks:c,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(56835));module.exports=s})();