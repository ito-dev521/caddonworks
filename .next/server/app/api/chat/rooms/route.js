"use strict";(()=>{var e={};e.id=5996,e.ids=[5996],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},89308:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>j,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{GET:()=>u,POST:()=>c});var a=r(95419),o=r(69108),i=r(99678),n=r(78070);let d=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),{data:{user:s},error:a}=await d.auth.getUser(r);if(a||!s)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:i}=await d.from("users").select("id, email, display_name").eq("auth_user_id",s.id).single();if(i||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:u,error:c}=await d.from("contracts").select(`
        project_id,
        status,
        projects (
          id,
          title,
          description,
          status,
          org_id,
          contractor_id,
          organizations (
            name
          )
        )
      `).eq("status","signed");if(c)return console.error("契約取得エラー:",c),n.Z.json({message:"契約の取得に失敗しました"},{status:400});let{data:l}=await d.from("memberships").select("org_id, role").eq("user_id",o.id).single(),p=u?.filter(e=>{let t=e.projects;return console.log("chat-rooms API: プロジェクトフィルタリング",{project_id:t?.id,project_title:t?.title,org_id:t?.org_id,contractor_id:t?.contractor_id,user_id:o.id,membership_org_id:l?.org_id,membership_role:l?.role}),t&&(l?.org_id===t.org_id||t.contractor_id===o.id)}).map(e=>e.projects)||[],m=await Promise.all(p.map(async e=>{let{data:t}=await d.from("chat_messages").select(`
            message,
            created_at,
            users:sender_id (
              display_name,
              email
            )
          `).eq("project_id",e.id).order("created_at",{ascending:!1}).limit(1).single();return{id:`project_${e.id}`,name:e.title,description:e.description,project_id:e.id,project_name:e.title,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_active:"in_progress"===e.status,participant_count:2,unread_count:0,last_message:t?{content:t.message,sender_name:t.users?.display_name||"Unknown",created_at:t.created_at}:null}}));return n.Z.json({rooms:m},{status:200})}catch(e){return console.error("チャットルーム取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function c(e){try{let{project_id:t,name:r,description:s}=await e.json();if(!t||!r)return n.Z.json({message:"必須項目が入力されていません"},{status:400});let a=e.headers.get("authorization");if(!a)return n.Z.json({message:"認証が必要です"},{status:401});let o=a.replace("Bearer ",""),{data:{user:i},error:u}=await d.auth.getUser(o);if(u||!i)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:l}=await d.from("users").select("id, email, display_name").eq("auth_user_id",i.id).single();if(l||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:p,error:m}=await d.from("projects").select("id, title, org_id, contractor_id").eq("id",t).single();if(m||!p)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:_}=await d.from("memberships").select("org_id, role").eq("user_id",c.id).single();if(!(_?.org_id===p.org_id||p.contractor_id===c.id))return n.Z.json({message:"このプロジェクトへのアクセス権限がありません"},{status:403});return n.Z.json({message:"チャットルームが作成されました",room:{id:`project_${p.id}`,name:r,description:s,project_id:t,created_at:new Date().toISOString()}},{status:201})}catch(e){return console.error("チャットルーム作成エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/rooms/route",pathname:"/api/chat/rooms",filename:"route",bundlePath:"app/api/chat/rooms/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/chat/rooms/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:_,headerHooks:g,staticGenerationBailout:h}=l,j="/api/chat/rooms/route";function f(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(89308));module.exports=s})();