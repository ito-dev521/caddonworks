"use strict";(()=>{var e={};e.id=384,e.ids=[384],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},94782:(e,s,t)=>{t.r(s),t.d(s,{headerHooks:()=>m,originalPathname:()=>h,patchFetch:()=>j,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>I,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>g});var r={};t.r(r),t.d(r,{POST:()=>c});var i=t(95419),a=t(69108),o=t(99678),n=t(78070);let u=(0,t(6517).ST)();async function c(e,{params:s}){try{let{id:t}=s,r=e.headers.get("authorization");if(!r)return n.Z.json({message:"認証が必要です"},{status:401});let i=r.replace("Bearer ",""),{data:{user:a},error:o}=await u.auth.getUser(i);if(o||!a)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:d}=await u.from("users").select("id").eq("auth_user_id",a.id).single();if(d||!c)return n.Z.json({message:"ユーザー情報の取得に失敗しました"},{status:400});let{data:p,error:l}=await u.from("invoices").select(`
        id,
        contractor_id,
        status,
        projects (
          id,
          title,
          org_id
        )
      `).eq("id",t).single();if(l||!p)return n.Z.json({message:"請求書が見つかりません"},{status:404});if(p.contractor_id!==c.id)return n.Z.json({message:"この請求書を発行する権限がありません"},{status:403});if("draft"!==p.status)return n.Z.json({message:"この請求書は既に発行済みです"},{status:400});let{data:I,error:m}=await u.from("invoices").update({status:"issued",issue_date:new Date().toISOString().split("T")[0]}).eq("id",t).select().single();if(m)return console.error("請求書発行エラー:",m),n.Z.json({message:"請求書の発行に失敗しました"},{status:500});let{error:g}=await u.from("notifications").insert({user_id:p.projects?.org_id,title:"請求書が発行されました",message:`案件「${p.projects?.title}」の請求書が発行されました。支払いをお願いします。`,type:"invoice_issued",related_id:t});return g&&console.error("通知作成エラー:",g),n.Z.json({message:"請求書が正常に発行されました",invoice:I})}catch(e){return console.error("請求書発行エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/invoices/[id]/issue/route",pathname:"/api/invoices/[id]/issue",filename:"route",bundlePath:"app/api/invoices/[id]/issue/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/invoices/[id]/issue/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:I,headerHooks:m,staticGenerationBailout:g}=d,h="/api/invoices/[id]/issue/route";function j(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:l})}},6517:(e,s,t)=>{t.d(s,{OQ:()=>i,ST:()=>a});var r=t(32409);let i=(0,r.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),a=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,r.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var s=require("../../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[1638,6206,2409],()=>t(94782));module.exports=r})();