"use strict";(()=>{var e={};e.id=1243,e.ids=[1243],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},60172:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>d});var a=r(95419),o=r(69108),i=r(99678),n=r(78070),u=r(32409);async function d(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),s=(0,u.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:o}=await s.auth.getUser(r);if(o||!a)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:i,error:d}=await s.from("users").select("id").eq("auth_user_id",a.id).single();if(d||!i)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{project_id:c,type:l}=await e.json();if(!c||!l)return n.Z.json({message:"プロジェクトIDとタイプが必要です"},{status:400});let{data:g,error:m}=await s.from("projects").select("*").eq("id",c).single();if(m||!g)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:p,error:_}=await s.from("memberships").select("role, org_id").eq("user_id",i.id).single();if(_||!p)return n.Z.json({message:"組織情報が見つかりません"},{status:403});if("OrgAdmin"!==p.role||g.org_id!==p.org_id)return n.Z.json({message:"請求書を作成する権限がありません"},{status:403});let{data:f,error:h}=await s.from("users").select("id, display_name, email").eq("id",g.contractor_id).single();if(h||!f)return n.Z.json({message:"受注者情報が見つかりません"},{status:404});let{data:w,error:j}=await s.from("organizations").select("name, contact_person, address, phone, email").eq("id",p.org_id).single();if(j||!w)return n.Z.json({message:"組織情報が見つかりません"},{status:404});let S=`INV-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,v={id:crypto.randomUUID(),project_id:c,invoice_number:S,contractor_id:g.contractor_id,org_id:g.org_id,amount:g.budget,tax_rate:.1,tax_amount:Math.floor(.1*g.budget),total_amount:Math.floor(1.1*g.budget),issue_date:new Date().toISOString(),due_date:new Date(Date.now()+2592e6).toISOString(),status:"issued",description:`案件「${g.title}」の完了に伴う請求書`,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),billing_details:{project_title:g.title,project_description:g.description,contract_period:`${g.start_date} - ${g.end_date}`,contractor_name:f.display_name,contractor_email:f.email,organization_name:w.name,organization_contact:w.contact_person,organization_address:w.address,organization_phone:w.phone,organization_email:w.email}},{error:q}=await s.from("invoices").insert(v);if(q)return console.error("請求書作成エラー:",q),n.Z.json({message:"請求書の作成に失敗しました"},{status:500});let{error:Z}=await s.from("notifications").insert({user_id:g.contractor_id,title:"請求書が発行されました",message:`案件「${g.title}」の請求書（${S}）が発行されました。`,type:"invoice",related_id:c,created_at:new Date().toISOString()});return Z&&console.error("通知作成エラー:",Z),n.Z.json({message:"請求書が正常に作成されました",invoice:v},{status:201})}catch(e){return console.error("請求書作成APIエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function c(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),s=(0,u.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:o}=await s.auth.getUser(r);if(o||!a)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:i,error:d}=await s.from("users").select("id").eq("auth_user_id",a.id).single();if(d||!i)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:c,error:l}=await s.from("memberships").select("role, org_id").eq("user_id",i.id).single();if(l||!c)return n.Z.json({message:"組織情報が見つかりません"},{status:403});let g=s.from("invoices").select("*");if("OrgAdmin"===c.role)g=g.eq("org_id",c.org_id);else{if("Contractor"!==c.role)return n.Z.json({message:"アクセス権限がありません"},{status:403});g=g.eq("contractor_id",i.id)}let{data:m,error:p}=await g.order("created_at",{ascending:!1});if(p)return console.error("請求書取得エラー:",p),n.Z.json({message:"請求書の取得に失敗しました"},{status:500});return n.Z.json({invoices:m||[]},{status:200})}catch(e){return console.error("請求書取得APIエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/invoices/route",pathname:"/api/invoices",filename:"route",bundlePath:"app/api/invoices/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/invoices/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:p,headerHooks:_,staticGenerationBailout:f}=l,h="/api/invoices/route";function w(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(60172));module.exports=s})();