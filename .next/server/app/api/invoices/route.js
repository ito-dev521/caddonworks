"use strict";(()=>{var e={};e.id=1243,e.ids=[1243],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},60172:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var s={};r.r(s),r.d(s,{GET:()=>d,POST:()=>c});var a=r(95419),i=r(69108),o=r(99678),n=r(78070),u=r(6517);async function c(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),s=(0,u.ST)(),{data:{user:a},error:i}=await s.auth.getUser(r);if(i||!a)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:c}=await s.from("users").select("id").eq("auth_user_id",a.id).single();if(c||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{project_id:d,type:l}=await e.json();if(!d||!l)return n.Z.json({message:"プロジェクトIDとタイプが必要です"},{status:400});let{data:m,error:g}=await s.from("projects").select("*").eq("id",d).single();if(g||!m)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:p,error:f}=await s.from("memberships").select("role, org_id").eq("user_id",o.id).single();if(f||!p)return n.Z.json({message:"組織情報が見つかりません"},{status:403});if("OrgAdmin"!==p.role||m.org_id!==p.org_id)return n.Z.json({message:"請求書を作成する権限がありません"},{status:403});let{data:_,error:h}=await s.from("users").select("id, display_name, email").eq("id",m.contractor_id).single();if(h||!_)return n.Z.json({message:"受注者情報が見つかりません"},{status:404});let{data:I,error:j}=await s.from("organizations").select("name, contact_person, address, phone, email").eq("id",p.org_id).single();if(j||!I)return n.Z.json({message:"組織情報が見つかりません"},{status:404});let{data:w,error:Z}=await s.from("contracts").select("id, status, bid_amount").eq("project_id",d).eq("contractor_id",m.contractor_id).eq("status","signed").single();if(Z||!w)return n.Z.json({message:"契約が見つかりません"},{status:404});let{data:q,error:v}=await s.from("invoices").select("id, status").eq("contract_id",w.id);if(v)return console.error("既存請求書確認エラー:",v),n.Z.json({message:"既存請求書の確認に失敗しました"},{status:500});if(q&&q.length>0){let e=q[0];return n.Z.json({message:"請求書は既に作成済みです",invoice:e},{status:200})}new Date().getFullYear(),String(Date.now()).slice(-6);let b=w.bid_amount||m.budget||0,y=b+5e4,z={client_org_id:m.org_id,base_amount:b,fee_amount:0,system_fee:5e4,total_amount:y,status:"draft",issue_date:null,due_date:new Date(Date.now()+2592e6).toISOString().split("T")[0],org_id:m.org_id,contractor_id:m.contractor_id,contract_id:w.id},{data:S,error:x}=await s.from("invoices").insert(z).select().single();if(x)return console.error("請求書作成エラー:",x),n.Z.json({message:"請求書の作成に失敗しました",error:x.message,details:x},{status:500});let{error:J}=await s.from("notifications").insert({user_id:m.contractor_id,title:"請求書が作成されました",message:`案件「${m.title}」の請求書が作成されました。内容を確認して発行してください。金額: \xa5${y.toLocaleString()}`,type:"invoice"});return J&&console.error("通知作成エラー:",J),n.Z.json({message:"請求書が正常に作成されました。受注者に通知が送信されます。",invoice:z},{status:201})}catch(e){return console.error("請求書作成エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function d(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),s=(0,u.ST)(),{data:{user:a},error:i}=await s.auth.getUser(r);if(i||!a)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:c}=await s.from("users").select("id").eq("auth_user_id",a.id).single();if(c||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:d,error:l}=await s.from("memberships").select("role, org_id").eq("user_id",o.id).single();if(l||!d)return n.Z.json({message:"組織情報が見つかりません"},{status:403});let m=s.from("invoices").select("*");if("OrgAdmin"===d.role)m=m.eq("org_id",d.org_id);else{if("Contractor"!==d.role)return n.Z.json({message:"アクセス権限がありません"},{status:403});m=m.eq("contractor_id",o.id)}let{data:g,error:p}=await m.order("created_at",{ascending:!1});if(p)return console.error("請求書取得エラー:",p),n.Z.json({message:"請求書の取得に失敗しました"},{status:500});return n.Z.json({invoices:g||[]},{status:200})}catch(e){return console.error("請求書取得APIエラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/invoices/route",pathname:"/api/invoices",filename:"route",bundlePath:"app/api/invoices/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/invoices/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:p,headerHooks:f,staticGenerationBailout:_}=l,h="/api/invoices/route";function I(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>a,ST:()=>i});var s=r(32409);let a=(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),i=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(60172));module.exports=s})();