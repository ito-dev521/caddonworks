"use strict";(()=>{var e={};e.id=8174,e.ids=[8174],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},98790:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>j,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>I});var a={};r.r(a),r.d(a,{GET:()=>d,POST:()=>u});var s=r(95419),o=r(69108),i=r(99678),n=r(78070);let c=(0,r(6517).ST)();async function u(e){try{let{project_id:t,contract_id:r,contractor_id:a,deadline_score:s,quality_score:o,communication_score:i,understanding_score:u,professionalism_score:d,comment:l}=await e.json();if(!t||!r||!a)return n.Z.json({message:"必須フィールドが不足しています"},{status:400});if([s,o,i,u,d].some(e=>!e||e<1||e>5))return n.Z.json({message:"すべての評価項目で1-5のスコアを選択してください"},{status:400});let m=e.headers.get("authorization");if(!m)return n.Z.json({message:"認証が必要です"},{status:401});let p=m.replace("Bearer ",""),{data:{user:g},error:_}=await c.auth.getUser(p);if(_||!g)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:I,error:j}=await c.from("users").select("id, display_name").eq("auth_user_id",g.id).single();if(j||!I)return n.Z.json({message:"ユーザー情報の取得に失敗しました"},{status:400});let{data:f,error:h}=await c.from("projects").select("id, title, org_id, contractor_id").eq("id",t).single();if(h||!f)return n.Z.json({message:"プロジェクトが見つかりません"},{status:404});let{data:v,error:w}=await c.from("contracts").select("id, contractor_id, org_id").eq("id",r).single();if(w||!v)return n.Z.json({message:"契約が見つかりません"},{status:404});let{data:Z,error:q}=await c.from("memberships").select("role").eq("user_id",I.id).eq("org_id",f.org_id).single();if(q||!Z)return n.Z.json({message:"このプロジェクトを評価する権限がありません"},{status:403});if(v.contractor_id!==a)return n.Z.json({message:"契約の受注者IDが一致しません"},{status:400});let{data:y,error:z}=await c.from("contractor_evaluations").select("id").eq("project_id",t).eq("evaluator_id",I.id).single();if(z&&"PGRST116"!==z.code)return n.Z.json({message:"評価の確認中にエラーが発生しました"},{status:500});if(y)return n.Z.json({message:"このプロジェクトは既に評価済みです"},{status:400});let{data:x,error:J}=await c.from("contractor_evaluations").insert({project_id:t,contract_id:r,contractor_id:a,evaluator_id:I.id,deadline_score:s,quality_score:o,communication_score:i,understanding_score:u,professionalism_score:d,comment:l||null}).select().single();if(J)return console.error("評価保存エラー:",J),n.Z.json({message:"評価の保存に失敗しました: "+J.message},{status:500});let{data:b,error:M}=await c.from("users").select("id, display_name").eq("id",a).single();return!M&&b&&await c.from("notifications").insert({user_id:b.id,type:"evaluation_received",title:"新しい評価を受け取りました",message:`案件「${f.title}」で評価を受け取りました。プロフィールで確認できます。`,data:{project_id:t,contract_id:r,evaluation_id:x.id,average_score:x.average_score}}),n.Z.json({message:"評価が正常に保存されました",evaluation:{id:x.id,average_score:x.average_score}},{status:201})}catch(e){return console.error("評価保存エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("contractor_id"),a=t.get("project_id"),s=e.headers.get("authorization");if(!s)return n.Z.json({message:"認証が必要です"},{status:401});let o=s.replace("Bearer ",""),{data:{user:i},error:u}=await c.auth.getUser(o);if(u||!i)return n.Z.json({message:"認証に失敗しました"},{status:401});let d=c.from("contractor_evaluations").select(`
        id,
        project_id,
        contract_id,
        contractor_id,
        evaluator_id,
        deadline_score,
        quality_score,
        communication_score,
        understanding_score,
        professionalism_score,
        average_score,
        comment,
        created_at,
        projects!inner(title, org_id),
        evaluator:users!evaluator_id(display_name)
      `);r&&(d=d.eq("contractor_id",r)),a&&(d=d.eq("project_id",a));let{data:l,error:m}=await d.order("created_at",{ascending:!1});if(m)return console.error("評価取得エラー:",m),n.Z.json({message:"評価の取得に失敗しました"},{status:500});return n.Z.json({evaluations:l})}catch(e){return console.error("評価取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/evaluations/contractor/route",pathname:"/api/evaluations/contractor",filename:"route",bundlePath:"app/api/evaluations/contractor/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/evaluations/contractor/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:_,staticGenerationBailout:I}=l,j="/api/evaluations/contractor/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>s,ST:()=>o});var a=r(32409);let s=(0,a.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),o=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,a.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2409],()=>r(98790));module.exports=a})();