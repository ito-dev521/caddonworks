"use strict";(()=>{var e={};e.id=8731,e.ids=[8731],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},22661:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>_,patchFetch:()=>j,requestAsyncStorage:()=>u,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>I});var i={};r.r(i),r.d(i,{POST:()=>n});var s=r(95419),o=r(69108),a=r(99678),d=r(78070),c=r(6517);async function n(e){try{let e=(0,c.ST)(),t=new Date().toISOString(),{data:r,error:i}=await e.from("projects").select(`
        id,
        title,
        org_id,
        bidding_deadline,
        required_contractors,
        organizations (
          id,
          name
        )
      `).eq("status","bidding").lt("bidding_deadline",t);if(i)return d.Z.json({message:"期限切れ案件の取得に失敗しました"},{status:400});let s=[];for(let i of r||[])try{let{data:r,error:o}=await e.from("bids").select("id").eq("project_id",i.id).eq("status","submitted");if(o){s.push({project_id:i.id,project_title:i.title,status:"error",message:"入札数の取得に失敗しました"});continue}let a=r?.length||0,d=i.required_contractors||1;if(a<d){let{data:r,error:o}=await e.from("memberships").select(`
              user_id,
              role,
              users (
                id,
                display_name,
                email
              )
            `).eq("org_id",i.org_id).eq("role","OrgAdmin");if(o){s.push({project_id:i.id,project_title:i.title,status:"error",message:"組織メンバーの取得に失敗しました"});continue}let c=function(e,t,r){let i=r-t;return 0===t?"応募者がいませんでした。単価の見直しや納期の延長、要件の緩和を検討してください。":1===i?"あと1名の応募が必要でした。単価を10-20%上げるか、納期を1-2週間延長することをお勧めします。":i<=3?`あと${i}名の応募が必要でした。単価を15-25%上げるか、納期を2-4週間延長することをお勧めします。`:`大幅な応募不足です（${i}名不足）。単価を20-30%上げるか、納期を1ヶ月以上延長し、要件を見直すことをお勧めします。`}(0,a,d);for(let t of r||[]){let{error:r}=await e.from("notifications").insert({user_id:t.user_id,type:"project_expired",title:"案件の募集期限が切れました",message:`案件「${i.title}」の募集期限が切れました。応募者数: ${a}/${d}人。${c}`,data:{project_id:i.id,project_title:i.title,bid_count:a,required_contractors:d,advice:c},is_read:!1});r&&console.error("通知作成エラー:",r)}let{error:n}=await e.from("projects").update({status:"expired",updated_at:t}).eq("id",i.id);n&&console.error("案件ステータス更新エラー:",n),s.push({project_id:i.id,project_title:i.title,status:"notified",message:`応募者数不足 (${a}/${d}) - 発注者に通知しました`,advice:c})}else s.push({project_id:i.id,project_title:i.title,status:"sufficient_bids",message:`十分な応募があります (${a}/${d})`})}catch(e){s.push({project_id:i.id,project_title:i.title,status:"error",message:"予期しないエラーが発生しました"})}return d.Z.json({message:"期限切れ案件のチェックが完了しました",results:s},{status:200})}catch(e){return console.error("期限切れ案件チェックエラー:",e),d.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/jobs/check-expired/route",pathname:"/api/jobs/check-expired",filename:"route",bundlePath:"app/api/jobs/check-expired/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/jobs/check-expired/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:l,serverHooks:m,headerHooks:h,staticGenerationBailout:I}=p,_="/api/jobs/check-expired/route";function j(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>s,ST:()=>o});var i=r(32409);let s=(0,i.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),o=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,i.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[1638,6206,2409],()=>r(22661));module.exports=i})();