"use strict";(()=>{var e={};e.id=4204,e.ids=[4204],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},54579:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>b,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>m});var a={};r.r(a),r.d(a,{GET:()=>u});var i=r(95419),s=r(69108),n=r(99678),o=r(78070);let d=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{let t=e.headers.get("authorization");if(!t)return o.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),{data:{user:a},error:i}=await d.auth.getUser(r);if(i||!a)return console.error("jobs API: 認証エラー:",i),o.Z.json({message:"認証に失敗しました: "+(i?.message||"ユーザーが見つかりません")},{status:401});let{data:s,error:n}=await d.from("users").select("id, email, display_name, specialties, experience_years, member_level").eq("auth_user_id",a.id).single();if(n||!s)return console.error("jobs API: ユーザープロフィールエラー:",n),o.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let u=s.member_level||function(e,t){if(0===t.length||t.every(e=>"未経験"===e))return"beginner";let r=parseInt(e||"0",10);return r<3?"beginner":r<7?"intermediate":"advanced"}(s.experience_years,s.specialties||[]),{data:c,error:l}=await d.from("projects").select(`
        id,
        title,
        description,
        status,
        budget,
        start_date,
        end_date,
        category,
        created_at,
        assignee_name,
        bidding_deadline,
        requirements,
        location,
        org_id,
        required_contractors,
        contractor_id,
        required_level
      `).eq("status","bidding").order("created_at",{ascending:!1}),{data:_,error:p}=await d.from("contracts").select(`
        project_id,
        status,
        projects (
          id,
          title,
          description,
          status,
          budget,
          start_date,
          end_date,
          category,
          created_at,
          assignee_name,
          bidding_deadline,
          requirements,
          location,
          org_id,
          required_contractors,
          contractor_id,
          required_level
        )
      `).eq("status","signed").eq("contractor_id",s.id);if(l||p)return console.error("jobs API: 案件データ取得エラー:",{biddingError:l,contractsError:p}),o.Z.json({message:"案件データの取得に失敗しました"},{status:400});let g=_?.map(e=>e.projects).filter(Boolean)||[],m=[...c?.filter(e=>{let t=e.required_level||"beginner";return function(e,t){let r=["beginner","intermediate","advanced"];return r.indexOf(e)>=r.indexOf(t)}(u,t)})||[],...g],b=Array.from(new Set(m?.map(e=>e.org_id)||[])),{data:f}=await d.from("organizations").select("id, name").in("id",b),q=f?.reduce((e,t)=>(e[t.id]=t.name,e),{})||{},j=m?.map(e=>e.id)||[],{data:h}=await d.from("bids").select("project_id").in("project_id",j).eq("status","submitted"),v=h?.reduce((e,t)=>(e[t.project_id]=(e[t.project_id]||0)+1,e),{})||{},x=(m?.map(e=>{let t=v[e.id]||0,r=t>=(e.required_contractors||1),a=new Date,i=new Date(e.bidding_deadline)<a,s=function(e,t,r){if(r)return"期限が切れています。次回は早めの応募をお勧めします。";if(0===t)return"まだ応募者がいません。早めの応募で受注のチャンスが高まります。";let a=e.required_contractors||1;if(a-t<=0)return"募集人数に達しました。";let i=new Date,s=Math.ceil((new Date(e.bidding_deadline).getTime()-i.getTime())/864e5);if(s<=1)return"期限が迫っています。急いで応募してください。";if(s<=3)return"期限まで3日以内です。早めの応募をお勧めします。";let n=t/a;return n<.3?"競争率が低めです。受注のチャンスが高い案件です。":n<.7?"適度な競争があります。質の高い提案で差をつけましょう。":"競争が激しい案件です。差別化された提案が重要です。"}(e,t,i);return{id:e.id,title:e.title,description:e.description,status:e.status,budget:e.budget,start_date:e.start_date,end_date:e.end_date,category:e.category||"道路設計",created_at:e.created_at,org_name:q[e.org_id]||"不明な組織",org_id:e.org_id,assignee_name:e.assignee_name,bidding_deadline:e.bidding_deadline,requirements:e.requirements,location:e.location,required_contractors:e.required_contractors||1,required_level:e.required_level||"beginner",current_bid_count:t,is_full:r,is_expired:i,can_bid:!r&&!i&&"bidding"===e.status,advice:s}})||[]).filter(e=>!e.is_expired);return o.Z.json({jobs:x},{status:200})}catch(e){return console.error("jobs API: サーバーエラー:",e),o.Z.json({message:"サーバーエラーが発生しました: "+(e instanceof Error?e.message:"不明なエラー")},{status:500})}}let c=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/jobs/route",pathname:"/api/jobs",filename:"route",bundlePath:"app/api/jobs/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/jobs/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:_,serverHooks:p,headerHooks:g,staticGenerationBailout:m}=c,b="/api/jobs/route";function f(){return(0,n.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:_})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2409],()=>r(54579));module.exports=a})();