"use strict";(()=>{var e={};e.id=1645,e.ids=[1645],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},78395:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>g,patchFetch:()=>j,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>_});var a={};r.r(a),r.d(a,{GET:()=>u});var s=r(95419),o=r(69108),i=r(99678),n=r(78070);let c=(0,r(6517).ST)();async function u(e,{params:t}){try{let{id:r}=t,a=e.headers.get("authorization");if(!a)return n.Z.json({message:"認証が必要です"},{status:401});let s=a.replace("Bearer ",""),{data:{user:o},error:i}=await c.auth.getUser(s);if(i||!o)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:u,error:d}=await c.from("users").select("id, email, display_name").eq("auth_user_id",o.id).single();if(d||!u)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:p,error:l}=await c.from("projects").select("id, title, org_id, contractor_id").eq("id",r).single();if(l||!p)return n.Z.json({message:"案件が見つかりません"},{status:404});let m=!1;if(p.contractor_id===u.id&&(m=!0),!m){let{data:e,error:t}=await c.from("memberships").select("role").eq("user_id",u.id).eq("org_id",p.org_id).eq("role","Contractor").single();!t&&e&&(m=!0)}if(!m)return n.Z.json({message:"この案件へのアクセス権限がありません"},{status:403});let{data:h,error:_}=await c.from("project_attachments").select(`
        id,
        file_name,
        file_path,
        file_size,
        file_type,
        uploaded_by,
        created_at,
        users!project_attachments_uploaded_by_fkey (
          display_name
        )
      `).eq("project_id",r).order("created_at",{ascending:!1});if(_)return console.error("添付資料取得エラー:",_),n.Z.json({message:"添付資料の取得に失敗しました"},{status:500});let g=await Promise.all((h||[]).map(async e=>{let{data:{publicUrl:t}}=c.storage.from("project-attachments").getPublicUrl(e.file_path);return{...e,download_url:t,uploaded_by_name:e.users?.display_name||"不明"}}));return n.Z.json({attachments:g})}catch(e){return console.error("受注者添付資料取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/contractor/projects/[id]/attachments/route",pathname:"/api/contractor/projects/[id]/attachments",filename:"route",bundlePath:"app/api/contractor/projects/[id]/attachments/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/contractor/projects/[id]/attachments/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m,headerHooks:h,staticGenerationBailout:_}=d,g="/api/contractor/projects/[id]/attachments/route";function j(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>s,ST:()=>o});var a=r(32409);let s=(0,a.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),o=()=>(0,a.eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2409],()=>r(78395));module.exports=a})();