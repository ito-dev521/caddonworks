"use strict";(()=>{var e={};e.id=9970,e.ids=[9970],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},68690:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>j,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>u});var a=r(95419),o=r(69108),i=r(99678),n=r(78070);let d=(0,r(32409).eI)("https://rxnozwuamddqlcwysxag.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{let{project_id:t,bid_amount:r,proposal:s,budget_approved:a}=await e.json();if(!t||!r||void 0===a)return n.Z.json({message:"必須項目が入力されていません"},{status:400});if(!a)return n.Z.json({message:"発注者側の予算に同意してください"},{status:400});let o=e.headers.get("authorization");if(!o)return n.Z.json({message:"認証が必要です"},{status:401});let i=o.replace("Bearer ",""),{data:{user:u},error:l}=await d.auth.getUser(i);if(l||!u)return console.error("認証エラー:",l),n.Z.json({message:"認証に失敗しました"},{status:401});let{data:c,error:m}=await d.from("users").select("id, email, display_name").eq("auth_user_id",u.id).single();if(m||!c)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:p,error:g}=await d.from("memberships").select("role").eq("user_id",c.id);if(g||!p||0===p.length)return n.Z.json({message:"組織情報の取得に失敗しました"},{status:403});if(!p.some(e=>"Contractor"===e.role))return n.Z.json({message:"この操作を実行する権限がありません（受注者権限が必要です）"},{status:403});let{data:_,error:f}=await d.from("projects").select("id, status, bidding_deadline, required_contractors").eq("id",t).single();if(f||!_)return n.Z.json({message:"案件が見つかりません"},{status:404});if("bidding"!==_.status)return n.Z.json({message:"この案件は入札受付期間ではありません"},{status:400});if(_.bidding_deadline){let e=new Date(_.bidding_deadline);if(new Date>e)return n.Z.json({message:"入札締切を過ぎています"},{status:400})}let{data:j,error:b}=await d.from("bids").select("id").eq("project_id",t).eq("contractor_id",c.id).single();if(j)return n.Z.json({message:"既にこの案件に入札済みです"},{status:400});let{data:h,error:q}=await d.from("bids").select("id").eq("project_id",t).eq("status","approved");q&&console.error("承認済み入札数取得エラー:",q);let w=_.required_contractors||1,Z=h?.length||0;if(Z>=w)return n.Z.json({message:`この案件の募集は終了しています（募集人数: ${w}名、承認済み: ${Z}名）`},{status:400});let{data:x,error:y}=await d.from("bids").insert({project_id:t,contractor_id:c.id,bid_amount:Number(r),proposal:s||"",budget_approved:a,estimated_duration:null,start_date:null,status:"submitted"}).select().single();if(y){if(console.error("入札作成エラー:",y),y.message.includes("estimated_duration")||y.message.includes("start_date"))return n.Z.json({message:"データベーススキーマが古いです。bidsテーブルの制約を修正してください。",error:y.message,suggestion:"SupabaseのSQLエディタでfix-bids-table-constraints.sqlを実行してください。"},{status:500});return n.Z.json({message:"入札の作成に失敗しました: "+y.message},{status:400})}let{data:v,error:S}=await d.from("projects").select("title, org_id").eq("id",t).single();if(S)console.error("案件情報取得エラー:",S);else{let{data:e,error:s}=await d.from("organizations").select("name").eq("id",v.org_id).single();s&&console.error("組織情報取得エラー:",s);let a={...v,organizations:e},{data:o,error:i}=await d.from("memberships").select("user_id").eq("org_id",a.org_id).eq("role","OrgAdmin");if(i)console.error("発注者取得エラー:",{error:i,org_id:a.org_id});else{let e=o.map(e=>({user_id:e.user_id,type:"bid_received",title:"新しい入札が届きました",message:`案件「${a.title}」に新しい入札が届きました。入札金額: \xa5${Number(r).toLocaleString()}`,data:{project_id:t,bid_id:x.id,contractor_id:c.id,contractor_name:c.display_name,bid_amount:Number(r),project_title:a.title,org_name:a.organizations?.name}})),{data:s,error:i}=await d.from("notifications").insert(e).select();i&&console.error("通知作成エラー:",{error:i,notifications:e,projectInfo:a})}}return n.Z.json({message:"入札が正常に送信されました",bid:x},{status:201})}catch(e){return console.error("入札作成エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}async function l(e){try{let t=e.headers.get("authorization");if(!t)return n.Z.json({message:"認証が必要です"},{status:401});let r=t.replace("Bearer ",""),{data:{user:s},error:a}=await d.auth.getUser(r);if(a||!s)return console.error("認証エラー:",a),n.Z.json({message:"認証に失敗しました"},{status:401});let{data:o,error:i}=await d.from("users").select("id, email, display_name").eq("auth_user_id",s.id).single();if(i||!o)return n.Z.json({message:"ユーザープロフィールが見つかりません"},{status:403});let{data:u,error:l}=await d.from("bids").select(`
        id,
        project_id,
        bid_amount,
        proposal,
        estimated_duration,
        start_date,
        status,
        created_at,
        projects!bids_project_id_fkey (
          title,
          status,
          organizations!projects_org_id_fkey (
            name
          )
        )
      `).eq("contractor_id",o.id).order("created_at",{ascending:!1});if(l)return console.error("入札履歴の取得に失敗:",l),n.Z.json({message:"入札履歴の取得に失敗しました"},{status:400});let c=u?.map(e=>({id:e.id,project_id:e.project_id,bid_amount:e.bid_amount,proposal:e.proposal,estimated_duration:e.estimated_duration,start_date:e.start_date,status:e.status,created_at:e.created_at,project_title:e.projects?.title,project_status:e.projects?.status,org_name:e.projects?.organizations?.name}))||[];return n.Z.json({bids:c},{status:200})}catch(e){return console.error("入札履歴取得エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/bids/route",pathname:"/api/bids",filename:"route",bundlePath:"app/api/bids/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/bids/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:_,staticGenerationBailout:f}=c,j="/api/bids/route";function b(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(68690));module.exports=s})();