"use strict";(()=>{var e={};e.id=386,e.ids=[386],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},16309:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>I,originalPathname:()=>g,patchFetch:()=>j,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{POST:()=>u});var a=r(95419),i=r(69108),o=r(99678),n=r(78070);let c=(0,r(6517).ST)();async function u(e){try{let{subject:t,message:r,related_invoice_id:s,type:a}=await e.json(),i=e.headers.get("authorization");if(!i)return n.Z.json({message:"認証が必要です"},{status:401});let o=i.replace("Bearer ",""),{data:{user:u},error:d}=await c.auth.getUser(o);if(d||!u)return n.Z.json({message:"認証に失敗しました"},{status:401});let{data:p,error:l}=await c.from("users").select("id, display_name, email").eq("auth_user_id",u.id).single();if(l||!p)return n.Z.json({message:"ユーザー情報の取得に失敗しました"},{status:400});if(!t?.trim()||!r?.trim())return n.Z.json({message:"件名とメッセージは必須です"},{status:400});let{data:m,error:I}=await c.from("contacts").insert({user_id:p.id,subject:t.trim(),message:r.trim(),type:a||"general",related_invoice_id:s||null,status:"pending"}).select().single();if(I)return console.error("問い合わせ保存エラー:",I),n.Z.json({message:"問い合わせの送信に失敗しました"},{status:500});let{error:h}=await c.from("notifications").insert({user_id:"system",title:"新しい問い合わせが届きました",message:`${p.display_name}さんから問い合わせが届きました。件名: ${t}`,type:"contact_received",related_id:m.id});return h&&console.error("通知作成エラー:",h),n.Z.json({message:"問い合わせを送信しました",contact:{id:m.id,subject:m.subject,status:m.status}})}catch(e){return console.error("問い合わせ送信エラー:",e),n.Z.json({message:"サーバーエラーが発生しました"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/contact/route",pathname:"/api/contact",filename:"route",bundlePath:"app/api/contact/route"},resolvedPagePath:"/Users/sayuri/caddonworks/src/app/api/contact/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m,headerHooks:I,staticGenerationBailout:h}=d,g="/api/contact/route";function j(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},6517:(e,t,r)=>{r.d(t,{OQ:()=>a,ST:()=>i});var s=r(32409);let a=(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjY4MDMsImV4cCI6MjA3MzM0MjgwM30.0sbl6zWJ1XalGTFbsgeMpth6yH-oQA_P1eTCc8lKoAU"),i=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4bm96d3VhbWRkcWxjd3lzeGFnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzc2NjgwMywiZXhwIjoyMDczMzQyODAzfQ.w7KcFrtcTRhqoHwTSlgTc6NDNHIJH985rAgT9bD0ipE";return(0,s.eI)("https://rxnozwuamddqlcwysxag.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2409],()=>r(16309));module.exports=s})();